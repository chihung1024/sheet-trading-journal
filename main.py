"""\næŠ•è³‡çµ„åˆè¨ˆç®—å¼•æ“ - ä¸»ç¨‹å¼\nPortfolio Calculation Engine - Main Entry Point\n\nåŠŸèƒ½ï¼š\n1. è‡ªå‹•åˆ¤æ–·ç¾è‚¡äº¤æ˜“æ™‚æ®µï¼ˆå«å‡æœŸï¼‰\n2. ç›¤ä¸­æ¨¡å¼ï¼šä½µç™¼æŠ“å–å³æ™‚å ±åƒ¹\n3. æ”¶ç›¤æ¨¡å¼ï¼šä½¿ç”¨æ­·å² Adj Close\n4. å¤šç¶­åº¦æ•¸æ“šé©—è­‰èˆ‡é™ç´š\n5. ç³»çµ±å¥åº·åº¦ç›£æ§\n"""\nimport pandas as pd\nfrom datetime import timedelta\nfrom journal_engine.clients.api_client import CloudflareClient\nfrom journal_engine.clients.market_data import MarketDataClient\nfrom journal_engine.core.calculator import PortfolioCalculator\nfrom journal_engine.utils import is_us_market_open\nfrom journal_engine.monitor import HealthMonitor\n\n\ndef main():\n    print("=" * 60)\n    print("ğŸ“Š SaaS Trading Journal - æŠ•è³‡çµ„åˆè¨ˆç®—å¼•æ“")\n    print("=" * 60)\n    \n    # âˆšï¸ åˆå§‹åŒ–ç›£æ§å™¨\n    monitor = HealthMonitor()\n    \n    try:\n        # 1. åˆ¤æ–·é‹è¡Œæ¨¡å¼\n        intraday_mode = is_us_market_open()\n        mode_text = "ğŸ”´ ç›¤ä¸­å³æ™‚" if intraday_mode else "ğŸŸ¢ æ”¶ç›¤çµç®—"\n        print(f"\n[é‹è¡Œæ¨¡å¼] {mode_text}")\n        \n        # 2. åˆå§‹åŒ– Clients\n        api_client = CloudflareClient()\n        market_client = MarketDataClient()\n        \n        # 3. ç²å–äº¤æ˜“ç´€éŒ„\n        records = api_client.fetch_records()\n        if not records:\n            print("âš \ufe0f ç„¡äº¤æ˜“ç´€éŒ„")\n            monitor.record(success=True, mode='empty')\n            return\n        \n        # 4. è³‡æ–™å‰è™•ç†\n        df = pd.DataFrame(records)\n        \n        # æ˜ å°„æ¬„ä½åç¨±\n        df.rename(columns={\n            'txn_date': 'Date',\n            'symbol': 'Symbol',\n            'txn_type': 'Type',\n            'qty': 'Qty',\n            'price': 'Price',\n            'fee': 'Commission',\n            'tax': 'Tax',\n            'tag': 'Tag'\n        }, inplace=True)\n        \n        # å‹åˆ¥è½‰æ›\n        df['Date'] = pd.to_datetime(df['Date'])\n        df['Qty'] = pd.to_numeric(df['Qty'])\n        df['Price'] = pd.to_numeric(df['Price'])\n        df['Commission'] = pd.to_numeric(df['Commission'].fillna(0))\n        df['Tax'] = pd.to_numeric(df['Tax'].fillna(0))\n        \n        # ä¾æ—¥æœŸæ’åº (FIFO)\n        df = df.sort_values('Date')\n        \n        # 5. ä¸‹è¼‰æ­·å²æ•¸æ“š\n        if not df.empty:\n            start_date = df['Date'].min()\n            fetch_start_date = start_date - timedelta(days=100)\n            unique_tickers = df['Symbol'].dropna().unique().tolist()\n            \n            print(f"\n[æ•¸æ“šä¸‹è¼‰] æœ€æ—©äº¤æ˜“æ—¥: {start_date.date()}")\n            print(f"[æ•¸æ“šä¸‹è¼‰] æŠ“å–èµ·å§‹æ—¥: {fetch_start_date.date()} (å¾€å‰æ¨ 100 å¤©)")\n            print(f"[æ•¸æ“šä¸‹è¼‰] æŠ“å–æ¨™çš„: {unique_tickers}")\n            \n            market_client.download_data(unique_tickers, fetch_start_date)\n        \n        # 6. âˆšï¸ ç›¤ä¸­æ¨¡å¼ï¼šæŠ“å–å³æ™‚æ•¸æ“š\n        if intraday_mode:\n            print("\n" + "=" * 60)\n            print("ğŸ“¡ æŠ“å–å³æ™‚å ±åƒ¹...")\n            print("=" * 60)\n            \n            success = market_client.update_intraday_data(unique_tickers)\n            \n            if not success:\n                print("âš \ufe0f å³æ™‚æ•¸æ“šç²å–å¤±æ•—ï¼Œé™ç´šç‚ºæ”¶ç›¤æ¨¡å¼")\n                intraday_mode = False\n        \n        # 7. åŸ·è¡Œè¨ˆç®—\n        print("\n" + "=" * 60)\n        print("âš™\ufe0f åŸ·è¡ŒæŠ•è³‡çµ„åˆè¨ˆç®—...")\n        print("=" * 60)\n        \n        calculator = PortfolioCalculator(df, market_client)\n        snapshot = calculator.run(intraday_mode=intraday_mode)\n        \n        # 8. âˆšï¸ æª¢æŸ¥è¨ˆç®—çµæœ\n        if snapshot is None:\n            print("âŒ æœ¬æ¬¡è¨ˆç®—å¤±æ•—ï¼Œä¿ç•™ä¸Šæ¬¡æˆåŠŸçš„å¿«ç…§")\n            monitor.record(success=False, mode='calculation_failed',\n                         errors=['Snapshot validation failed'])\n            return\n        \n        # 9. ä¸Šå‚³çµæœ\n        print("\n[ä¸Šå‚³æ•¸æ“š] å¯«å…¥ Cloudflare D1...")\n        api_client.upload_portfolio(snapshot)\n        \n        # 10. âˆšï¸ è¨˜éŒ„æˆåŠŸ\n        monitor.record(success=True, mode=snapshot.get('data_mode', 'historical'))\n        \n        print("\n" + "=" * 60)\n        print("âœ… æ›´æ–°å®Œæˆï¼")\n        print(f"   æ•¸æ“šæ¨¡å¼: {snapshot.get('data_mode', 'historical')}")\n        print(f"   æ›´æ–°æ™‚é–“: {snapshot.get('updated_at', 'N/A')}")\n        print(f"   ç¸½è³‡ç”¢: ${snapshot.get('summary', {}).get('total_value', 0):,.0f}")\n        print("=" * 60)\n        \n        # 11. âˆšï¸ è¼¸å‡ºå¥åº·åº¦å ±å‘Š\n        health = monitor.get_health_score()\n        status_emoji = {\n            'excellent': 'ğŸŸ¢',\n            'healthy': 'ğŸŸ¡',\n            'degraded': 'ğŸŸ ',\n            'critical': 'ğŸ”´'\n        }.get(health['status'], 'âšª')\n        \n        print(f"\nğŸ“Š ç³»çµ±å¥åº·åº¦: {status_emoji} {health['score']}% ({health['status']})")\n        if 'total_runs' in health:\n            print(f"   24h åŸ·è¡Œ {health['total_runs']} æ¬¡ï¼Œå¤±æ•— {health.get('failures', 0)} æ¬¡")\n        \n    except Exception as e:\n        print(f"\nâŒ åŸ·è¡Œå¤±æ•—: {e}")\n        import traceback\n        traceback.print_exc()\n        \n        # âˆšï¸ è¨˜éŒ„å¤±æ•—\n        monitor.record(success=False, mode='exception', errors=[str(e)])\n        raise\n\n\nif __name__ == "__main__":\n    main()\n