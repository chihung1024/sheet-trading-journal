name: Update Portfolio Data

on:
  schedule:
    # 每天 UTC 0 點 (台灣時間早上 8 點) 自動執行
    - cron: '0 23 * * *'   # 07:00 CST - 晨間更新（雙市場收盤價）
    - cron: '15 1 * * 1-5' # 09:15 CST - 台股開盤後（僅交易日）
    - cron: '0 6 * * 1-5' # 14:00 CST - 台股收盤
    - cron: '0 15 * * 1-5' # 23:00 CST - 美股開盤後
  # ✅ 使用 workflow_dispatch 並定義 inputs
  workflow_dispatch:
    inputs:
      custom_benchmark:
        description: '自訂基準標的代碼 (例如: QQQ, TQQQ, 0050.TW)'
        required: false
        default: 'SPY'
        type: string
      target_user_id:
        description: '目標使用者 email (留空表示全部使用者)'
        required: false
        default: ''
        type: string

permissions:
  contents: write

jobs:
  run-and-upload:
    runs-on: ubuntu-latest
    
    steps:
    # 1. 下載程式碼
    - name: Checkout code
      uses: actions/checkout@v3

    # 2. 設定 Python 環境
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    # 3. 安裝套件 (修改後：加入 Cache 機制)
    - name: Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        # 使用 requirements.txt 的 hash 作為快取金鑰
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt

    # 4. [核心步驟] 執行 Python 腳本
    # ✅ 透過環境變數傳遞 inputs
    - name: Run calculation & Upload to API
      env:
        API_KEY: ${{ secrets.API_KEY }}
        CUSTOM_BENCHMARK: ${{ github.event.inputs.custom_benchmark || 'SPY' }}
        TARGET_USER_ID: ${{ github.event.inputs.target_user_id || '' }}
      run: python main.py
