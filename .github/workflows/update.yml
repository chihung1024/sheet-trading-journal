name: Portfolio Update Engine

on:
  # 允許透過 API 或手動觸發，並傳遞參數
  workflow_dispatch:
    inputs:
      benchmark:
        description: 'Benchmark ticker to compare (e.g., SPY, QQQ)'
        required: false
        default: 'SPY'
  # 定期自動更新 (每 4 小時一次)
  schedule:
    - cron: '0 */4 * * *'

# ✅ [核心優化]: 併發控制
# 如果同一使用者的計算任務正在運行，取消舊的，確保數據不會衝突
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  calculate-and-update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python 3.10
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip' # 自動緩存相依套件

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run Calculation Engine
        env:
          # ✅ [關鍵]: 將 Secrets 注入環境變數
          API_SECRET: ${{ secrets.API_SECRET }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # 傳遞前端選擇的 Benchmark
          USER_BENCHMARK: ${{ github.event.inputs.benchmark || 'SPY' }}
        run: |
          # 執行 Python 腳本並傳遞標記，告知是自動還是手動觸發
          python main.py --benchmark "${{ env.USER_BENCHMARK }}"

      - name: Verify Result
        if: success()
        run: echo "✅ Portfolio metrics calculated and pushed to Worker API successfully."

      - name: Handle Failure
        if: failure()
        run: |
          echo "❌ Calculation Engine failed. Please check the logs."
          # 未來可以在此處加入 Discord 或 Slack 的錯誤通知
