name: Update Portfolio Snapshots

on:
  # 支援定時自動更新 (例如每天凌晨)
  schedule:
    - cron: '0 21 * * *' # 每天 UTC 21:00 (台北時間凌晨 5:00)
    
  # 支援從 GitHub 介面手動觸發
  workflow_dispatch:
    inputs:
      target_user_id:
        description: '特定使用者 Email (留空則更新全部)'
        required: false
        default: ''
      benchmark:
        description: '基準指數 (如 SPY, QQQ)'
        required: false
        default: 'SPY'

  # 支援從 Cloudflare Worker 透過 API 觸發 (本次新增重點)
  repository_dispatch:
    types: [trigger-update]

jobs:
  update-snapshots:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run update script
        env:
          # 資料庫與 API 金鑰 (請確保已在 GitHub Repo Settings > Secrets 中設定)
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          D1_DATABASE_ID: ${{ secrets.D1_DATABASE_ID }}
          API_SECRET: ${{ secrets.API_SECRET }}
          WORKER_URL: ${{ secrets.WORKER_URL }}
          
          # 邏輯參數處理
          # 優先順序：API 觸發 (client_payload) > 手動觸發 (inputs) > 預設為空 (全部更新)
          TARGET_USER_ID: ${{ github.event.client_payload.target_user_id || github.event.inputs.target_user_id || '' }}
          BENCHMARK_SYMBOL: ${{ github.event.client_payload.custom_benchmark || github.event.inputs.benchmark || 'SPY' }}
          
        run: python main.py
