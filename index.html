<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„æŠ•è³‡çµ„åˆ</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/naive-ui"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #101014; color: #fff; margin: 0; font-family: -apple-system, BlinkMacSystemFont, sans-serif; padding-bottom: 50px; }
        .container { max-width: 1100px; margin: 0 auto; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px; }
        .card { background: #18181c; padding: 20px; border-radius: 8px; border: 1px solid #2d2d30; margin-bottom: 20px; }
        .card-label { color: #888; font-size: 0.9em; margin-bottom: 5px; }
        .card-value { font-size: 1.6em; font-weight: bold; }
        .card-sub { font-size: 0.9em; margin-top: 5px; color: #888; }
        
        .green { color: #63e2b7; }
        .red { color: #e88080; }
        .chart-container { height: 400px; width: 100%; }
        
        /* è¡¨æ ¼æ¨£å¼ */
        .table-container { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.95em; min-width: 600px; }
        th { text-align: left; color: #888; padding: 12px; border-bottom: 1px solid #333; font-weight: normal; }
        td { padding: 12px; border-bottom: 1px solid #2d2d30; }
        tr:hover { background-color: #1f1f23; }
        .tag { padding: 3px 8px; background: #2d2d30; border-radius: 4px; font-size: 0.85em; font-weight: bold; }
    </style>
</head>
<body>
    <div id="app" class="container">
        <div class="header">
            <h2>ğŸš€ æŠ•è³‡çµ„åˆçœ‹æ¿ (Net Invested)</h2>
            <span style="color: #666; font-size: 0.9em">æ›´æ–°: {{ updateTime }}</span>
        </div>

        <div class="grid">
            <div class="card">
                <div class="card-label">ç¸½æŒå€‰å¸‚å€¼ (Market Value)</div>
                <div class="card-value">${{ formatNumber(summary.total_value) }}</div>
            </div>
            <div class="card">
                <div class="card-label">æ·¨æŠ•å…¥æœ¬é‡‘ (Net Invested)</div>
                <div class="card-value">${{ formatNumber(summary.invested_capital) }}</div>
                <div class="card-sub">è²·å…¥ç¸½é¡ - è³£å‡ºå›æ”¶ç¸½é¡</div>
            </div>
            <div class="card">
                <div class="card-label">ç¸½å¸³é¢æç›Š (Unrealized + Realized)</div>
                <div class="card-value" :class="summary.total_pnl >= 0 ? 'red' : 'green'">
                    {{ summary.total_pnl >= 0 ? '+' : '' }}{{ formatNumber(summary.total_pnl) }}
                </div>
                <div class="card-sub" :class="summary.pnl_percent >= 0 ? 'red' : 'green'">
                    {{ summary.pnl_percent }}% (å ±é…¬ç‡)
                </div>
            </div>
            <div class="card">
                <div class="card-label">å·²å¯¦ç¾ç²åˆ© (Realized P&L)</div>
                <div class="card-value" :class="summary.realized_pnl >= 0 ? 'red' : 'green'">
                    {{ formatNumber(summary.realized_pnl) }}
                </div>
            </div>
        </div>

        <div class="card">
            <h3 style="margin-top:0; color:#eee">è³‡ç”¢ vs æœ¬é‡‘</h3>
            <div class="chart-container">
                <canvas id="mainChart"></canvas>
            </div>
        </div>

        <div class="card">
            <h3 style="margin-top:0; color:#eee">ç›®å‰æŒå€‰ (Holdings)</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ä»£ç¢¼</th>
                            <th>è‚¡æ•¸</th>
                            <th>å‡åƒ¹</th>
                            <th>ç¾åƒ¹</th>
                            <th>å¸‚å€¼</th>
                            <th>æœªå¯¦ç¾æç›Š</th>
                            <th>%</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="s in holdings" :key="s.symbol">
                            <td><span class="tag">{{ s.symbol }}</span></td>
                            <td>{{ s.qty }}</td>
                            <td>${{ s.avg_price }}</td>
                            <td>${{ s.current_price }}</td>
                            <td>${{ formatNumber(s.market_value) }}</td>
                            <td :class="s.pnl >= 0 ? 'red' : 'green'">
                                {{ s.pnl >= 0 ? '+' : '' }}{{ formatNumber(s.pnl) }}
                            </td>
                            <td :class="s.pnl >= 0 ? 'red' : 'green'">{{ s.pnl_percent }}%</td>
                        </tr>
                        <tr v-if="holdings.length === 0"><td colspan="7" style="text-align:center">ç„¡æŒå€‰</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card">
            <h3 style="margin-top:0; color:#eee">å·²å¹³å€‰ç´€éŒ„ (Closed)</h3>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>ä»£ç¢¼</th>
                            <th>è²·å…¥æ—¥æœŸ</th>
                            <th>è³£å‡ºæ—¥æœŸ</th>
                            <th>è²·å…¥åƒ¹</th>
                            <th>è³£å‡ºåƒ¹</th>
                            <th>ç²åˆ©é‡‘é¡</th>
                            <th>%</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="d in closedPositions" :key="d.symbol + d.close_date">
                            <td><span class="tag">{{ d.symbol }}</span></td>
                            <td style="color:#888">{{ d.open_date }}</td>
                            <td>{{ d.close_date }}</td>
                            <td>${{ d.buy_price }}</td>
                            <td>${{ d.sell_price }}</td>
                            <td :class="d.pnl >= 0 ? 'red' : 'green'">
                                {{ d.pnl >= 0 ? '+' : '' }}{{ formatNumber(d.pnl) }}
                            </td>
                            <td :class="d.pnl >= 0 ? 'red' : 'green'">{{ d.pnl_percent }}%</td>
                        </tr>
                        <tr v-if="closedPositions.length === 0"><td colspan="7" style="text-align:center">ç„¡ç´€éŒ„</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <script>
        const { createApp, ref, onMounted, nextTick } = Vue
        
        createApp({
            setup() {
                const summary = ref({})
                const updateTime = ref('-')
                const holdings = ref([])
                const closedPositions = ref([])
                let myChart = null

                const formatNumber = (num) => {
                    if (num === undefined || num === null) return '0.00'
                    return Number(num).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })
                }

                const renderChart = (history) => {
                    const ctx = document.getElementById('mainChart').getContext('2d');
                    if (myChart) myChart.destroy();

                    myChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: history.map(d => d.date),
                            datasets: [
                                {
                                    label: 'ç¸½æŒå€‰å¸‚å€¼ (Market Value)',
                                    data: history.map(d => d.total_value),
                                    borderColor: '#63e2b7', 
                                    backgroundColor: 'rgba(99, 226, 183, 0.1)',
                                    borderWidth: 2,
                                    fill: true,
                                    tension: 0.4
                                },
                                {
                                    label: 'æ·¨æŠ•å…¥æœ¬é‡‘ (Net Invested)',
                                    data: history.map(d => d.invested),
                                    borderColor: '#666',
                                    borderWidth: 2,
                                    borderDash: [5, 5],
                                    fill: false,
                                    tension: 0
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: { mode: 'index', intersect: false },
                            plugins: {
                                legend: { labels: { color: '#ccc' } },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            return context.dataset.label + ': $' + context.parsed.y.toLocaleString();
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: { grid: { color: '#333' }, ticks: { color: '#888' } },
                                y: { grid: { color: '#333' }, ticks: { color: '#888' } }
                            }
                        }
                    });
                }

                const fetchData = async () => {
                    try {
                        const res = await fetch('data.json?t=' + new Date().getTime())
                        const data = await res.json()
                        
                        summary.value = data.summary
                        updateTime.value = data.updated_at
                        holdings.value = data.holdings
                        closedPositions.value = data.closed_positions

                        nextTick(() => {
                            if (data.history && data.history.length > 0) {
                                renderChart(data.history)
                            }
                        })
                    } catch (e) {
                        console.error("Loading...", e)
                    }
                }

                onMounted(fetchData)
                return { summary, updateTime, holdings, closedPositions, formatNumber }
            }
        }).mount('#app')
    </script>
</body>
</html>
