<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portfolio Journal</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/naive-ui"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #101014; color: #fff; margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        .container { max-width: 1000px; margin: 0 auto; padding: 20px; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .card { background: #18181c; padding: 20px; border-radius: 8px; border: 1px solid #2d2d30; }
        .card-label { color: #888; font-size: 0.9em; margin-bottom: 5px; }
        .card-value { font-size: 1.8em; font-weight: bold; }
        .green { color: #63e2b7; }
        .red { color: #e88080; }
        .chart-container { background: #18181c; padding: 20px; border-radius: 8px; border: 1px solid #2d2d30; margin-bottom: 30px; height: 400px; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; color: #888; padding: 10px; border-bottom: 1px solid #333; font-weight: normal; }
        td { padding: 15px 10px; border-bottom: 1px solid #2d2d30; }
        .tag { padding: 4px 8px; background: #2d2d30; border-radius: 4px; font-size: 0.85em; }
        a { color: #63e2b7; text-decoration: none; }
    </style>
</head>
<body>
    <div id="app" class="container">
        <div class="header">
            <h1>Portfolio Journal</h1>
            <span style="color: #666; font-size: 0.9em">更新於: {{ updateTime }}</span>
        </div>

        <div class="grid">
            <div class="card">
                <div class="card-label">總資產 (Net Worth)</div>
                <div class="card-value">${{ formatNumber(totalValue) }}</div>
            </div>
            <div class="card">
                <div class="card-label">總投入 (Invested)</div>
                <div class="card-value">${{ formatNumber(totalCost) }}</div>
            </div>
            <div class="card">
                <div class="card-label">未實現損益 (Unrealized P&L)</div>
                <div class="card-value" :class="totalPnl >= 0 ? 'red' : 'green'">
                    {{ totalPnl >= 0 ? '+' : '' }}{{ formatNumber(totalPnl) }}
                </div>
            </div>
        </div>

        <div class="chart-container">
            <canvas id="assetChart"></canvas>
        </div>

        <div class="card">
            <h3 style="margin-top: 0; margin-bottom: 20px;">持倉明細 (Holdings)</h3>
            <div style="overflow-x: auto;">
                <table>
                    <thead>
                        <tr>
                            <th>代碼</th>
                            <th>數量</th>
                            <th>均價</th>
                            <th>現價</th>
                            <th>市值</th>
                            <th>損益</th>
                            <th>%</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="stock in holdings" :key="stock.symbol">
                            <td><span class="tag">{{ stock.symbol }}</span></td>
                            <td>{{ stock.qty }}</td>
                            <td>${{ stock.avg_price }}</td>
                            <td>${{ stock.current_price }}</td>
                            <td>${{ formatNumber(stock.market_value) }}</td>
                            <td :class="stock.pnl >= 0 ? 'red' : 'green'">
                                {{ stock.pnl >= 0 ? '+' : '' }}{{ formatNumber(stock.pnl) }}
                            </td>
                            <td :class="stock.pnl >= 0 ? 'red' : 'green'">
                                {{ stock.pnl_percent }}%
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <div style="text-align: center; margin-top: 40px; color: #666;">
            <a href="https://docs.google.com/spreadsheets" target="_blank">
                編輯 Google Sheet
            </a>
        </div>
    </div>

    <script>
        const { createApp, ref, onMounted, nextTick } = Vue
        
        createApp({
            setup() {
                const totalValue = ref(0)
                const totalCost = ref(0)
                const totalPnl = ref(0)
                const updateTime = ref('-')
                const holdings = ref([])
                
                const formatNumber = (num) => {
                    return Number(num).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })
                }

                const renderChart = (historyData) => {
                    const ctx = document.getElementById('assetChart').getContext('2d');
                    const dates = historyData.map(d => d.date);
                    const values = historyData.map(d => d.value);
                    const invested = historyData.map(d => d.invested);

                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: dates,
                            datasets: [
                                {
                                    label: '總資產',
                                    data: values,
                                    borderColor: '#63e2b7', // 綠色 (Naive UI 風格)
                                    backgroundColor: 'rgba(99, 226, 183, 0.1)',
                                    borderWidth: 2,
                                    fill: true,
                                    tension: 0.4
                                },
                                {
                                    label: '投入本金',
                                    data: invested,
                                    borderColor: '#666',
                                    borderWidth: 1,
                                    borderDash: [5, 5],
                                    fill: false,
                                    pointRadius: 0
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: { mode: 'index', intersect: false },
                            plugins: {
                                legend: { labels: { color: '#ccc' } }
                            },
                            scales: {
                                x: { 
                                    grid: { color: '#333' },
                                    ticks: { color: '#888' }
                                },
                                y: { 
                                    grid: { color: '#333' },
                                    ticks: { color: '#888' }
                                }
                            }
                        }
                    });
                }

                const fetchData = async () => {
                    try {
                        // 為了避免快取，加個時間戳
                        const res = await fetch('data.json?t=' + new Date().getTime())
                        const data = await res.json()
                        
                        totalValue.value = data.total_value
                        totalCost.value = data.total_cost
                        totalPnl.value = data.total_pnl
                        updateTime.value = data.updated_at
                        holdings.value = data.holdings

                        // 確保 DOM 更新後再畫圖
                        nextTick(() => {
                            if (data.history && data.history.length > 0) {
                                renderChart(data.history)
                            }
                        })
                    } catch (e) {
                        console.error("等待資料生成中...", e)
                    }
                }

                onMounted(fetchData)
                return { totalValue, totalCost, totalPnl, updateTime, holdings, formatNumber }
            }
        }).mount('#app')
    </script>
</body>
</html>
