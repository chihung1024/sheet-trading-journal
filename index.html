<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SaaS äº¤æ˜“ç®¡ç†ç³»çµ± (Pro)</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        /* --- æ ¸å¿ƒæ¨£å¼ --- */
        :root { --bg: #101014; --card-bg: #18181c; --border: #2d2d30; --primary: #40a9ff; --text: #e0e0e0; --green: #4caf50; --red: #ff5252; --yellow: #ffc107; }
        body { background-color: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; margin: 0; padding: 20px; padding-bottom: 80px;}
        .container { max-width: 1200px; margin: 0 auto; }
        
        /* ç™»å…¥é®ç½© */
        .login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; justify-content: center; align-items: center; z-index: 1000; flex-direction: column; backdrop-filter: blur(5px); }
        .login-box { background: var(--card-bg); padding: 40px; border-radius: 16px; border: 1px solid var(--border); text-align: center; }

        /* ç‰ˆé¢å…ƒä»¶ */
        .header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 15px; }
        .header h2 { margin: 0; font-size: 1.5rem; display: flex; align-items: center; gap: 10px; }
        .badge { font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; background: #333; color: #aaa; margin-left: 5px; vertical-align: middle; }

        /* æŒ‰éˆ•ç¾¤çµ„ */
        .btn { padding: 8px 16px; border-radius: 6px; cursor: pointer; border: none; font-weight: 600; transition: 0.2s; display: inline-flex; align-items: center; gap: 6px; font-size: 0.9rem; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-success { background: var(--green); color: white; }
        .btn-danger { background: rgba(255, 82, 82, 0.1); color: var(--red); border: 1px solid var(--red); }
        .btn-sm { padding: 4px 10px; font-size: 0.8rem; }
        .btn-group { display: flex; gap: 10px; }

        /* é ç±¤å°èˆª */
        .tabs { display: flex; gap: 20px; margin-bottom: 20px; border-bottom: 1px solid #333; }
        .tab { padding: 10px 0; cursor: pointer; color: #888; position: relative; transition: 0.3s; font-size: 1.05rem; }
        .tab.active { color: var(--primary); font-weight: bold; }
        .tab.active::after { content: ''; position: absolute; bottom: -1px; left: 0; width: 100%; height: 2px; background: var(--primary); }

        /* æ•¸æ“šå¡ç‰‡ */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-item { background: #222; padding: 15px 20px; border-radius: 12px; border: 1px solid #333; position: relative; overflow: hidden; }
        .stat-item::after { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: var(--primary); }
        .stat-item.profit::after { background: var(--red); }
        .stat-item.loss::after { background: var(--green); }
        .stat-val { font-size: 1.5rem; font-weight: 700; margin-top: 5px; }
        .stat-sub { font-size: 0.85rem; color: #888; margin-top: 5px; }
        .red { color: var(--red); } .green { color: var(--green); }

        /* åœ–è¡¨å€å¡Š */
        .chart-container { background: var(--card-bg); padding: 20px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 20px; height: 350px; position: relative; }
        .chart-controls { display: flex; justify-content: space-between; margin-bottom: 15px; }
        .chart-toggles button { background: #333; border: none; color: #aaa; padding: 4px 12px; border-radius: 4px; cursor: pointer; margin-right: 5px; }
        .chart-toggles button.active { background: var(--primary); color: white; }

        /* è¡¨æ ¼èˆ‡è¡¨å–® */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.95rem; }
        th { text-align: left; color: #888; border-bottom: 1px solid var(--border); padding: 12px; }
        td { padding: 12px; border-bottom: 1px solid #222; color: #ddd; }
        .editor-form { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 10px; align-items: end; background: #1f1f23; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #333; }
        input, select { background: #2d2d30; border: 1px solid #444; color: white; padding: 8px; border-radius: 4px; width: 100%; box-sizing: border-box; }

        .spinner { width: 16px; height: 16px; border: 2px solid #ffffff3d; border-top: 2px solid #fff; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="app" class="container">
        <div v-if="!userToken" class="login-overlay">
            <div class="login-box">
                <h2>SaaS äº¤æ˜“ç®¡ç†ç³»çµ± (Pro)</h2>
                <p style="color:#888; margin-bottom:20px;">æ•´åˆ D1 è³‡æ–™åº«èˆ‡ GitHub è‡ªå‹•åŒ–é‹ç®—</p>
                <div id="g_id_onload" :data-client_id="googleClientId" data-callback="handleCredentialResponse" data-auto_select="false"></div>
                <div class="g_id_signin" data-type="standard" data-shape="pill" data-size="large" data-theme="filled_black"></div>
            </div>
        </div>

        <div v-else>
            <div class="header">
                <div>
                    <h2>æŠ•è³‡çµ„åˆçœ‹æ¿ <span class="badge">PRO</span></h2>
                    <div style="color:#888; font-size:0.9rem; margin-top:5px;">
                        ğŸ‘¤ {{ userName }} | è³‡æ–™æ›´æ–°æ–¼: {{ lastUpdateTime || 'è®€å–ä¸­...' }}
                    </div>
                </div>
                <div class="btn-group">
                    <button class="btn btn-primary" @click="triggerGitHubUpdate" :disabled="isUpdating || calculating">
                        <span v-if="!isUpdating">ğŸš€ å¼·åˆ¶æ›´æ–°å ±åƒ¹</span>
                        <span v-else class="spinner"></span>
                    </button>
                    <button class="btn btn-success" @click="refreshData" :disabled="calculating">
                        ğŸ”„ {{ calculating ? 'è¼‰å…¥ä¸­' : 'é‡æ–°è®€å–' }}
                    </button>
                    <button class="btn btn-danger" @click="logout">ç™»å‡º</button>
                </div>
            </div>

            <div class="tabs">
                <div class="tab" :class="{active: currentTab==='summary'}" @click="currentTab='summary'">ğŸ“Š ç¸½è¦½åˆ†æ</div>
                <div class="tab" :class="{active: currentTab==='holdings'}" @click="currentTab='holdings'">ğŸ’¼ æŒå€‰æç›Š</div>
                <div class="tab" :class="{active: currentTab==='ledger'}" @click="currentTab='ledger'">ğŸ“ äº¤æ˜“ç´€éŒ„ (ç·¨è¼¯)</div>
            </div>

            <div v-show="currentTab === 'summary'">
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-sub">ç¸½å¸‚å€¼ (Market Value)</div>
                        <div class="stat-val" style="color:var(--primary)">${{ formatNumber(marketStats.total_value) }}</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-sub">æŠ•å…¥æˆæœ¬ (Invested)</div>
                        <div class="stat-val">${{ formatNumber(marketStats.invested_capital) }}</div>
                    </div>
                    <div class="stat-item" :class="unrealizedPnL >= 0 ? 'profit' : 'loss'">
                        <div class="stat-sub">æœªå¯¦ç¾æç›Š (Unrealized)</div>
                        <div class="stat-val" :class="unrealizedPnL >= 0 ? 'red' : 'green'">
                            {{ unrealizedPnL >= 0 ? '+' : '' }}{{ formatNumber(unrealizedPnL) }}
                        </div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-sub">TWR å ±é…¬ç‡</div>
                        <div class="stat-val" :class="marketStats.twr >= 0 ? 'red' : 'green'">
                            {{ marketStats.twr }}%
                        </div>
                        <div class="stat-sub">Benchmark: {{ marketStats.benchmark_twr }}%</div>
                    </div>
                </div>

                <div style="display:flex; gap:20px; flex-wrap:wrap;">
                    <div class="chart-container" style="flex:2; min-width:400px;">
                        <div class="chart-controls">
                            <span style="font-weight:bold; color:#888;">è³‡ç”¢èµ°å‹¢</span>
                            <div class="chart-toggles">
                                <button :class="{active: chartType==='value'}" @click="switchChartType('value')">å¸‚å€¼</button>
                                <button :class="{active: chartType==='twr'}" @click="switchChartType('twr')">å ±é…¬ç‡</button>
                            </div>
                        </div>
                        <canvas id="mainChart"></canvas>
                    </div>

                    <div class="chart-container" style="flex:1; min-width:300px;">
                        <div class="chart-controls">
                            <span style="font-weight:bold; color:#888;">è³‡ç”¢é…ç½®</span>
                            <div class="chart-toggles">
                                <button :class="{active: pieType==='tags'}" @click="switchPieType('tags')">æ¨™ç±¤</button>
                                <button :class="{active: pieType==='currency'}" @click="switchPieType('currency')">å¹£åˆ¥</button>
                            </div>
                        </div>
                        <div style="height:280px; display:flex; justify-content:center;">
                            <canvas id="pieChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div v-show="currentTab === 'holdings'">
                <div class="chart-container" style="height:auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>ä»£ç¢¼</th>
                                <th>æ¨™ç±¤</th>
                                <th>è‚¡æ•¸</th>
                                <th>å¸‚å€¼ (TWD)</th>
                                <th>æç›Š (TWD)</th>
                                <th>å ±é…¬ç‡</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="h in marketHoldings" :key="h.symbol">
                                <td style="font-weight:bold; color:white;">
                                    {{ h.symbol }} <span class="badge">{{ h.currency }}</span>
                                </td>
                                <td><span class="badge">{{ h.tag }}</span></td>
                                <td>{{ formatNumber(h.qty) }}</td>
                                <td style="font-weight:bold;">{{ formatNumber(h.market_value_twd) }}</td>
                                <td :class="h.pnl_twd >= 0 ? 'red' : 'green'">
                                    {{ h.pnl_twd >= 0 ? '+' : '' }}{{ formatNumber(h.pnl_twd) }}
                                </td>
                                <td :class="h.pnl_percent >= 0 ? 'red' : 'green'">
                                    {{ h.pnl_percent }}%
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div v-show="currentTab === 'ledger'">
                <div class="editor-form">
                    <div><label>æ—¥æœŸ</label><input type="date" v-model="form.txn_date"></div>
                    <div><label>ä»£ç¢¼</label><input type="text" v-model="form.symbol" placeholder="AAPL" @input="form.symbol = form.symbol.toUpperCase()"></div>
                    <div>
                        <label>é¡åˆ¥</label>
                        <select v-model="form.txn_type">
                            <option value="BUY">è²·å…¥</option>
                            <option value="SELL">è³£å‡º</option>
                            <option value="DIV">é…æ¯</option>
                        </select>
                    </div>
                    <div><label>è‚¡æ•¸</label><input type="number" v-model="form.qty" step="0.01"></div>
                    <div><label>åƒ¹æ ¼</label><input type="number" v-model="form.price" step="0.01"></div>
                    <div><label>æ¨™ç±¤</label><input type="text" v-model="form.tag" placeholder="å¦‚: é•·ç·š"></div>
                    <div>
                        <button class="btn btn-primary" style="width:100%" @click="submitRecord" :disabled="loading">
                            {{ isEditing ? 'ä¿å­˜ä¿®æ”¹' : 'æ–°å¢äº¤æ˜“' }}
                        </button>
                    </div>
                </div>

                <div class="chart-container" style="height:auto;">
                    <div style="margin-bottom:10px; display:flex; justify-content:space-between;">
                        <span>å…± {{ records.length }} ç­†äº¤æ˜“</span>
                        <button v-if="isEditing" class="btn btn-sm btn-danger" @click="resetForm">å–æ¶ˆç·¨è¼¯</button>
                    </div>
                    <table>
                        <thead><tr><th>æ—¥æœŸ</th><th>ä»£ç¢¼</th><th>å‹•ä½œ</th><th>åƒ¹æ ¼</th><th>è‚¡æ•¸</th><th>æ“ä½œ</th></tr></thead>
                        <tbody>
                            <tr v-for="tx in records" :key="tx.id">
                                <td style="color:#888;">{{ tx.txn_date }}</td>
                                <td style="font-weight:bold;">{{ tx.symbol }}</td>
                                <td>
                                    <span :style="{color: tx.txn_type==='BUY'?'#69f0ae':(tx.txn_type==='SELL'?'#ff5252':'#ffd700')}">
                                        {{ tx.txn_type }}
                                    </span>
                                </td>
                                <td>{{ tx.price }}</td>
                                <td>{{ tx.qty }}</td>
                                <td>
                                    <button class="btn btn-sm btn-primary" @click="editRecord(tx)">âœ</button>
                                    <button class="btn btn-sm btn-danger" @click="deleteRecord(tx.id)" style="margin-left:5px;">Ã—</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, nextTick, watch } = Vue;
        
        // è¨­å®š
        const DB_API_URL = "https://journal-backend.chired.workers.dev";
        const CLIENT_ID = "951186116587-0ehsmkvlu3uivduc7kjn1jpp9ga7810i.apps.googleusercontent.com";

        createApp({
            setup() {
                const userToken = ref(localStorage.getItem('token') || '');
                const userName = ref(localStorage.getItem('name') || '');
                
                // ç‹€æ…‹
                const currentTab = ref('summary');
                const marketStats = ref({});
                const marketHoldings = ref([]);
                const historyData = ref([]);
                const allocation = ref({});
                const records = ref([]); // D1 åŸå§‹ç´€éŒ„
                const lastUpdateTime = ref('');
                
                // UI ç‹€æ…‹
                const calculating = ref(false);
                const isUpdating = ref(false);
                const isEditing = ref(false);
                const loading = ref(false);
                const form = ref(getEmptyForm());

                // åœ–è¡¨ç‹€æ…‹
                const chartType = ref('value'); // 'value' or 'twr'
                const pieType = ref('tags');    // 'tags' or 'currency'
                let myChart = null;
                let myPieChart = null;

                // --- æ•¸æ“šç²å– ---
                const fetchData = async () => {
                    calculating.value = true;
                    try {
                        // 1. è®€å–éœæ…‹åˆ†ææ•¸æ“š (data.json)
                        const res = await fetch(`data.json?t=${new Date().getTime()}`);
                        if(res.ok) {
                            const json = await res.json();
                            marketStats.value = json.summary || {};
                            marketHoldings.value = json.holdings || [];
                            historyData.value = json.history || [];
                            allocation.value = json.allocation || { tags: {}, currency: {} };
                            lastUpdateTime.value = json.updated_at || '';
                            
                            // æ›´æ–°åœ–è¡¨
                            nextTick(() => {
                                if(currentTab.value === 'summary') {
                                    drawChart();
                                    drawPieChart();
                                }
                            });
                        }
                    } catch(e) { console.error("Load data error", e); }
                    calculating.value = false;
                };

                const fetchRecords = async () => {
                    if (!userToken.value) return;
                    try {
                        const res = await fetch(`${DB_API_URL}/api/records`, {
                            headers: { "Authorization": `Bearer ${userToken.value}` }
                        });
                        const json = await res.json();
                        if (json.success) records.value = json.data;
                    } catch(e) { console.error("Fetch records error", e); }
                };

                // --- åœ–è¡¨é‚è¼¯ ---
                const drawChart = () => {
                    const ctx = document.getElementById('mainChart');
                    if (!ctx) return;
                    if (myChart) myChart.destroy();

                    const labels = historyData.value.map(d => d.date);
                    let datasets = [];

                    if (chartType.value === 'value') {
                        datasets = [
                            { label: 'ç¸½å¸‚å€¼', data: historyData.value.map(d => d.total_value), borderColor: '#40a9ff', borderWidth: 2, tension: 0.1 },
                            { label: 'æŠ•å…¥æˆæœ¬', data: historyData.value.map(d => d.invested), borderColor: '#666', borderDash: [5, 5], borderWidth: 1 }
                        ];
                    } else {
                        datasets = [
                            { label: 'ç´¯è¨ˆå ±é…¬ç‡ %', data: historyData.value.map(d => d.twr), borderColor: '#ffc107', borderWidth: 2 },
                            { label: 'Benchmark (SPY) %', data: historyData.value.map(d => d.benchmark_twr), borderColor: '#666', borderWidth: 1 }
                        ];
                    }

                    myChart = new Chart(ctx, {
                        type: 'line',
                        data: { labels, datasets },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: { mode: 'index', intersect: false },
                            plugins: { legend: { labels: { color: '#ccc' } } },
                            scales: {
                                x: { ticks: { color: '#666', maxTicksLimit: 8 }, grid: { color: '#2d2d30' } },
                                y: { ticks: { color: '#666' }, grid: { color: '#2d2d30' } }
                            }
                        }
                    });
                };

                const drawPieChart = () => {
                    const ctx = document.getElementById('pieChart');
                    if (!ctx) return;
                    if (myPieChart) myPieChart.destroy();

                    const dataSrc = allocation.value[pieType.value] || {};
                    const labels = Object.keys(dataSrc);
                    const data = Object.values(dataSrc);
                    const colors = ['#40a9ff', '#ffc107', '#4caf50', '#ff5252', '#9c27b0', '#00bcd4', '#795548'];

                    myPieChart = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: labels,
                            datasets: [{ data: data, backgroundColor: colors, borderWidth: 0 }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { position: 'right', labels: { color: '#ccc' } } }
                        }
                    });
                };

                // --- ç›£è½ Tab åˆ‡æ›é‡ç¹ªåœ–è¡¨ ---
                watch(currentTab, (newTab) => {
                    if (newTab === 'summary') {
                        nextTick(() => { drawChart(); drawPieChart(); });
                    }
                });

                // --- äº¤æ˜“æ“ä½œ (D1) ---
                const submitRecord = async () => {
                    loading.value = true;
                    const method = isEditing.value ? "PUT" : "POST";
                    try {
                        const res = await fetch(`${DB_API_URL}/api/records`, {
                            method,
                            headers: { "Content-Type": "application/json", "Authorization": `Bearer ${userToken.value}` },
                            body: JSON.stringify(form.value)
                        });
                        if(res.ok) { resetForm(); await fetchRecords(); } 
                        else alert("å„²å­˜å¤±æ•—");
                    } catch(e) { alert("é€£ç·šéŒ¯èª¤"); }
                    loading.value = false;
                };

                const deleteRecord = async (id) => {
                    if(!confirm("ç¢ºå®šåˆªé™¤?")) return;
                    await fetch(`${DB_API_URL}/api/records`, {
                        method: "DELETE",
                        headers: { "Content-Type": "application/json", "Authorization": `Bearer ${userToken.value}` },
                        body: JSON.stringify({ id })
                    });
                    fetchRecords();
                };

                const triggerGitHubUpdate = async () => {
                    if(!confirm("ç¢ºå®šè¦å¼·åˆ¶æ›´æ–°å ±åƒ¹å—ï¼Ÿ")) return;
                    isUpdating.value = true;
                    try {
                        const res = await fetch(`${DB_API_URL}/api/trigger-update`, {
                            method: 'POST',
                            headers: { "Content-Type": "application/json", "Authorization": `Bearer ${userToken.value}` }
                        });
                        const json = await res.json();
                        if (json.success) alert("âœ… å·²è§¸ç™¼ï¼GitHub æ­£åœ¨é‹ç®—ï¼Œè«‹ç´„ 2 åˆ†é˜å¾Œé‡æ–°è®€å–ã€‚");
                        else alert("âŒ å¤±æ•—ï¼š" + json.error);
                    } catch (e) { alert("é€£ç·šéŒ¯èª¤"); }
                    isUpdating.value = false;
                };

                // --- è¼”åŠ©å‡½å¼ ---
                function getEmptyForm() {
                    return { id: null, txn_date: new Date().toISOString().split('T')[0], symbol: '', txn_type: 'BUY', qty: '', price: '', fee: 0, tag: 'Stock' };
                }
                const editRecord = (tx) => { isEditing.value = true; form.value = { ...tx }; };
                const resetForm = () => { isEditing.value = false; form.value = getEmptyForm(); };
                const formatNumber = (num) => num ? Number(num).toLocaleString(undefined, { maximumFractionDigits: 0 }) : '0';
                
                const switchChartType = (t) => { chartType.value = t; drawChart(); };
                const switchPieType = (t) => { pieType.value = t; drawPieChart(); };

                const unrealizedPnL = computed(() => (marketStats.value.total_value || 0) - (marketStats.value.invested_capital || 0));

                // ç™»å…¥è™•ç†
                const logout = () => { localStorage.clear(); userToken.value = ''; records.value = []; };
                window.handleCredentialResponse = async (response) => {
                    try {
                        const res = await fetch(`${DB_API_URL}/auth/google`, {
                            method: "POST",
                            body: JSON.stringify({ id_token: response.credential })
                        });
                        const data = await res.json();
                        if (data.success) {
                            userToken.value = data.token;
                            userName.value = data.user;
                            localStorage.setItem('token', data.token);
                            localStorage.setItem('name', data.user);
                            fetchRecords();
                        }
                    } catch(e) { alert("ç™»å…¥å¤±æ•—"); }
                };

                onMounted(() => {
                    fetchData(); // è¼‰å…¥å…¬é–‹å ±åƒ¹èˆ‡åœ–è¡¨
                    if (userToken.value) fetchRecords(); // è¼‰å…¥ç§æœ‰ç·¨è¼¯ç´€éŒ„
                });

                return {
                    userToken, userName, googleClientId: CLIENT_ID, logout,
                    currentTab, marketStats, marketHoldings, records, lastUpdateTime,
                    calculating, isUpdating, isEditing, loading, form,
                    chartType, pieType, switchChartType, switchPieType,
                    submitRecord, deleteRecord, editRecord, resetForm, triggerGitHubUpdate, refreshData,
                    unrealizedPnL, formatNumber
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
