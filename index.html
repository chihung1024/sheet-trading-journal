<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SaaS 交易管理系統 (AI版)</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <style>
        /* --- 0.01 版基礎主題變數 --- */
        :root { 
            --bg: #101014; 
            --card-bg: #18181c; 
            --border: #2d2d30; 
            --primary: #40a9ff; 
            --text: #e0e0e0; 
            --text-muted: #888;
            --green: #4caf50; 
            --red: #ff5252; 
            --yellow: #ffc107; 
        }
        
        body { background-color: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; padding-bottom: 60px; }
        
        /* 通用元件樣式 */
        .card { background: var(--card-bg); padding: 20px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 20px; }
        .flex-row { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        .btn { padding: 8px 16px; border-radius: 6px; border: none; cursor: pointer; font-size: 0.9rem; transition: all 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { opacity: 0.9; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
        .btn-outline:hover, .btn-outline.active { background: var(--border); border-color: var(--text-muted); }
        .text-green { color: var(--green); }
        .text-red { color: var(--red); }
        
        /* --- 登入遮罩 (0.01 功能) --- */
        .login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; justify-content: center; align-items: center; z-index: 1000; flex-direction: column; gap: 20px; }
        
        /* --- 圖表區塊樣式 (移植自 0.00 並優化) --- */
        .chart-section { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 20px; }
        @media (max-width: 768px) { .chart-section { grid-template-columns: 1fr; } }
        
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .chart-controls { display: flex; gap: 5px; background: #222; padding: 3px; border-radius: 8px; }
        .chart-controls button { background: transparent; border: none; color: #888; padding: 4px 10px; font-size: 0.8rem; cursor: pointer; border-radius: 5px; }
        .chart-controls button.active { background: #333; color: #fff; font-weight: bold; }
        
        .chart-container { position: relative; height: 300px; width: 100%; }
        
        /* --- 數據表格樣式 --- */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { text-align: right; padding: 12px; border-bottom: 1px solid var(--border); }
        th:first-child, td:first-child { text-align: left; }
        th { color: var(--text-muted); font-weight: normal; font-size: 0.9rem; }
        
        /* 標籤 */
        .tag { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; background: #333; color: #ccc; }
        
        /* Loading */
        .loading { text-align: center; padding: 40px; color: var(--text-muted); }

        /* 頂部 Header */
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 15px; }
        .user-info { display: flex; align-items: center; gap: 10px; font-size: 0.9rem; }
        .avatar { width: 32px; height: 32px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; }
    </style>
</head>
<body>
    <div id="app" class="container">
        <div v-if="!userToken" class="login-overlay">
            <h2 style="color:white">資產管理系統 Login</h2>
            <div id="g_id_onload" :data-client_id="googleClientId" data-callback="handleCredentialResponse" data-auto_select="true"></div>
            <div class="g_id_signin" data-type="standard"></div>
        </div>

        <div v-else>
            <div class="header-bar">
                <div>
                    <h2 style="margin:0">Dashboard <span style="font-size:0.8rem; color:#666">v0.01 Online</span></h2>
                    <small style="color:var(--text-muted)">最後更新: {{ lastUpdateTime }}</small>
                </div>
                <div class="user-info">
                    <div class="avatar">{{ userName.charAt(0).toUpperCase() }}</div>
                    <span>{{ userName }}</span>
                    <button @click="logout" class="btn btn-outline" style="padding: 4px 10px; font-size:0.8rem">登出</button>
                    <button @click="triggerGitHubUpdate" class="btn btn-primary" :disabled="isUpdating">
                        {{ isUpdating ? '更新中...' : '刷新報價' }}
                    </button>
                </div>
            </div>

            <div class="flex-row" style="margin-bottom: 20px;">
                <div class="card" style="flex:1; text-align:center">
                    <div style="font-size:0.9rem; color:#888">總淨值 (TWD)</div>
                    <div style="font-size:1.8rem; font-weight:bold; margin: 10px 0;">{{ formatNumber(localStats.total_value) }}</div>
                    <div :class="unrealizedPnL >= 0 ? 'text-green' : 'text-red'">
                        {{ unrealizedPnL >= 0 ? '+' : '' }}{{ formatNumber(unrealizedPnL) }}
                    </div>
                </div>
                <div class="card" style="flex:1; text-align:center">
                    <div style="font-size:0.9rem; color:#888">投入成本</div>
                    <div style="font-size:1.5rem; margin: 10px 0;">{{ formatNumber(localStats.invested_capital) }}</div>
                </div>
                <div class="card" style="flex:1; text-align:center">
                    <div style="font-size:0.9rem; color:#888">TWR 報酬率</div>
                    <div style="font-size:1.5rem; margin: 10px 0;" :class="localStats.twr >= 100 ? 'text-green' : 'text-red'">
                        {{ localStats.twr }}%
                    </div>
                </div>
            </div>

            <div class="chart-section" v-show="!calculating">
                <div class="card">
                    <div class="chart-header">
                        <div class="chart-controls">
                            <button @click="switchChartType('value')" :class="{active: chartType==='value'}">淨值</button>
                            <button @click="switchChartType('twr')" :class="{active: chartType==='twr'}">績效 %</button>
                            <button @click="switchChartType('pnl')" :class="{active: chartType==='pnl'}">日損益</button>
                        </div>
                        <div class="chart-controls">
                            <button v-for="range in ['1M','3M','6M','YTD','1Y','ALL']" 
                                    :key="range" 
                                    @click="switchTimeRange(range)" 
                                    :class="{active: timeRange===range}">
                                {{ range }}
                            </button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="mainChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <div class="chart-header">
                        <div class="chart-controls">
                            <button @click="switchPieType('asset')" :class="{active: pieType==='asset'}">資產</button>
                            <button @click="switchPieType('currency')" :class="{active: pieType==='currency'}">幣別</button>
                            <button @click="switchPieType('strategy')" :class="{active: pieType==='strategy'}">策略</button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="pieChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>持倉明細</h3>
                <div v-if="calculating" class="loading">載入中...</div>
                <table v-else>
                    <thead>
                        <tr>
                            <th>代碼</th>
                            <th>標籤</th>
                            <th>股數</th>
                            <th>現價 (原幣)</th>
                            <th>市值 (TWD)</th>
                            <th>未實損益</th>
                            <th>報酬率</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="h in combinedHoldings" :key="h.symbol">
                            <td><strong>{{ h.symbol }}</strong></td>
                            <td><span class="tag">{{ h.tag }}</span></td>
                            <td>{{ formatNumber(h.qty, 1) }}</td>
                            <td>{{ h.current_price_origin }}</td>
                            <td>{{ formatNumber(h.market_value_twd) }}</td>
                            <td :class="h.pnl_twd >= 0 ? 'text-green' : 'text-red'">
                                {{ formatNumber(h.pnl_twd) }}
                            </td>
                            <td :class="h.pnl_percent >= 0 ? 'text-green' : 'text-red'">
                                {{ h.pnl_percent }}%
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div class="card" style="margin-top: 20px;">
                <div class="flex-row">
                    <h3>最近交易紀錄 (API)</h3>
                    <button class="btn btn-outline" @click="fetchRecords">重新整理</button>
                </div>
                <table>
                    <thead>
                        <tr><th>日期</th><th>代碼</th><th>動作</th><th>股數</th><th>價格</th></tr>
                    </thead>
                    <tbody>
                        <tr v-for="r in records.slice(0, 5)" :key="r.id">
                            <td>{{ r.txn_date }}</td>
                            <td>{{ r.symbol }}</td>
                            <td>
                                <span :class="r.txn_type === 'BUY' ? 'text-red' : 'text-green'">
                                    {{ r.txn_type }}
                                </span>
                            </td>
                            <td>{{ r.qty }}</td>
                            <td>{{ r.price }}</td>
                        </tr>
                        <tr v-if="records.length === 0"><td colspan="5" style="text-align:center">無資料</td></tr>
                    </tbody>
                </table>
            </div>

        </div>
    </div>

<script>
        const { createApp, ref, onMounted, computed, nextTick, watch } = Vue;

        // --- 修正點 1: 移除網址尾端的 /api，改為指向 Worker 根目錄 ---
        const WORKER_BASE_URL = "https://journal-backend.chired.workers.dev"; 
        
        // 請務必確認這裡填入的是您正確的 Google Client ID
        const CLIENT_ID = "951186116587-0ehsmkvlu3uivduc7kjn1jpp9ga7810i.apps.googleusercontent.com"; 

        createApp({
            setup() {
                // --- 狀態變數 ---
                const userToken = ref(localStorage.getItem('token') || '');
                const userName = ref(localStorage.getItem('name') || '');
                
                // 數據狀態
                const localStats = ref({}); 
                const fullChartData = ref([]); 
                const combinedHoldings = ref([]); 
                const records = ref([]); 
                const lastUpdateTime = ref('');
                const calculating = ref(true);
                const isUpdating = ref(false);

                // 圖表狀態
                const timeRange = ref('1Y');
                const chartType = ref('value'); 
                const pieType = ref('asset');   
                let mainChartInstance = null;
                let pieChartInstance = null;

                // 計算屬性
                const unrealizedPnL = computed(() => {
                    return (localStats.value.total_value || 0) - (localStats.value.invested_capital || 0);
                });

                // --- 登入與 API 邏輯 ---
                const logout = () => {
                    userToken.value = '';
                    userName.value = '';
                    localStorage.removeItem('token');
                    localStorage.removeItem('name');
                    location.reload(); // 強制重整以重置 Google 按鈕
                };

                const handleCredentialResponse = async (response) => {
                    try {
                        // --- 修正點 2: 登入路徑改為 /auth/google (不帶 /api) ---
                        const res = await fetch(`${WORKER_BASE_URL}/auth/google`, {
                            method: "POST",
                            headers: { "Content-Type": "application/json" }, // 建議加上 Content-Type
                            body: JSON.stringify({ id_token: response.credential })
                        });
                        
                        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                        
                        const data = await res.json();
                        if (data.success) {
                            userToken.value = data.token;
                            userName.value = data.user;
                            localStorage.setItem('token', data.token);
                            localStorage.setItem('name', data.user);
                            fetchRecords();
                        } else {
                            alert("登入失敗: " + (data.error || "未知錯誤"));
                        }
                    } catch(e) { 
                        console.error("Login Error:", e);
                        alert("登入連線失敗，請檢查 F12 Console"); 
                    }
                };

                // 取得後端交易紀錄
                const fetchRecords = async () => {
                    if (!userToken.value) return;
                    try {
                        // --- 修正點 3: 資料路徑維持 /api/records ---
                        const res = await fetch(`${WORKER_BASE_URL}/api/records`, {
                            headers: { 'Authorization': `Bearer ${userToken.value}` }
                        });
                        const json = await res.json();
                        if (json.success) records.value = json.data;
                    } catch(e) { console.error("Fetch records failed", e); }
                };

                // 觸發 GitHub Action 更新
                const triggerGitHubUpdate = async () => {
                    if (!userToken.value) return;
                    if(!confirm("確定要觸發 GitHub Action 更新最新報價嗎？")) return;
                    
                    isUpdating.value = true;
                    try {
                        // --- 修正點 4: 觸發路徑維持 /api/trigger-update ---
                        const res = await fetch(`${WORKER_BASE_URL}/api/trigger-update`, {
                            method: "POST",
                            headers: { 'Authorization': `Bearer ${userToken.value}` }
                        });
                        const json = await res.json();
                        if (json.success) alert("已觸發更新，請稍待 2-3 分鐘後重新整理頁面。");
                        else alert("觸發失敗: " + json.error);
                    } catch(e) { alert("連線錯誤"); }
                    finally { isUpdating.value = false; }
                };

                // --- 數據載入與圖表邏輯 (維持不變) ---
                const loadPortfolioData = async () => {
                    calculating.value = true;
                    try {
                        const res = await fetch(`data.json?t=${new Date().getTime()}`);
                        if (!res.ok) throw new Error("無法讀取 data.json");
                        
                        const data = await res.json();
                        
                        localStats.value = data.summary;
                        combinedHoldings.value = data.holdings;
                        fullChartData.value = data.history || []; 
                        lastUpdateTime.value = data.updated_at;

                        nextTick(() => {
                            drawChart();
                            drawPieChart();
                        });

                    } catch (e) {
                        console.error("載入報價失敗:", e);
                    } finally {
                        calculating.value = false;
                    }
                };

                // --- Chart.js 繪圖邏輯 (維持不變) ---
                const switchTimeRange = (range) => {
                    timeRange.value = range;
                    drawChart();
                };
                
                const switchChartType = (type) => {
                    chartType.value = type;
                    drawChart();
                };

                const filterDataByRange = (data) => {
                    if (timeRange.value === 'ALL') return data;
                    const now = new Date();
                    let startDate = new Date();
                    switch(timeRange.value) {
                        case '1M': startDate.setMonth(now.getMonth() - 1); break;
                        case '3M': startDate.setMonth(now.getMonth() - 3); break;
                        case '6M': startDate.setMonth(now.getMonth() - 6); break;
                        case 'YTD': startDate = new Date(now.getFullYear(), 0, 1); break;
                        case '1Y': startDate.setFullYear(now.getFullYear() - 1); break;
                    }
                    return data.filter(d => new Date(d.date) >= startDate);
                };

                const drawChart = () => {
                    const ctx = document.getElementById('mainChart');
                    if (!ctx || fullChartData.value.length === 0) return;
                    if (mainChartInstance) mainChartInstance.destroy();

                    const filtered = filterDataByRange(fullChartData.value);
                    const labels = filtered.map(d => d.date);
                    
                    let datasets = [];
                    let type = 'line';
                    
                    if (chartType.value === 'value') {
                        datasets = [
                            {
                                label: '總淨值',
                                data: filtered.map(d => d.total_value),
                                borderColor: '#40a9ff',
                                backgroundColor: 'rgba(64, 169, 255, 0.1)',
                                borderWidth: 2,
                                fill: true,
                                tension: 0.4
                            },
                            {
                                label: '投入成本',
                                data: filtered.map(d => d.invested),
                                borderColor: '#888',
                                borderDash: [5, 5],
                                borderWidth: 1,
                                pointRadius: 0
                            }
                        ];
                    } else if (chartType.value === 'twr') {
                        datasets = [{
                            label: 'TWR (%)',
                            data: filtered.map(d => d.twr),
                            borderColor: '#4caf50',
                            backgroundColor: 'rgba(76, 175, 80, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }];
                        if (filtered[0].benchmark_twr !== undefined) {
                            datasets.push({
                                label: 'SPY (%)',
                                data: filtered.map(d => d.benchmark_twr),
                                borderColor: '#ffc107',
                                borderWidth: 1,
                                pointRadius: 0
                            });
                        }
                    } else if (chartType.value === 'pnl') {
                        type = 'bar';
                        const pnlData = filtered.map((d, i) => {
                            if (i === 0) return 0;
                            const valDiff = d.total_value - filtered[i-1].total_value;
                            const costDiff = d.invested - filtered[i-1].invested;
                            return valDiff - costDiff;
                        });
                        datasets = [{
                            label: '單日損益',
                            data: pnlData,
                            backgroundColor: pnlData.map(v => v >= 0 ? '#4caf50' : '#ff5252')
                        }];
                    }

                    mainChartInstance = new Chart(ctx, {
                        type: type,
                        data: { labels, datasets },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: { mode: 'index', intersect: false },
                            plugins: {
                                legend: { labels: { color: '#e0e0e0' } },
                                tooltip: { 
                                    mode: 'index', 
                                    intersect: false,
                                    callbacks: {
                                        label: function(context) {
                                            let label = context.dataset.label || '';
                                            if (label) label += ': ';
                                            if (context.parsed.y !== null) label += formatNumber(context.parsed.y);
                                            return label;
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: { grid: { color: '#2d2d30' }, ticks: { color: '#888', maxTicksLimit: 8 } },
                                y: { grid: { color: '#2d2d30' }, ticks: { color: '#888' } }
                            }
                        }
                    });
                };

                const switchPieType = (type) => {
                    pieType.value = type;
                    drawPieChart();
                };

                const drawPieChart = () => {
                    const ctx = document.getElementById('pieChart');
                    if (!ctx || combinedHoldings.value.length === 0) return;
                    if (pieChartInstance) pieChartInstance.destroy();

                    let groupData = {};
                    combinedHoldings.value.forEach(h => {
                        let key;
                        if (pieType.value === 'asset') key = h.symbol;
                        else if (pieType.value === 'currency') key = h.currency;
                        else if (pieType.value === 'strategy') key = h.tag || 'Other';
                        
                        if (!groupData[key]) groupData[key] = 0;
                        groupData[key] += h.market_value_twd;
                    });

                    let sorted = Object.entries(groupData).sort((a,b) => b[1] - a[1]);
                    if (sorted.length > 8) {
                        const others = sorted.slice(8).reduce((acc, curr) => acc + curr[1], 0);
                        sorted = sorted.slice(0, 8);
                        sorted.push(['Others', others]);
                    }

                    const colors = ['#40a9ff', '#4caf50', '#ffc107', '#ff5252', '#9c27b0', '#00bcd4', '#ff9800', '#795548', '#607d8b'];

                    pieChartInstance = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: sorted.map(i => i[0]),
                            datasets: [{
                                data: sorted.map(i => i[1]),
                                backgroundColor: colors,
                                borderColor: '#18181c',
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { position: 'right', labels: { color: '#e0e0e0', boxWidth: 12 } }
                            }
                        }
                    });
                };

                const formatNumber = (num, digits=0) => {
                    if (num === undefined || num === null) return '-';
                    return Number(num).toLocaleString('zh-TW', { minimumFractionDigits: digits, maximumFractionDigits: digits });
                };

                onMounted(() => {
                    window.handleCredentialResponse = handleCredentialResponse;
                    loadPortfolioData();
                    if (userToken.value) fetchRecords();
                    window.addEventListener('resize', () => { 
                        if(mainChartInstance) drawChart(); 
                        if(pieChartInstance) drawPieChart();
                    });
                });

                return {
                    userToken, userName, googleClientId: CLIENT_ID, logout,
                    records, isUpdating, triggerGitHubUpdate,
                    localStats, combinedHoldings, unrealizedPnL, formatNumber, lastUpdateTime, calculating,
                    timeRange, switchTimeRange, chartType, switchChartType, pieType, switchPieType, fetchRecords
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
