<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SaaS äº¤æ˜“ç®¡ç†ç³»çµ± (AIç‰ˆ)</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        :root { --bg: #101014; --card-bg: #18181c; --border: #2d2d30; --primary: #40a9ff; --text: #e0e0e0; --green: #4caf50; --red: #ff5252; --yellow: #ffc107; }
        body { background-color: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        
        /* ç™»å…¥é®ç½© */
        .login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; justify-content: center; align-items: center; z-index: 1000; flex-direction: column; backdrop-filter: blur(5px); }
        .login-box { background: var(--card-bg); padding: 40px; border-radius: 16px; border: 1px solid var(--border); text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }

        /* ç‰ˆé¢ */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; border-bottom: 1px solid var(--border); padding-bottom: 20px; }
        .btn { padding: 8px 16px; border-radius: 6px; cursor: pointer; border: none; font-weight: 600; transition: 0.2s; display: inline-flex; align-items: center; gap: 6px; }
        .btn:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { filter: brightness(1.1); }
        .btn-danger { background: rgba(255, 82, 82, 0.1); color: var(--red); border: 1px solid var(--red); }
        .btn-success { background: var(--green); color: white; }
        .btn-warning { background: var(--yellow); color: #000; }
        .btn-icon { background: transparent; color: #888; padding: 4px; border-radius: 4px; border: none; cursor: pointer; }
        .btn-icon:hover { background: #333; color: white; }

        /* å¡ç‰‡èˆ‡è¡¨æ ¼ */
        .card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 24px; margin-bottom: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 24px; }
        .stat-item { background: #222; padding: 20px; border-radius: 12px; border: 1px solid #333; position: relative; overflow: hidden; }
        .stat-item::after { content: ''; position: absolute; top: 0; left: 0; width: 4px; height: 100%; background: var(--primary); }
        .stat-item.profit::after { background: var(--red); }
        .stat-item.loss::after { background: var(--green); }
        
        .stat-label { color: #888; font-size: 0.9rem; margin-bottom: 8px; display: flex; justify-content: space-between; }
        .stat-val { font-size: 1.6rem; font-weight: 700; letter-spacing: 0.5px; }
        .stat-sub { font-size: 0.85rem; margin-top: 5px; opacity: 0.7; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.95rem; }
        th { text-align: left; color: #888; border-bottom: 1px solid var(--border); padding: 12px; font-weight: 500; }
        td { padding: 12px; border-bottom: 1px solid #222; color: #ddd; }
        tr:last-child td { border-bottom: none; }
        .red { color: var(--red); } .green { color: var(--green); }

        /* ç·¨è¼¯è¡¨å–® */
        .editor-form { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; align-items: end; background: #1f1f23; padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #333; }
        input, select { background: #2d2d30; border: 1px solid #444; color: white; padding: 10px; border-radius: 6px; width: 100%; box-sizing: border-box; outline: none; }
        input:focus { border-color: var(--primary); }
        label { font-size: 0.8rem; color: #aaa; display: block; margin-bottom: 6px; }

        /* Loading å‹•ç•« */
        .spinner { width: 16px; height: 16px; border: 2px solid #ffffff3d; border-top: 2px solid #fff; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .badge { font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; background: #333; color: #aaa; margin-left: 5px; }
    </style>
</head>
<body>
    <div id="app" class="container">
        <div v-if="!userToken" class="login-overlay">
            <div class="login-box">
                <h2 style="margin-bottom: 10px;">SaaS äº¤æ˜“ç®¡ç†ç³»çµ±</h2>
                <p style="color:#888; margin-bottom:30px; font-size: 0.95rem;">å®‰å…¨çš„é›²ç«¯æŠ•è³‡çµ„åˆè¿½è¹¤å·¥å…·</p>
                <div id="g_id_onload" :data-client_id="googleClientId" data-callback="handleCredentialResponse" data-auto_select="false"></div>
                <div class="g_id_signin" data-type="standard" data-shape="pill" data-size="large" data-theme="filled_black"></div>
            </div>
        </div>

        <div v-else>
            <div class="header">
                <div>
                    <h2 style="margin:0; display:flex; align-items:center; gap:10px;">
                        æŠ•è³‡çµ„åˆçœ‹æ¿ 
                        <span v-if="calculating || isUpdating" class="spinner" style="border-color:var(--primary) transparent var(--primary) transparent"></span>
                    </h2>
                    <div style="color:#888; font-size:0.9rem; margin-top:5px;">
                        ğŸ‘¤ {{ userName }} <span class="badge">PRO</span>
                    </div>
                </div>
                <div style="display:flex; gap:10px; flex-wrap: wrap;">
                    <button class="btn btn-primary" @click="triggerGitHubUpdate" :disabled="isUpdating || calculating">
                        <span v-if="!isUpdating">ğŸš€ å¼·åˆ¶æ›´æ–°å ±åƒ¹</span>
                        <span v-else>è«‹æ±‚ç™¼é€ä¸­...</span>
                    </button>

                    <button class="btn btn-success" @click="refreshData" :disabled="calculating">
                        <span v-if="!calculating">ğŸ”„ é‡æ–°è®€å–æ•¸æ“š</span>
                        <span v-else>è¼‰å…¥ä¸­...</span>
                    </button>
                    
                    <button class="btn btn-danger" @click="logout">ç™»å‡º</button>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-item">
                    <div class="stat-label">ç¸½æŠ•å…¥æˆæœ¬ (Cost)</div>
                    <div class="stat-val">${{ formatNumber(localStats.totalCost) }}</div>
                    <div class="stat-sub">äº¤æ˜“ç­†æ•¸: {{ records.length }}</div>
                </div>

                <div class="stat-item">
                    <div class="stat-label">
                        å³æ™‚ç¸½å¸‚å€¼ (Market Value)
                        <span style="font-size:0.8rem; color:#666;">TWD</span>
                    </div>
                    <div class="stat-val" style="color:var(--primary)">
                        ${{ formatNumber(marketStats.total_value || localStats.totalCost) }}
                    </div>
                    <div class="stat-sub" v-if="marketStats.exchange_rate">
                        USD/TWD: {{ marketStats.exchange_rate }}
                    </div>
                    <div class="stat-sub" v-else>ç­‰å¾…æ•¸æ“šè¼‰å…¥...</div>
                </div>

                <div class="stat-item" :class="unrealizedPnL >= 0 ? 'profit' : 'loss'">
                    <div class="stat-label">æœªå¯¦ç¾æç›Š (Unrealized P/L)</div>
                    <div class="stat-val" :class="unrealizedPnL >= 0 ? 'red' : 'green'">
                        {{ unrealizedPnL >= 0 ? '+' : '' }}{{ formatNumber(unrealizedPnL) }}
                    </div>
                    <div class="stat-sub" v-if="marketStats.total_value">
                        å ±é…¬ç‡: {{ getReturnRate(unrealizedPnL, localStats.totalCost) }}%
                    </div>
                </div>
            </div>

            <div class="card">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <h3 style="margin:0; color:var(--primary); font-size:1.1rem;">
                        {{ isEditing ? 'âœï¸ ä¿®æ”¹äº¤æ˜“' : 'â• æ–°å¢äº¤æ˜“' }}
                    </h3>
                    <button v-if="isEditing" @click="resetForm" style="background:none; border:none; color:#888; cursor:pointer;">âœ• å–æ¶ˆ</button>
                </div>
                
                <div class="editor-form">
                    <div><label>æ—¥æœŸ</label><input type="date" v-model="form.txn_date"></div>
                    <div><label>ä»£ç¢¼ (e.g. AAPL, 2330.TW)</label><input type="text" v-model="form.symbol" placeholder="è¼¸å…¥ä»£ç¢¼" @input="form.symbol = form.symbol.toUpperCase()"></div>
                    <div>
                        <label>é¡åˆ¥</label>
                        <select v-model="form.txn_type">
                            <option value="BUY">è²·å…¥ (Buy)</option>
                            <option value="SELL">è³£å‡º (Sell)</option>
                            <option value="DIV">é…æ¯ (Div)</option>
                        </select>
                    </div>
                    <div><label>è‚¡æ•¸</label><input type="number" v-model="form.qty" placeholder="0" step="0.01"></div>
                    <div><label>æˆäº¤åƒ¹æ ¼</label><input type="number" v-model="form.price" placeholder="0.00" step="0.01"></div>
                    <div><label>æ‰‹çºŒè²»/ç¨…</label><input type="number" v-model="form.fee" placeholder="0"></div>
                    <div>
                        <label>&nbsp;</label>
                        <button class="btn btn-primary" style="width:100%" @click="submitRecord" :disabled="loading">
                            <span v-if="loading" class="spinner"></span>
                            <span v-else>{{ isEditing ? 'ä¿å­˜' : 'æ–°å¢' }}</span>
                        </button>
                    </div>
                </div>
                <div style="font-size: 0.8rem; color: #666; margin-top: 10px;">
                    ğŸ’¡ æç¤ºï¼šæ–°å¢äº¤æ˜“å¾Œï¼Œè«‹é»æ“Šä¸Šæ–¹ã€Œå¼·åˆ¶æ›´æ–°å ±åƒ¹ã€æˆ–ç­‰å¾…æ¯æ—¥è‡ªå‹•æ›´æ–°ã€‚
                </div>
            </div>

            <div style="display:flex; gap:20px; flex-wrap:wrap;">
                <div class="card" style="flex:2; min-width:400px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <h3 style="margin:0;">ğŸ“Š æŒå€‰æç›Š (Holdings)</h3>
                        <span style="font-size:0.8rem; color:#666;" v-if="lastUpdateTime">
                            æ•¸æ“šæ›´æ–°æ–¼: {{ lastUpdateTime }}
                        </span>
                    </div>
                    <div style="overflow-x:auto;">
                        <table>
                            <thead>
                                <tr>
                                    <th>ä»£ç¢¼</th>
                                    <th>è‚¡æ•¸</th>
                                    <th>å¹³å‡æˆæœ¬</th>
                                    <th>ç¾åƒ¹ (Origin)</th>
                                    <th>å¸‚å€¼ (TWD)</th>
                                    <th>æç›Š</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="h in combinedHoldings" :key="h.symbol">
                                    <td style="font-weight:bold; color:white;">
                                        {{ h.symbol }}
                                        <span class="badge" v-if="h.currency">{{ h.currency }}</span>
                                    </td>
                                    <td>{{ formatNumber(h.qty) }}</td>
                                    <td>{{ formatNumber(h.avgCost) }}</td>
                                    <td style="color:var(--primary)">
                                        {{ h.marketPrice ? formatNumber(h.marketPrice) : '-' }}
                                    </td>
                                    <td style="font-weight:bold;">
                                        {{ h.marketValue ? formatNumber(h.marketValue) : '-' }}
                                    </td>
                                    <td :class="h.pnl >= 0 ? 'red' : 'green'">
                                        {{ h.pnl ? (h.pnl >= 0 ? '+' : '') + formatNumber(h.pnl) : '-' }}
                                    </td>
                                </tr>
                                <tr v-if="combinedHoldings.length === 0">
                                    <td colspan="6" style="text-align:center; color:#666; padding:30px;">
                                        å°šç„¡æŒå€‰æˆ–æ•¸æ“šå°šæœªè¼‰å…¥
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="card" style="flex:1; min-width:300px;">
                    <h3 style="margin-top:0; margin-bottom:15px;">ğŸ“ äº¤æ˜“ç´€éŒ„ (Ledger)</h3>
                    <div style="overflow-x:auto; max-height:500px; overflow-y:auto;">
                        <table>
                            <thead><tr><th>æ—¥æœŸ</th><th>ä»£ç¢¼</th><th>å‹•ä½œ</th><th>åƒ¹æ ¼</th><th></th></tr></thead>
                            <tbody>
                                <tr v-for="tx in records" :key="tx.id">
                                    <td style="color:#888; font-size:0.85rem;">{{ tx.txn_date.slice(5) }}</td>
                                    <td style="font-weight:bold;">{{ tx.symbol }}</td>
                                    <td>
                                        <span :style="{color: tx.txn_type==='BUY'?'#69f0ae':(tx.txn_type==='SELL'?'#ff5252':'#ffd700'), fontWeight:'bold', fontSize:'0.85rem'}">
                                            {{ tx.txn_type }}
                                        </span>
                                        <small style="color:#666">x{{ tx.qty }}</small>
                                    </td>
                                    <td>{{ tx.price }}</td>
                                    <td style="text-align:right;">
                                        <button class="btn-icon" @click="editRecord(tx)">âœ</button>
                                        <button class="btn-icon" style="color:var(--red)" @click="deleteRecord(tx.id)">Ã—</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue;
        
        // ---------------- CONFIG ----------------
        // é€™è£¡å¡«å…¥æ‚¨çš„ Worker ç¶²å€
        const DB_API_URL = "https://journal-backend.chired.workers.dev";
        const CLIENT_ID = "951186116587-0ehsmkvlu3uivduc7kjn1jpp9ga7810i.apps.googleusercontent.com";
        // ----------------------------------------

        createApp({
            setup() {
                const userToken = ref(localStorage.getItem('token') || '');
                const userName = ref(localStorage.getItem('name') || '');
                
                const records = ref([]);
                const marketStats = ref({}); 
                const marketHoldings = ref([]); 
                const lastUpdateTime = ref('');
                
                const loading = ref(false);
                const calculating = ref(false); // æ§åˆ¶è®€å– json çš„ loading
                const isUpdating = ref(false);  // æ§åˆ¶è§¸ç™¼ GitHub æ›´æ–°çš„ loading
                const isEditing = ref(false);
                const form = ref({ id: null, txn_date: new Date().toISOString().split('T')[0], symbol: '', txn_type: 'BUY', qty: '', price: '', fee: 0 });

                // --- 1. æœ¬åœ°é‹ç®— (å³æ™‚åæ‡‰æ–°å¢çš„äº¤æ˜“) ---
                const localHoldings = computed(() => {
                    const map = {};
                    const sorted = [...records.value].sort((a,b) => new Date(a.txn_date) - new Date(b.txn_date));
                    
                    sorted.forEach(tx => {
                        const sym = tx.symbol;
                        if (!map[sym]) map[sym] = { symbol: sym, qty: 0, totalCost: 0 };
                        
                        const qty = parseFloat(tx.qty);
                        const price = parseFloat(tx.price);
                        const fee = parseFloat(tx.fee) || 0;

                        if (tx.txn_type === 'BUY') {
                            map[sym].totalCost += (qty * price) + fee;
                            map[sym].qty += qty;
                        } else if (tx.txn_type === 'SELL') {
                            const costPerShare = map[sym].qty > 0 ? map[sym].totalCost / map[sym].qty : 0;
                            map[sym].totalCost -= (costPerShare * qty); 
                            map[sym].qty -= qty;
                        }
                    });
                    return Object.values(map).filter(h => h.qty > 0.001);
                });

                const localStats = computed(() => {
                    return {
                        totalCost: localHoldings.value.reduce((sum, h) => sum + h.totalCost, 0)
                    };
                });

                // --- 2. æ··åˆé‹ç®— (çµåˆæœ¬åœ°äº¤æ˜“ç´€éŒ„ + é ç«¯å ±åƒ¹) ---
                const combinedHoldings = computed(() => {
                    return localHoldings.value.map(local => {
                        // æ¯”å° data.json è£¡çš„ holding è³‡æ–™
                        const remote = marketHoldings.value.find(r => r.symbol === local.symbol) || {};
                        const avgCost = local.qty > 0 ? local.totalCost / local.qty : 0;
                        const marketValue = remote.market_value_twd || null; 
                        const pnl = marketValue ? (marketValue - local.totalCost) : null;

                        return {
                            ...local,
                            avgCost: avgCost,
                            marketPrice: remote.current_price_origin || null, 
                            marketValue: marketValue,
                            currency: remote.currency || '',
                            pnl: pnl
                        };
                    });
                });

                const unrealizedPnL = computed(() => {
                    const mktVal = marketStats.value.total_value || 0;
                    if (mktVal === 0) return 0;
                    return mktVal - localStats.value.totalCost;
                });

                // --- 3. API äº’å‹• ---
                const fetchRecords = async () => {
                    if (!userToken.value) return;
                    try {
                        const res = await fetch(`${DB_API_URL}/api/records`, {
                            headers: { "Authorization": `Bearer ${userToken.value}` }
                        });
                        const json = await res.json();
                        if (json.success) {
                            records.value = json.data;
                        }
                    } catch(e) { console.error("Fetch records error", e); }
                };

                // è®€å–éœæ…‹ data.json
                const calculatePortfolio = async () => {
                    calculating.value = true;
                    try {
                        // åŠ ä¸Š timestamp é¿å…ç€è¦½å™¨å¿«å–èˆŠè³‡æ–™
                        const res = await fetch(`data.json?t=${new Date().getTime()}`);
                        if(res.ok) {
                            const json = await res.json();
                            marketStats.value = json.summary || {};
                            marketHoldings.value = json.holdings || [];
                            lastUpdateTime.value = json.updated_at || '';
                        }
                    } catch(e) {
                        console.error("Load data error", e);
                    }
                    calculating.value = false;
                };

                // [æ–°å¢] è§¸ç™¼ GitHub Actions æ›´æ–°
                const triggerGitHubUpdate = async () => {
                    if(!confirm("ç¢ºå®šè¦å¼·åˆ¶æ›´æ–°å ±åƒ¹å—ï¼Ÿ\n\né€™æœƒé€šçŸ¥ GitHub é–‹å§‹é‹ç®—ï¼Œç´„éœ€ 1-2 åˆ†é˜å®Œæˆã€‚")) return;
                    
                    isUpdating.value = true;
                    try {
                        const res = await fetch(`${DB_API_URL}/api/trigger-update`, {
                            method: 'POST',
                            headers: { 
                                "Content-Type": "application/json",
                                "Authorization": `Bearer ${userToken.value}` 
                            }
                        });
                        
                        const json = await res.json();
                        
                        if (json.success) {
                            alert("âœ… å·²æˆåŠŸè§¸ç™¼æ›´æ–°ï¼\n\nGitHub æ­£åœ¨èƒŒæ™¯è¨ˆç®—æœ€æ–°è‚¡åƒ¹ï¼Œè«‹ä¼‘æ¯ä¸€ä¸‹ï¼Œç´„ 2 åˆ†é˜å¾Œé»æ“Šã€Œé‡æ–°è®€å–æ•¸æ“šã€æŒ‰éˆ•æŸ¥çœ‹çµæœã€‚");
                        } else {
                            alert("âŒ è§¸ç™¼å¤±æ•—ï¼š" + (json.error || 'æœªçŸ¥éŒ¯èª¤'));
                        }
                    } catch (e) {
                        console.error(e);
                        alert("é€£ç·šéŒ¯èª¤ï¼Œç„¡æ³•è§¸ç™¼æ›´æ–°ã€‚");
                    }
                    isUpdating.value = false;
                };

                const refreshData = async () => {
                    await calculatePortfolio();
                    alert("æ•¸æ“šè®€å–å®Œæˆã€‚è‹¥æ•¸å€¼æœªè®Šï¼Œä»£è¡¨ GitHub é‚„åœ¨è¨ˆç®—ä¸­ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
                };

                // --- 4. CRUD èˆ‡å·¥å…·å‡½å¼ ---
                const submitRecord = async () => {
                    loading.value = true;
                    const method = isEditing.value ? "PUT" : "POST";
                    const payload = { ...form.value };
                    
                    try {
                        const res = await fetch(`${DB_API_URL}/api/records`, {
                            method,
                            headers: { 
                                "Content-Type": "application/json", 
                                "Authorization": `Bearer ${userToken.value}` 
                            },
                            body: JSON.stringify(payload)
                        });
                        if(res.ok) {
                            resetForm();
                            await fetchRecords(); 
                        } else {
                            alert("å„²å­˜å¤±æ•—");
                        }
                    } catch(e) { alert("é€£ç·šéŒ¯èª¤"); }
                    loading.value = false;
                };

                const deleteRecord = async (id) => {
                    if(!confirm("ç¢ºå®šåˆªé™¤?")) return;
                    await fetch(`${DB_API_URL}/api/records`, {
                        method: "DELETE",
                        headers: { "Content-Type": "application/json", "Authorization": `Bearer ${userToken.value}` },
                        body: JSON.stringify({ id })
                    });
                    fetchRecords();
                };

                const editRecord = (tx) => { isEditing.value = true; form.value = { ...tx }; };
                const resetForm = () => { isEditing.value = false; form.value = { id: null, txn_date: new Date().toISOString().split('T')[0], symbol: '', txn_type: 'BUY', qty: '', price: '', fee: 0 }; };
                const formatNumber = (num) => num ? Number(num).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 2 }) : '0';
                const getReturnRate = (pnl, cost) => cost > 0 ? ((pnl / cost) * 100).toFixed(2) : 0;
                
                const logout = () => {
                    localStorage.clear();
                    userToken.value = '';
                    records.value = [];
                    marketStats.value = {};
                    marketHoldings.value = [];
                };

                window.handleCredentialResponse = async (response) => {
                    try {
                        const res = await fetch(`${DB_API_URL}/auth/google`, {
                            method: "POST",
                            body: JSON.stringify({ id_token: response.credential })
                        });
                        const data = await res.json();
                        if (data.success) {
                            userToken.value = data.token;
                            userName.value = data.user;
                            localStorage.setItem('token', data.token);
                            localStorage.setItem('name', data.user);
                            fetchRecords();
                        }
                    } catch(e) { alert("ç™»å…¥å¤±æ•—"); }
                };

                onMounted(() => {
                    calculatePortfolio(); // å…ˆè¼‰å…¥å…¬é–‹å ±åƒ¹
                    if (userToken.value) fetchRecords(); // æœ‰ç™»å…¥å‰‡è¼‰å…¥äº¤æ˜“ç´€éŒ„
                });

                return {
                    userToken, userName, googleClientId: CLIENT_ID, logout,
                    records, form, loading, calculating, isUpdating, isEditing,
                    submitRecord, deleteRecord, editRecord, resetForm, 
                    refreshData, triggerGitHubUpdate,
                    localStats, marketStats, combinedHoldings, unrealizedPnL,
                    formatNumber, getReturnRate, lastUpdateTime
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
