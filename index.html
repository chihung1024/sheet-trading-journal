<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æŠ•è³‡çµ„åˆçœ‹æ¿ (Pro+)</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- åŸºç¤è¨­å®š --- */
        body { background-color: #101014; color: #e0e0e0; margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding-bottom: 60px; -webkit-tap-highlight-color: transparent; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        .header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 20px; border-bottom: 1px solid #2d2d30; padding-bottom: 10px; }
        .header h2 { margin: 0; font-size: 1.5rem; }
        .header .sub-title { font-size: 0.8rem; color: #888; margin-top: 4px; }
        .update-time { color: #666; font-size: 0.85rem; }

        /* è­¦å‘Šèˆ‡å¡ç‰‡ */
        .alert-card { background: rgba(255, 82, 82, 0.1); border: 1px solid #ff5252; border-radius: 8px; padding: 15px; margin-bottom: 20px; color: #ff5252; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; margin-bottom: 24px; }
        .card { background: #18181c; padding: 20px; border-radius: 12px; border: 1px solid #2d2d30; transition: all 0.2s; }
        .card-label { color: #9aa5b1; font-size: 0.85rem; margin-bottom: 6px; }
        .card-value { font-size: 1.5rem; font-weight: 700; letter-spacing: 0.5px; }
        .card-sub { font-size: 0.8rem; margin-top: 6px; font-weight: 500; }
        
        .red { color: #ff5252; } .green { color: #4caf50; } .blue { color: #40a9ff; } .gray { color: #888; }
        
        /* å¤šé¸ä¸‹æ‹‰é¸å–® (Multi-select) æ¨£å¼ */
        .multi-select-container { position: relative; min-width: 250px; margin-bottom: 20px; }
        .multi-select-trigger { 
            background: #18181c; border: 1px solid #333; border-radius: 8px; 
            padding: 8px 12px; min-height: 40px; cursor: pointer; 
            display: flex; flex-wrap: wrap; gap: 6px; align-items: center; 
            position: relative;
        }
        .multi-select-trigger:hover { border-color: #555; }
        .placeholder-text { color: #666; font-size: 0.9rem; }
        .tag-chip { 
            background: #2d3e50; color: #a0d3e8; border-radius: 4px; 
            padding: 2px 8px; font-size: 0.85rem; display: flex; align-items: center; gap: 5px; 
        }
        .tag-remove { cursor: pointer; opacity: 0.7; font-weight: bold; }
        .tag-remove:hover { opacity: 1; color: #fff; }
        .dropdown-menu {
            position: absolute; top: 100%; left: 0; width: 100%; 
            background: #1f1f23; border: 1px solid #333; border-radius: 8px; 
            margin-top: 5px; max-height: 250px; overflow-y: auto; z-index: 100;
            box-shadow: 0 4px 12px rgba(0,0,0,0.5);
            display: none;
        }
        .dropdown-menu.show { display: block; }
        .dropdown-item { 
            padding: 10px 15px; cursor: pointer; font-size: 0.9rem; color: #ccc; 
            display: flex; justify-content: space-between; align-items: center;
        }
        .dropdown-item:hover { background: #2d2d30; color: #fff; }
        .dropdown-item.selected { color: #40a9ff; background: rgba(64, 169, 255, 0.1); }
        .dropdown-backdrop { position: fixed; inset: 0; z-index: 99; display: none; }
        .dropdown-backdrop.show { display: block; }

        /* åœ–è¡¨èˆ‡æ§åˆ¶åˆ— */
        .chart-controls { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; }
        .btn-group { display: flex; border-radius: 6px; overflow: hidden; border: 1px solid #333; background: #2d2d30; }
        .btn-group button { background: transparent; border: none; border-right: 1px solid #333; color: #888; padding: 6px 12px; cursor: pointer; font-size: 0.85rem; transition: 0.2s; white-space: nowrap; }
        .btn-group button:last-child { border-right: none; }
        .btn-group button.active { background: #40a9ff; color: #fff; font-weight: bold; }

        /* é›™æ¬„ä½ˆå±€ */
        .row { display: flex; gap: 20px; margin-bottom: 24px; flex-wrap: wrap; }
        .col-main { flex: 2; min-width: 300px; }
        .col-side { flex: 1; min-width: 300px; }
        .chart-section { background: #18181c; padding: 20px; border-radius: 12px; border: 1px solid #2d2d30; height: 100%; }
        .chart-container { position: relative; width: 100%; height: 350px; }
        .pie-container { position: relative; width: 100%; height: 250px; }

        /* è¡¨æ ¼èˆ‡æµæ°´å¸³ */
        .table-card { background: #18181c; border-radius: 12px; border: 1px solid #2d2d30; margin-bottom: 24px; overflow: hidden; }
        .table-header { padding: 16px 20px; border-bottom: 1px solid #2d2d30; background: #1f1f23; }
        .table-header h3 { margin: 0; font-size: 1rem; color: #eee; }
        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; white-space: nowrap; }
        th, td { padding: 12px 16px; border-bottom: 1px solid #2d2d30; text-align: right; }
        th:first-child, td:first-child { text-align: left; position: sticky; left: 0; background: #18181c; z-index: 2; }
        th { color: #888; font-weight: 500; background: #1f1f23; }

        /* æµæ°´å¸³å·¥å…·åˆ— */
        .ledger-toolbar { padding: 15px 20px; border-bottom: 1px solid #2d2d30; display: flex; gap: 10px; flex-wrap: wrap; align-items: center; }
        .search-input { background: #2d2d30; border: 1px solid #333; color: #fff; padding: 6px 12px; border-radius: 4px; }
        .filter-select { background: #2d2d30; border: 1px solid #333; color: #ccc; padding: 6px 24px 6px 12px; border-radius: 4px; }
        .ledger-summary-bar { padding: 10px 20px; background: #1f1f23; display: flex; justify-content: flex-end; gap: 15px; font-size: 0.9rem; flex-wrap: wrap; }
        .summary-item { display: flex; align-items: center; gap: 5px; }
        .summary-val { font-weight: bold; font-family: monospace; }

        .pagination { display: flex; justify-content: center; gap: 10px; padding: 15px; align-items: center; }
        .page-btn { background: #2d2d30; border: 1px solid #333; color: #ccc; padding: 5px 12px; border-radius: 4px; cursor: pointer; }
        .page-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Badges */
        .symbol-tag { padding: 3px 8px; background: #2d2d30; border-radius: 4px; font-weight: 700; color: #fff; font-size: 0.8rem; }
        .type-badge { padding: 2px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; }
        .badge-buy { background: #1f3a30; color: #69f0ae; }
        .badge-sell { background: #3a1f1f; color: #ff5252; }
        .badge-div { background: #1a3a50; color: #40a9ff; }

        .footer { text-align: center; margin-top: 30px; font-size: 0.9rem; color: #666; }
        .footer a { color: #40a9ff; text-decoration: none; }

        @media (max-width: 768px) {
            .row { flex-direction: column; }
            .ledger-summary-bar { flex-direction: column; align-items: flex-end; }
        }
    </style>
</head>
<body>
    <div id="app" class="container">
        <div class="header">
            <div>
                <h2>æŠ•è³‡çµ„åˆçœ‹æ¿ (Pro+)</h2>
                <div class="sub-title">TWD æœ¬ä½ â€¢ æ”¯æ´å¤šé¸ç­–ç•¥åˆ†æ</div>
            </div>
            <div style="text-align: right;">
                <div class="update-time">æ›´æ–°: {{ updateTime }}</div>
                <div class="update-time" style="color:#40a9ff">åŒ¯ç‡: 1 USD â‰ˆ {{ exchangeRate }} TWD</div>
            </div>
        </div>

        <div class="multi-select-container">
            <div v-if="dropdownOpen" class="dropdown-backdrop show" @click="dropdownOpen = false"></div>
            <div class="multi-select-trigger" @click="dropdownOpen = !dropdownOpen">
                <span v-if="selectedTags.length === 0" class="placeholder-text">ç¯©é¸ç­–ç•¥ (All Tags)</span>
                <div v-for="tag in selectedTags" :key="tag" class="tag-chip" @click.stop>
                    {{ tag }}
                    <span class="tag-remove" @click.stop="toggleTag(tag)">Ã—</span>
                </div>
                <div style="margin-left: auto; color: #666;">â–¼</div>
            </div>
            <div class="dropdown-menu" :class="{show: dropdownOpen}">
                <div class="dropdown-item" @click="clearTags" style="color: #888; border-bottom: 1px solid #333;">
                    <span>æ¸…é™¤å…¨éƒ¨</span>
                </div>
                <div v-for="tag in availableTags" :key="tag" 
                     class="dropdown-item" 
                     :class="{selected: selectedTags.includes(tag)}"
                     @click="toggleTag(tag)">
                    <span>{{ tag }}</span>
                    <span v-if="selectedTags.includes(tag)">âœ“</span>
                </div>
            </div>
        </div>

        <div v-if="messages.length > 0" class="alert-card">
            <ul><li v-for="msg in messages">{{ msg }}</li></ul>
        </div>

        <div class="grid">
            <div class="card">
                <div class="card-label">æŒæœ‰å¸‚å€¼ (NT$)</div>
                <div class="card-value">${{ formatNumber(computedStats.total_value) }}</div>
            </div>
            <div class="card">
                <div class="card-label">å€é–“/ç­–ç•¥ TWR</div>
                <div class="card-value" :class="computedStats.twr >= 0 ? 'red' : 'green'">
                    {{ computedStats.twr >= 0 ? '+' : '' }}{{ computedStats.twr }}%
                </div>
                <div class="card-sub" style="color:#888">
                    {{ selectedTags.length > 0 ? 'åŸºæ–¼é¸å®šç­–ç•¥' : 'æ•´é«”æŠ•è³‡çµ„åˆ' }}
                </div>
            </div>
            <div class="card">
                <div class="card-label">å¸³é¢æç›Š (NT$)</div>
                <div class="card-value" :class="computedStats.unrealized_pnl >= 0 ? 'red' : 'green'">
                    {{ computedStats.unrealized_pnl >= 0 ? '+' : '' }}{{ formatNumber(computedStats.unrealized_pnl) }}
                </div>
            </div>
            <div class="card">
                <div class="card-label">å·²å¯¦ç¾æç›Š (NT$)</div>
                <div class="card-value" :class="computedStats.realized_pnl >= 0 ? 'red' : 'green'">
                    {{ formatNumber(computedStats.realized_pnl) }}
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-main">
                <div class="chart-section">
                    <div class="chart-controls">
                        <h3 style="margin:0; color:#ddd; font-size:1.1rem">è¶¨å‹¢åˆ†æ {{ selectedTags.length > 0 ? '(Filtered)' : '' }}</h3>
                        <div class="btn-group">
                            <button :class="{active: chartType==='pnl'}" @click="switchChartType('pnl')">æç›Š$</button>
                            <button :class="{active: chartType==='twr'}" @click="switchChartType('twr')">TWR%</button>
                            <button :class="{active: chartType==='asset'}" @click="switchChartType('asset')">è³‡ç”¢</button>
                        </div>
                        <div class="btn-group">
                            <button :class="{active: timeRange==='1M'}" @click="switchTimeRange('1M')">1M</button>
                            <button :class="{active: timeRange==='6M'}" @click="switchTimeRange('6M')">6M</button>
                            <button :class="{active: timeRange==='1Y'}" @click="switchTimeRange('1Y')">1Y</button>
                            <button :class="{active: timeRange==='ALL'}" @click="switchTimeRange('ALL')">ALL</button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="mainChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="col-side">
                <div class="chart-section">
                    <div class="chart-controls">
                        <h3 style="margin:0; color:#ddd; font-size:1.1rem">é…ç½®ä½”æ¯”</h3>
                    </div>
                    <div class="pie-container">
                        <canvas id="pieChart"></canvas>
                    </div>
                    <div style="text-align:center; margin-top:10px; font-size:0.8rem; color:#888;">
                        (é¡¯ç¤ºç›®å‰ç¯©é¸ç¯„åœå…§çš„è³‡ç”¢åˆ†ä½ˆ)
                    </div>
                </div>
            </div>
        </div>

        <div class="table-card">
            <div class="table-header"><h3>ç›®å‰æŒå€‰ (Open Positions)</h3></div>
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr><th>ä»£ç¢¼</th><th>ç­–ç•¥</th><th>åŸå¹£ç¾åƒ¹</th><th>æŒæœ‰è‚¡æ•¸</th><th>å¸‚å€¼(NT$)</th><th>æç›Š(NT$)</th><th>%</th></tr>
                    </thead>
                    <tbody>
                        <tr v-for="s in filteredHoldings" :key="s.symbol">
                            <td><span class="symbol-tag">{{ s.symbol }}</span></td>
                            <td style="text-align:center"><span style="color:#a0d3e8; font-size:0.8rem;">{{ s.tag }}</span></td>
                            <td style="color:#aaa">{{ s.current_price_origin }}</td>
                            <td>{{ s.qty }}</td>
                            <td style="font-weight:bold">${{ formatNumber(s.market_value_twd) }}</td>
                            <td :class="s.pnl_twd >= 0 ? 'red' : 'green'">{{ s.pnl_twd >= 0 ? '+' : '' }}{{ formatNumber(s.pnl_twd) }}</td>
                            <td :class="s.pnl_percent >= 0 ? 'red' : 'green'">{{ s.pnl_percent }}%</td>
                        </tr>
                        <tr v-if="filteredHoldings.length===0"><td colspan="7" style="text-align:center;padding:20px;color:#666">ç„¡ç¬¦åˆç¯©é¸çš„æŒå€‰</td></tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="table-card">
            <div class="table-header"><h3>è³‡é‡‘æµæ°´å¸³ (Ledger)</h3></div>
            <div class="ledger-toolbar">
                <input type="text" v-model="searchQuery" placeholder="ğŸ” æœå°‹ä»£ç¢¼/å‚™è¨»" class="search-input">
                <select v-model="filterType" class="filter-select">
                    <option value="ALL">å…¨éƒ¨é¡å‹</option>
                    <option value="BUY">è²·å…¥</option>
                    <option value="SELL">è³£å‡º</option>
                    <option value="DIVIDEND">é…æ¯</option>
                </select>
                <select v-model="filterYear" class="filter-select">
                    <option value="ALL">å…¨éƒ¨å¹´ä»½</option>
                    <option v-for="year in availableYears" :key="year" :value="year">{{ year }}</option>
                </select>
            </div>
            <div class="ledger-summary-bar">
                <div class="summary-item">
                    <span style="color:#888">ç¯©é¸å€é–“æ·¨æµ:</span>
                    <span :class="ledgerStats.netFlow >= 0 ? 'blue' : 'green'" class="summary-val">{{ formatNumber(ledgerStats.netFlow) }}</span>
                </div>
                <div class="summary-item" style="margin-left:15px;">
                    <span style="color:#888">å·²å¯¦ç¾æç›Š:</span>
                    <span :class="ledgerStats.realized >= 0 ? 'red' : 'green'" class="summary-val">{{ ledgerStats.realized >= 0 ? '+' : '' }}{{ formatNumber(ledgerStats.realized) }}</span>
                </div>
            </div>
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr><th>æ—¥æœŸ</th><th>é¡å‹</th><th>ä»£ç¢¼</th><th>Tag</th><th>åƒ¹æ ¼</th><th>é‡‘é¡è®Šå‹•(NT$)</th><th>å‚™è¨»</th></tr>
                    </thead>
                    <tbody>
                        <tr v-for="tx in paginatedLedger" :key="tx.date + tx.symbol + tx.type + tx.amount_twd">
                            <td style="color:#aaa">{{ tx.date }}</td>
                            <td>
                                <span v-if="tx.type==='BUY'" class="type-badge badge-buy">è²·å…¥</span>
                                <span v-else-if="tx.type==='SELL'" class="type-badge badge-sell">è³£å‡º</span>
                                <span v-else class="type-badge badge-div">é…æ¯</span>
                            </td>
                            <td><span class="symbol-tag">{{ tx.symbol }}</span></td>
                            <td><span style="color:#888;font-size:0.8rem">{{ tx.tag }}</span></td>
                            <td>{{ tx.price > 0 ? tx.price : '-' }}</td>
                            <td :class="tx.amount_twd >= 0 ? 'blue' : 'green'" style="font-weight:bold">
                                {{ tx.amount_twd >= 0 ? '+' : '' }}{{ formatNumber(tx.amount_twd) }}
                            </td>
                            <td style="font-size:0.85rem; color:#888">{{ tx.note }}</td>
                        </tr>
                        <tr v-if="paginatedLedger.length===0"><td colspan="7" style="text-align:center;padding:30px;color:#666">ç„¡ç´€éŒ„</td></tr>
                    </tbody>
                </table>
            </div>
            <div class="pagination" v-if="totalPages > 1">
                <button class="page-btn" @click="prevPage" :disabled="currentPage === 1">ä¸Šä¸€é </button>
                <span style="font-size:0.85rem; color:#666">ç¬¬ {{ currentPage }} / {{ totalPages }} é </span>
                <button class="page-btn" @click="nextPage" :disabled="currentPage === totalPages">ä¸‹ä¸€é </button>
            </div>
        </div>
        
        <div class="footer"><a href="https://docs.google.com/spreadsheets" target="_blank">ç·¨è¼¯ Google Sheet</a></div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, nextTick, watch } = Vue
        
        createApp({
            setup() {
                // è³‡æ–™ç‹€æ…‹
                const rawData = ref(null)
                const holdings = ref([])
                const ledger = ref([])
                const history = ref([])
                const messages = ref([])
                const updateTime = ref('-')
                const exchangeRate = ref(0)
                
                // ç¯©é¸ç‹€æ…‹
                const selectedTags = ref([]) // å¤šé¸çµæœ
                const availableTags = ref([])
                const dropdownOpen = ref(false)
                
                // UI ç‹€æ…‹
                const chartType = ref('pnl') 
                const timeRange = ref('1Y')
                const searchQuery = ref('')
                const filterType = ref('ALL')
                const filterYear = ref('ALL')
                const currentPage = ref(1)
                const itemsPerPage = 15

                let myChart = null
                let myPieChart = null

                const formatNumber = (num) => num ? Number(num).toLocaleString('en-US') : '0'

                // --- 1. æ ¸å¿ƒéæ¿¾å™¨ï¼šæ±ºå®šæ‰€æœ‰é¡¯ç¤ºè³‡æ–™ ---
                // ç•¶ selectedTags ç‚ºç©ºæ™‚ï¼Œè¦–ç‚º "ALL"
                const isTagSelected = (tag) => {
                    if (selectedTags.value.length === 0) return true;
                    return selectedTags.value.includes(tag);
                }

                // éæ¿¾æŒå€‰
                const filteredHoldings = computed(() => {
                    return holdings.value.filter(h => isTagSelected(h.tag));
                })

                // éæ¿¾æµæ°´å¸³ (å«æœå°‹)
                const filteredLedger = computed(() => {
                    return ledger.value.filter(tx => {
                        // Tag ç¯©é¸ (OR Logic)
                        if (!isTagSelected(tx.tag)) return false;
                        
                        // æœå°‹èˆ‡ä¸‹æ‹‰
                        const searchContent = (tx.symbol + tx.note + tx.tag).toLowerCase();
                        if (searchQuery.value && !searchContent.includes(searchQuery.value.toLowerCase())) return false;
                        if (filterType.value !== 'ALL') {
                            if (filterType.value === 'DIVIDEND') { if (!tx.type.includes('DIV')) return false; }
                            else { if (tx.type !== filterType.value) return false; }
                        }
                        if (filterYear.value !== 'ALL') { if (!tx.date.startsWith(filterYear.value)) return false; }
                        return true;
                    });
                })

                // --- 2. çµ±è¨ˆè¨ˆç®— ---
                // ä¸Šæ–¹å¡ç‰‡æ•¸æ“š (æ ¹æ“šç¯©é¸çµæœé‡ç®—)
                const computedStats = computed(() => {
                    // å¦‚æœæ˜¯ ALLï¼Œç›´æ¥ç”¨å¾Œç«¯ç®—å¥½çš„ (æ¯”è¼ƒæº–)
                    if (selectedTags.value.length === 0 && rawData.value) {
                        return {
                            total_value: rawData.value.summary.total_value,
                            realized_pnl: rawData.value.summary.realized_pnl,
                            unrealized_pnl: rawData.value.summary.total_value - rawData.value.summary.invested_capital,
                            twr: rawData.value.summary.twr
                        }
                    }
                    
                    // å¤šé¸æ™‚ï¼šæ‰‹å‹•åŠ ç¸½
                    const currentVal = filteredHoldings.value.reduce((sum, h) => sum + h.market_value_twd, 0);
                    // å·²å¯¦ç¾æç›Šï¼šå¾æµæ°´å¸³åŠ ç¸½ (æ³¨æ„ï¼šåªç®—è³£å‡ºç²åˆ©èˆ‡é…æ¯)
                    // é€™é‚Šç°¡å–®ä¼°ç®—ï¼šè³£å‡ºçš„ amount_twd (æ­£æ•¸) - æˆæœ¬ (æ¯”è¼ƒé›£åæ¨ï¼Œæš«ç”¨ ledger note æˆ– type)
                    // å„ªåŒ–ï¼šå¾Œç«¯ ledger å·²æœ‰ realized noteï¼Œæˆ–ç›´æ¥é‡æ–°éæ­·
                    // ç‚ºäº†æ•ˆèƒ½ï¼Œé€™è£¡æš«æ™‚åªè¨ˆç®— "ç›®å‰æŒå€‰çš„æœªå¯¦ç¾" + "æ­·å²ç´€éŒ„çš„å·²å¯¦ç¾"
                    
                    // å¾ Ledger æ’ˆå‡ºå±¬æ–¼é¸å®š Tags çš„ Realized PnL (Sell & Div)
                    // æˆ‘å€‘éœ€è¦ä¾è³´ ledger ä¸­çš„ amount_twdï¼Œä½†è²·å…¥æ˜¯è² çš„ã€‚
                    // æ·¨ç¾é‡‘æµ = Realized PnL + (Sell Cost Basis) - (Buy Cost)
                    // ç°¡å–®åšæ³•ï¼šåªé¡¯ç¤º "æŒæœ‰å¸‚å€¼" å’Œ "æœªå¯¦ç¾æç›Š" æ¯”è¼ƒæº–ç¢ºï¼ŒTWR å‰‡ä¾è³´ Chart é‡ç®—
                    
                    const unrealized = filteredHoldings.value.reduce((sum, h) => sum + h.pnl_twd, 0);
                    
                    // å˜—è©¦å¾ Chart Data çš„æœ€å¾Œä¸€å¤©æ‹¿ TWR (æœ€æº–)
                    let chartTwr = 0;
                    if (recalculatedHistory.value.length > 0) {
                        chartTwr = recalculatedHistory.value[recalculatedHistory.value.length - 1].twr;
                    }

                    // å·²å¯¦ç¾ (å¾ filteredLedger è£¡çš„ DIV å’Œ SELL çš„ç²åˆ©å‚™è¨»æ’ˆ? å¤ªæ…¢)
                    // ç°¡åŒ–ï¼šåªé¡¯ç¤ºå¸‚å€¼èˆ‡ TWR
                    return {
                        total_value: currentVal,
                        realized_pnl: 0, // å¤šé¸æ¨¡å¼ä¸‹è¼ƒé›£ç²¾ç¢ºè¨ˆç®—å·²å¯¦ç¾ï¼Œæš«æ™‚ç•™ 0 æˆ–éš±è—
                        unrealized_pnl: unrealized,
                        twr: chartTwr
                    }
                })

                // æµæ°´å¸³çµ±è¨ˆ
                const ledgerStats = computed(() => {
                    let net = 0;
                    let realized = 0;
                    filteredLedger.value.forEach(tx => {
                        net += tx.amount_twd;
                        // å˜—è©¦è§£æå‚™è¨»ä¸­çš„ç²åˆ©
                        if (tx.type === 'SELL' && tx.note.includes('ç²åˆ©')) {
                            const match = tx.note.match(/ç²åˆ©: ([\d.-]+)/);
                            if (match) realized += parseFloat(match[1]);
                        } else if (tx.type.includes('DIV')) {
                            realized += tx.amount_twd;
                        }
                    });
                    return { netFlow: net, realized: realized };
                })

                // --- 3. æ­·å²æ•¸æ“šé‡ç®— (TWR Engine) ---
                const recalculatedHistory = computed(() => {
                    if (!history.value || history.value.length === 0) return [];
                    
                    // å¦‚æœæ²’é¸ Tagï¼Œç›´æ¥å›å‚³åŸå§‹ç¸½é«” history
                    if (selectedTags.value.length === 0) return history.value;

                    // æœ‰é¸ Tagï¼šæ ¹æ“š history ä¸­çš„ tags snapshot é‡çµ„æ•¸æ“š
                    // çµæ§‹: h.tags = {'AI': {mv: 100, inv: 50}, ...}
                    let prev_mv = 0;
                    let twr_cum = 1.0;
                    
                    return history.value.map(d => {
                        // 1. åŠ ç¸½ç•¶æ—¥ Selected Tags çš„ MV èˆ‡ Invested
                        let day_mv = 0;
                        let day_inv = 0;
                        
                        if (d.tags) {
                            for (const tag of selectedTags.value) {
                                if (d.tags[tag]) {
                                    day_mv += d.tags[tag].mv;
                                    day_inv += d.tags[tag].inv;
                                }
                            }
                        }
                        
                        // 2. è¨ˆç®— TWR
                        // å…¬å¼: (End - Start - Flow) / (Start + Flow)
                        // Flow = ä»Šæ—¥ç´¯è¨ˆæŠ•å…¥ - æ˜¨æ—¥ç´¯è¨ˆæŠ•å…¥
                        // Start = æ˜¨æ—¥å¸‚å€¼
                        const flow = day_inv - (d.prev_inv_ref || 0); // é€™è£¡éœ€è¦ prev_invï¼Œä¸‹é¢è™•ç†
                        
                        let daily_ret = 0;
                        const capital = prev_mv + flow;
                        if (capital > 0) {
                            daily_ret = (day_mv - capital) / capital;
                        }
                        twr_cum *= (1 + daily_ret);

                        // ç´€éŒ„ä»Šæ—¥æ•¸æ“šä¾›æ˜æ—¥ä½¿ç”¨
                        const res = {
                            date: d.date,
                            total_value: day_mv,
                            invested: day_inv,
                            twr: parseFloat(((twr_cum - 1) * 100).toFixed(2)),
                            benchmark_twr: d.benchmark_twr, // SPY ä¸è®Š
                            prev_inv_ref: day_inv // è¼”åŠ©æ¬„ä½
                        };
                        prev_mv = day_mv;
                        return res;
                    });
                })

                // --- UI äº’å‹• ---
                const toggleTag = (tag) => {
                    if (selectedTags.value.includes(tag)) {
                        selectedTags.value = selectedTags.value.filter(t => t !== tag);
                    } else {
                        selectedTags.value.push(tag);
                    }
                    drawChart(); // è³‡æ–™è®Šå‹•é‡ç¹ª
                    drawPieChart();
                }
                const clearTags = () => { selectedTags.value = []; drawChart(); drawPieChart(); dropdownOpen.value = false; }

                // --- åœ–è¡¨ç¹ªè£½ ---
                const drawChart = () => {
                    const ctx = document.getElementById('mainChart').getContext('2d');
                    if (myChart) myChart.destroy();
                    
                    // 1. æ ¹æ“šæ™‚é–“ç¯„åœè£åˆ‡
                    const fullData = recalculatedHistory.value;
                    if (fullData.length === 0) return;

                    const now = new Date();
                    let startDate = new Date('2000-01-01');
                    if (timeRange.value === '1M') startDate.setMonth(now.getMonth() - 1);
                    if (timeRange.value === '6M') startDate.setMonth(now.getMonth() - 6);
                    if (timeRange.value === '1Y') startDate.setFullYear(now.getFullYear() - 1);

                    const dataPoints = fullData.filter(d => new Date(d.date) >= startDate);
                    const labels = dataPoints.map(d => d.date);

                    // 2. æº–å‚™ Dataset
                    let datasets = [];
                    // ç‚ºäº†è®“æ›²ç·šå¾ 0 é–‹å§‹ (è‹¥é ALL)ï¼Œå¯ä»¥åš Normalizeï¼Œé€™è£¡æš«æ™‚ç›´æ¥é¡¯ç¤ºæ•¸å€¼
                    
                    if (chartType.value === 'asset') {
                        datasets = [
                            { label: 'æŒæœ‰å¸‚å€¼', data: dataPoints.map(d => d.total_value), borderColor: '#ff5252', backgroundColor: 'rgba(255,82,82,0.1)', fill: true, borderWidth: 2, pointRadius: 0 },
                            { label: 'æŠ•å…¥æœ¬é‡‘', data: dataPoints.map(d => d.invested), borderColor: '#666', borderDash: [5,5], borderWidth: 1, pointRadius: 0 }
                        ];
                    } else if (chartType.value === 'pnl') {
                        datasets = [{ 
                            label: 'ç´¯è¨ˆæç›Š', 
                            data: dataPoints.map(d => d.total_value - d.invested), 
                            borderColor: '#ffd700', backgroundColor: 'rgba(255,215,0,0.1)', fill: true, borderWidth: 2, pointRadius: 0 
                        }];
                    } else {
                        // TWR
                        datasets = [
                            { label: 'ç­–ç•¥ TWR %', data: dataPoints.map(d => d.twr), borderColor: '#ff5252', borderWidth: 2, pointRadius: 0 },
                            { label: 'SPY %', data: dataPoints.map(d => d.benchmark_twr), borderColor: '#40a9ff', borderWidth: 1, pointRadius: 0 }
                        ];
                    }

                    myChart = new Chart(ctx, {
                        type: 'line',
                        data: { labels, datasets },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            interaction: { mode: 'index', intersect: false },
                            plugins: { legend: { labels: { color: '#ccc' } }, tooltip: { backgroundColor: '#1f1f23' } },
                            scales: { x: { grid: { color: '#333' } }, y: { grid: { color: '#333' }, position: 'right' } }
                        }
                    });
                }

                const drawPieChart = () => {
                    const ctx = document.getElementById('pieChart').getContext('2d');
                    if (myPieChart) myPieChart.destroy();
                    
                    // Pie Chart æ°¸é é¡¯ç¤º "Filtered Holdings" çš„åˆ†ä½ˆ
                    // å¦‚æœå·²ç¶“é¸äº† AIï¼ŒPie Chart å°±é¡¯ç¤º AI è£¡é¢çš„è‚¡ç¥¨ä½”æ¯”? 
                    // æˆ–è€…: é¡¯ç¤º "Tag åˆ†ä½ˆ"? ä½†å¦‚æœå·²ç¶“ Filter Tagï¼Œåªæœƒå‰©ä¸‹é¸ä¸­çš„ Tagã€‚
                    // èª¿æ•´ç­–ç•¥ï¼šPie Chart é¡¯ç¤º "å€‹è‚¡ (Symbol)" çš„ä½”æ¯” (åœ¨ç›®å‰ç¯©é¸ç¯„åœå…§)
                    
                    // çµ±è¨ˆç›®å‰ç¯©é¸ç¯„åœå…§çš„ Symbol å¸‚å€¼
                    const dist = {};
                    filteredHoldings.value.forEach(h => {
                        dist[h.symbol] = h.market_value_twd;
                    });
                    
                    const labels = Object.keys(dist);
                    const data = Object.values(dist);
                    const colors = ['#ff5252', '#40a9ff', '#ffd700', '#69c0ff', '#ff85c0', '#95de64', '#5cdbd3'];

                    myPieChart = new Chart(ctx, {
                        type: 'doughnut',
                        data: { labels, datasets: [{ data, backgroundColor: colors, borderWidth: 0 }] },
                        options: { 
                            responsive: true, maintainAspectRatio: false, 
                            plugins: { legend: { position: 'right', labels: { color: '#ccc', boxWidth: 10 } } } 
                        }
                    });
                }

                // --- åˆå§‹åŒ– ---
                const fetchData = async () => {
                    try {
                        const res = await fetch('data.json?t=' + new Date().getTime())
                        const data = await res.json()
                        rawData.value = data;
                        holdings.value = data.holdings;
                        ledger.value = data.ledger;
                        history.value = data.history; // é€™è£¡å«æœ‰ tags breakdown
                        messages.value = data.messages || [];
                        updateTime.value = data.updated_at;
                        exchangeRate.value = data.exchange_rate;

                        // æå–æ‰€æœ‰å¯ç”¨ Tags
                        const tagsSet = new Set();
                        data.holdings.forEach(h => tagsSet.add(h.tag));
                        data.ledger.forEach(tx => tagsSet.add(tx.tag));
                        availableTags.value = Array.from(tagsSet).filter(t => t && t !== 'Other');

                        nextTick(() => {
                            drawChart();
                            drawPieChart();
                        });
                    } catch (e) { console.error(e) }
                }

                const availableYears = computed(() => {
                    const years = new Set(ledger.value.map(tx => tx.date.substring(0, 4)));
                    return Array.from(years).sort().reverse();
                })
                const paginatedLedger = computed(() => {
                    const start = (currentPage.value - 1) * itemsPerPage;
                    return filteredLedger.value.slice(start, start + itemsPerPage);
                })
                const totalPages = computed(() => Math.ceil(filteredLedger.value.length / itemsPerPage) || 1)
                const prevPage = () => { if (currentPage.value > 1) currentPage.value--; }
                const nextPage = () => { if (currentPage.value < totalPages.value) currentPage.value++; }

                const switchChartType = (t) => { chartType.value = t; drawChart(); }
                const switchTimeRange = (r) => { timeRange.value = r; drawChart(); }

                onMounted(() => fetchData());

                return {
                    updateTime, exchangeRate, messages,
                    selectedTags, availableTags, dropdownOpen, toggleTag, clearTags,
                    computedStats, ledgerStats,
                    filteredHoldings, paginatedLedger,
                    searchQuery, filterType, filterYear, availableYears,
                    currentPage, totalPages, prevPage, nextPage,
                    chartType, switchChartType, timeRange, switchTimeRange,
                    formatNumber
                }
            }
        }).mount('#app')
    </script>
</body>
</html>
