<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æˆ‘çš„æŠ•è³‡çµ„åˆ (IBç‰ˆ)</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* --- åŸºç¤è¨­å®š (æ·±è‰²æ¨¡å¼) --- */
        body { 
            background-color: #101014; 
            color: #e0e0e0; 
            margin: 0; 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            -webkit-font-smoothing: antialiased;
            padding-bottom: 60px;
        }

        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            padding: 20px; 
        }

        /* --- é ‚éƒ¨æ¨™é¡Œ --- */
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 24px; 
            padding-bottom: 10px;
            border-bottom: 1px solid #2d2d30;
        }
        .header h2 { margin: 0; font-size: 1.5rem; color: #fff; }
        .update-time { color: #666; font-size: 0.9rem; }

        /* --- ç¶²æ ¼ä½ˆå±€ (å¡ç‰‡å€) --- */
        .grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); 
            gap: 16px; 
            margin-bottom: 30px; 
        }

        /* --- å¡ç‰‡æ¨£å¼ --- */
        .card { 
            background: #18181c; 
            padding: 24px; 
            border-radius: 12px; 
            border: 1px solid #2d2d30; 
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .card-label { color: #9aa5b1; font-size: 0.9rem; margin-bottom: 8px; font-weight: 500; }
        .card-value { font-size: 1.8rem; font-weight: 700; letter-spacing: 0.5px; }
        .card-sub { font-size: 0.9rem; margin-top: 8px; font-weight: 500; }

        /* --- é¡è‰²å®šç¾© (å°è‚¡ï¼šç´…æ¼²ç¶ è·Œ) --- */
        .red { color: #ff5252; }   /* ç²åˆ© */
        .green { color: #4caf50; } /* è™§æ */
        .blue { color: #40a9ff; }  /* è‚¡æ¯/ä¸­æ€§ */
        .gray { color: #666; }

        /* --- åœ–è¡¨å€å¡Š --- */
        .chart-section {
            background: #18181c;
            padding: 20px;
            border-radius: 12px;
            border: 1px solid #2d2d30;
            margin-bottom: 30px;
        }
        .chart-container { 
            position: relative; 
            height: 400px; 
            width: 100%; 
        }

        /* --- è¡¨æ ¼å€å¡Š --- */
        .table-card {
            background: #18181c;
            border-radius: 12px;
            border: 1px solid #2d2d30;
            margin-bottom: 30px;
            overflow: hidden; /* åœ“è§’ */
        }
        .table-header {
            padding: 20px;
            border-bottom: 1px solid #2d2d30;
            background: #1f1f23;
        }
        .table-header h3 { margin: 0; font-size: 1.1rem; color: #fff; }

        .table-responsive { overflow-x: auto; }
        
        table { 
            width: 100%; 
            border-collapse: collapse; 
            font-size: 0.95rem; 
            white-space: nowrap; /* é˜²æ­¢æ‰‹æ©Ÿç‰ˆæ›è¡Œå¤ªé†œ */
        }
        th { 
            text-align: right; /* æ•¸å­—é å³ */
            color: #888; 
            padding: 14px 16px; 
            border-bottom: 1px solid #333; 
            font-weight: 500; 
            text-transform: uppercase;
            font-size: 0.8rem;
            letter-spacing: 0.5px;
        }
        /* ç¬¬ä¸€æ¬„ä»£ç¢¼é å·¦ */
        th:first-child, td:first-child { text-align: left; } 
        /* ä¸­é–“æ–‡å­—æ¬„ä½é å·¦ (å¦‚æ—¥æœŸ) */
        th:nth-child(2), td:nth-child(2), 
        th:nth-child(3), td:nth-child(3) { text-align: left; }

        td { 
            padding: 14px 16px; 
            border-bottom: 1px solid #2d2d30; 
            text-align: right;
        }
        tr:last-child td { border-bottom: none; }
        tr:hover { background-color: #232328; }

        /* æ¨™ç±¤æ¨£å¼ */
        .symbol-tag { 
            padding: 4px 10px; 
            background: #2d2d30; 
            border-radius: 6px; 
            font-weight: 700; 
            color: #fff;
            letter-spacing: 0.5px;
        }
        .type-tag {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
            margin-right: 8px;
            display: inline-block;
            min-width: 50px;
            text-align: center;
        }
        .tag-trade { background: #2d2d30; color: #aaa; border: 1px solid #444; }
        .tag-div { background: #1a3a50; color: #40a9ff; border: 1px solid #205070; }

        /* é å°¾é€£çµ */
        .footer { text-align: center; margin-top: 40px; }
        .footer a { 
            color: #40a9ff; 
            text-decoration: none; 
            font-size: 0.9rem; 
            opacity: 0.7; 
            transition: opacity 0.2s;
        }
        .footer a:hover { opacity: 1; }

        /* RWD èª¿æ•´ */
        @media (max-width: 600px) {
            .card-value { font-size: 1.5rem; }
            .container { padding: 10px; }
            th, td { padding: 10px; font-size: 0.85rem; }
        }
    </style>
</head>
<body>
    <div id="app" class="container">
        <div class="header">
            <div>
                <h2>æŠ•è³‡çµ„åˆçœ‹æ¿</h2>
                <div style="font-size:0.8rem; color:#888; margin-top:4px;">IB æ ¼å¼ â€¢ æ‹†è‚¡è‡ªå‹•èª¿æ•´ â€¢ æ·¨è³‡é‡‘æµæ³•</div>
            </div>
            <span class="update-time">æ›´æ–°: {{ updateTime }}</span>
        </div>

        <div class="grid">
            <div class="card">
                <div class="card-label">ç¸½æŒå€‰å¸‚å€¼ (Market Value)</div>
                <div class="card-value">${{ formatNumber(summary.total_value) }}</div>
            </div>

            <div class="card">
                <div class="card-label">æ·¨æŠ•å…¥æœ¬é‡‘ (Net Invested)</div>
                <div class="card-value">${{ formatNumber(summary.invested_capital) }}</div>
                <div class="card-sub gray">è²·å…¥ç¸½é¡ - (è³£å‡º + è‚¡æ¯)</div>
            </div>

            <div class="card">
                <div class="card-label">ç¸½å¸³é¢æç›Š (Total P&L)</div>
                <div class="card-value" :class="summary.total_pnl >= 0 ? 'red' : 'green'">
                    {{ summary.total_pnl >= 0 ? '+' : '' }}{{ formatNumber(summary.total_pnl) }}
                </div>
                <div class="card-sub" :class="summary.pnl_percent >= 0 ? 'red' : 'green'">
                    {{ summary.pnl_percent }}% (ç¸½å ±é…¬ç‡)
                </div>
            </div>

            <div class="card">
                <div class="card-label">å·²å¯¦ç¾ç²åˆ© (Realized)</div>
                <div class="card-value" :class="summary.realized_pnl >= 0 ? 'red' : 'green'">
                    {{ formatNumber(summary.realized_pnl) }}
                </div>
                <div class="card-sub blue">åŒ…å«äº¤æ˜“ç²åˆ©èˆ‡è‚¡æ¯</div>
            </div>
        </div>

        <div class="chart-section">
            <h3 style="margin-top:0; margin-bottom:20px; color:#ddd; font-size:1.1rem;">è³‡ç”¢æˆé•· vs æœ¬é‡‘æŠ•å…¥</h3>
            <div class="chart-container">
                <canvas id="mainChart"></canvas>
            </div>
        </div>

        <div class="table-card">
            <div class="table-header">
                <h3>ç›®å‰æŒå€‰ (Open Positions)</h3>
            </div>
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>ä»£ç¢¼</th>
                            <th>æŒæœ‰è‚¡æ•¸</th>
                            <th>æˆæœ¬å‡åƒ¹</th>
                            <th>ç¾åƒ¹</th>
                            <th>å¸‚å€¼</th>
                            <th>æœªå¯¦ç¾æç›Š</th>
                            <th>å ±é…¬ç‡ %</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="s in holdings" :key="s.symbol">
                            <td><span class="symbol-tag">{{ s.symbol }}</span></td>
                            <td>{{ s.qty }}</td>
                            <td style="color:#aaa">${{ s.avg_price }}</td>
                            <td>${{ s.current_price }}</td>
                            <td style="font-weight:bold">${{ formatNumber(s.market_value) }}</td>
                            <td :class="s.pnl >= 0 ? 'red' : 'green'">
                                {{ s.pnl >= 0 ? '+' : '' }}{{ formatNumber(s.pnl) }}
                            </td>
                            <td :class="s.pnl >= 0 ? 'red' : 'green'">
                                {{ s.pnl_percent }}%
                            </td>
                        </tr>
                        <tr v-if="holdings.length === 0">
                            <td colspan="7" style="text-align:center; padding:30px; color:#666;">
                                ç›®å‰æ²’æœ‰æŒå€‰
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="table-card">
            <div class="table-header">
                <h3>æ­·å²ç´€éŒ„ (Closed Trades & Dividends)</h3>
            </div>
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>ä»£ç¢¼</th>
                            <th>æ—¥æœŸ</th>
                            <th>è²·å…¥æˆæœ¬</th>
                            <th>è³£å‡º/è‚¡æ¯</th>
                            <th>æ•¸é‡</th>
                            <th>æ·¨ç²åˆ© (å«ç¨…è²»)</th>
                            <th>%</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="d in closedPositions" :key="d.symbol + d.close_date + d.type + d.pnl">
                            <td>
                                <span v-if="d.type === 'DIVIDEND'" class="type-tag tag-div">è‚¡æ¯</span>
                                <span v-else class="type-tag tag-trade">äº¤æ˜“</span>
                                <span class="symbol-tag">{{ d.symbol }}</span>
                            </td>
                            <td style="color:#aaa">{{ d.close_date }}</td>
                            
                            <td>{{ d.buy_price > 0 ? '$' + d.buy_price : '-' }}</td>
                            
                            <td>{{ d.sell_price > 0 ? '$' + d.sell_price : '-' }}</td>
                            
                            <td>{{ d.qty > 0 ? d.qty : '-' }}</td>
                            
                            <td :class="getPnlColor(d)" style="font-weight:bold">
                                {{ d.pnl >= 0 ? '+' : '' }}{{ formatNumber(d.pnl) }}
                            </td>
                            
                            <td :class="getPnlColor(d)">
                                {{ d.type === 'TRADE' ? d.pnl_percent + '%' : '-' }}
                            </td>
                        </tr>
                        <tr v-if="closedPositions.length === 0">
                            <td colspan="7" style="text-align:center; padding:30px; color:#666;">
                                å°šç„¡å·²å¯¦ç¾ç´€éŒ„
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="footer">
            <a href="https://docs.google.com/spreadsheets" target="_blank">
                ğŸ“ ç·¨è¼¯ Google Sheet äº¤æ˜“ç´€éŒ„
            </a>
        </div>
    </div>

    <script>
        const { createApp, ref, onMounted, nextTick } = Vue
        
        createApp({
            setup() {
                // ç‹€æ…‹è®Šæ•¸
                const summary = ref({
                    total_value: 0,
                    invested_capital: 0,
                    total_pnl: 0,
                    pnl_percent: 0,
                    realized_pnl: 0
                })
                const updateTime = ref('è¼‰å…¥ä¸­...')
                const holdings = ref([])
                const closedPositions = ref([])
                let myChart = null

                // æ•¸å­—æ ¼å¼åŒ– (åŠ åƒåˆ†ä½)
                const formatNumber = (num) => {
                    if (num === undefined || num === null) return '0.00'
                    return Number(num).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })
                }

                // åˆ¤æ–·é¡è‰² (äº¤æ˜“ç”¨ç´…ç¶ ï¼Œè‚¡æ¯ç”¨è—è‰²)
                const getPnlColor = (deal) => {
                    if (deal.type === 'DIVIDEND') return 'blue'
                    return deal.pnl >= 0 ? 'red' : 'green'
                }

                // ç¹ªè£½åœ–è¡¨
                const renderChart = (history) => {
                    const ctx = document.getElementById('mainChart').getContext('2d');
                    if (myChart) myChart.destroy();

                    // æ¼¸å±¤èƒŒæ™¯è¨­å®š
                    const gradient = ctx.createLinearGradient(0, 0, 0, 400);
                    gradient.addColorStop(0, 'rgba(255, 82, 82, 0.2)'); // ç´…è‰²æ¼¸å±¤
                    gradient.addColorStop(1, 'rgba(255, 82, 82, 0)');

                    myChart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: history.map(d => d.date),
                            datasets: [
                                {
                                    label: 'ç¸½æŒå€‰å¸‚å€¼ (Net Worth)',
                                    data: history.map(d => d.total_value),
                                    borderColor: '#ff5252', // ç´…è‰²ä¸»ç·š
                                    backgroundColor: gradient,
                                    borderWidth: 2,
                                    pointRadius: 0, // ä¸é¡¯ç¤ºé»ï¼Œåªé¡¯ç¤ºç·š
                                    pointHoverRadius: 6,
                                    fill: true,
                                    tension: 0.4 // æ›²ç·šå¹³æ»‘åº¦
                                },
                                {
                                    label: 'æ·¨æŠ•å…¥æœ¬é‡‘ (Invested)',
                                    data: history.map(d => d.invested),
                                    borderColor: '#666', // ç°è‰²è™›ç·š
                                    borderWidth: 2,
                                    borderDash: [5, 5],
                                    fill: false,
                                    pointRadius: 0,
                                    pointHoverRadius: 0,
                                    tension: 0
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: { mode: 'index', intersect: false },
                            plugins: {
                                legend: { 
                                    labels: { color: '#ccc', font: { size: 12 } },
                                    align: 'end'
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(24, 24, 28, 0.9)',
                                    titleColor: '#888',
                                    bodyColor: '#fff',
                                    borderColor: '#333',
                                    borderWidth: 1,
                                    padding: 10,
                                    callbacks: {
                                        label: function(context) {
                                            return context.dataset.label + ': $' + context.parsed.y.toLocaleString();
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: { 
                                    grid: { color: '#2d2d30' }, 
                                    ticks: { color: '#666', maxTicksLimit: 8 } 
                                },
                                y: { 
                                    position: 'right', // Yè»¸åœ¨å³å´æ¯”è¼ƒå°ˆæ¥­
                                    grid: { color: '#2d2d30' }, 
                                    ticks: { color: '#666' } 
                                }
                            }
                        }
                    });
                }

                // æŠ“å–è³‡æ–™
                const fetchData = async () => {
                    try {
                        // åŠ æ™‚é–“æˆ³åƒæ•¸é¿å…ç€è¦½å™¨å¿«å–èˆŠè³‡æ–™
                        const res = await fetch('data.json?t=' + new Date().getTime())
                        if (!res.ok) throw new Error("ç„¡æ³•è®€å– data.json")
                        
                        const data = await res.json()
                        
                        summary.value = data.summary
                        updateTime.value = data.updated_at
                        holdings.value = data.holdings
                        closedPositions.value = data.closed_positions

                        // ç­‰å¾… DOM æ›´æ–°å¾Œç•«åœ–
                        nextTick(() => {
                            if (data.history && data.history.length > 0) {
                                renderChart(data.history)
                            }
                        })
                    } catch (e) {
                        console.error("Loading error:", e)
                        updateTime.value = "è®€å–å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦"
                    }
                }

                onMounted(fetchData)

                return { 
                    summary, 
                    updateTime, 
                    holdings, 
                    closedPositions, 
                    formatNumber,
                    getPnlColor 
                }
            }
        }).mount('#app')
    </script>
</body>
</html>
