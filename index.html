<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SaaS 交易管理系統 (Pro Plus)</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <style>
        :root { 
            --bg: #101014; --card-bg: #18181c; --border: #2d2d30; 
            --primary: #40a9ff; --text: #e0e0e0; --text-muted: #888;
            --green: #4caf50; --red: #ff5252; --yellow: #ffc107; 
        }
        
        body { background-color: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; padding-bottom: 60px; }
        
        /* 基礎元件 */
        .card { background: var(--card-bg); padding: 20px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 20px; }
        .flex-row { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        .btn { padding: 6px 12px; border-radius: 6px; border: none; cursor: pointer; font-size: 0.9rem; transition: opacity 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { opacity: 0.9; }
        .btn-danger { background: var(--red); color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
        .btn-outline:hover, .btn-outline.active { background: #333; color: white; border-color: var(--text); }
        .btn-sm { padding: 4px 8px; font-size: 0.8rem; }
        
        .text-green { color: var(--green); }
        .text-red { color: var(--red); }
        
        /* 登入遮罩 */
        .login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; justify-content: center; align-items: center; z-index: 1000; flex-direction: column; gap: 20px; }
        
        /* Header 數據塊 */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .stat-card { background: var(--card-bg); padding: 15px; border-radius: 10px; border: 1px solid var(--border); text-align: center; }
        .stat-label { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 8px; }
        .stat-value { font-size: 1.4rem; font-weight: bold; }
        .stat-sub { font-size: 0.9rem; margin-top: 5px; }

        /* 表單樣式 (Grid 優化) */
        .editor-form { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); 
            gap: 12px; 
            align-items: end; 
            background: #222; 
            padding: 20px; 
            border-radius: 8px; 
            border: 1px solid #444; 
            margin-bottom: 20px; 
        }
        .form-group { display: flex; flex-direction: column; gap: 6px; }
        .form-group label { font-size: 0.8rem; color: #aaa; white-space: nowrap; }
        .form-group input, .form-group select { background: #111; border: 1px solid #333; color: white; padding: 8px; border-radius: 4px; font-size: 0.95rem; width: 100%; box-sizing: border-box; }
        .form-group input:focus { border-color: var(--primary); outline: none; }
        
        /* 圖表區 */
        .chart-section { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 20px; }
        @media (max-width: 768px) { .chart-section { grid-template-columns: 1fr; } }
        
        .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; flex-wrap: wrap; gap: 10px; }
        .chart-controls { display: flex; gap: 5px; background: #222; padding: 4px; border-radius: 8px; }
        .chart-controls button { background: transparent; border: none; color: #888; padding: 4px 12px; font-size: 0.85rem; cursor: pointer; border-radius: 6px; }
        .chart-controls button.active { background: #444; color: #fff; font-weight: bold; }
        .date-picker-group { display: flex; gap: 5px; align-items: center; }
        .date-picker-group input { background: #222; border: 1px solid #444; color: #ccc; padding: 4px; border-radius: 4px; font-size: 0.8rem; }
        
        .chart-container { position: relative; height: 350px; width: 100%; }
        
        /* 表格 */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { text-align: right; padding: 12px 8px; border-bottom: 1px solid var(--border); }
        th:first-child, td:first-child { text-align: left; }
        th { color: var(--text-muted); font-weight: normal; font-size: 0.9rem; }
        .tag { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; background: #333; color: #ccc; }
        
        /* Header Bar */
        .header-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 15px; }
        .user-info { display: flex; align-items: center; gap: 10px; font-size: 0.9rem; }
        .avatar { width: 32px; height: 32px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; }
    </style>
</head>
<body>
    <div id="app" class="container">
        <div v-if="!userToken" class="login-overlay">
            <h2 style="color:white">資產管理系統 Login</h2>
            <div id="g_id_onload" :data-client_id="googleClientId" data-callback="handleCredentialResponse" data-auto_select="false"></div>
            <div class="g_id_signin" data-type="standard" data-size="large" data-theme="filled_black"></div>
        </div>

        <div v-else>
            <div class="header-bar">
                <div>
                    <h2 style="margin:0">Dashboard <span style="font-size:0.8rem; color:#666">v0.01 Pro Plus</span></h2>
                    <small style="color:var(--text-muted)">最後更新: {{ lastUpdateTime }}</small>
                </div>
                <div class="user-info">
                    <div class="avatar">{{ userName.charAt(0).toUpperCase() }}</div>
                    <span>{{ userName }}</span>
                    <button @click="logout" class="btn btn-outline btn-sm">登出</button>
                    <button @click="triggerGitHubUpdate" class="btn btn-primary btn-sm" :disabled="isUpdating">
                        {{ isUpdating ? '更新中...' : '刷新報價' }}
                    </button>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">總淨值 (TWD)</div>
                    <div class="stat-value" style="color:var(--primary)">{{ formatNumber(localStats.total_value) }}</div>
                    <div class="stat-sub" style="color:#888">成本: {{ formatNumber(localStats.invested_capital) }}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">未實踐損益</div>
                    <div class="stat-value" :class="unrealizedPnL >= 0 ? 'text-green' : 'text-red'">
                        {{ unrealizedPnL >= 0 ? '+' : '' }}{{ formatNumber(unrealizedPnL) }}
                    </div>
                    <div class="stat-sub">
                        {{ localStats.invested_capital ? ((unrealizedPnL/localStats.invested_capital)*100).toFixed(2) : 0 }}%
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">今日損益 (估計)</div>
                    <div class="stat-value" :class="dailyPnL >= 0 ? 'text-green' : 'text-red'">
                        {{ dailyPnL >= 0 ? '+' : '' }}{{ formatNumber(dailyPnL) }}
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">TWR 總報酬率</div>
                    <div class="stat-value" :class="localStats.twr >= 0 ? 'text-green' : 'text-red'">
                        {{ localStats.twr }}%
                    </div>
                    <div class="stat-sub" style="color:var(--yellow)">SPY: {{ localStats.benchmark_twr || '-' }}%</div>
                </div>
            </div>

            <div class="chart-section" v-show="!calculating">
                <div class="card">
                    <div class="chart-header">
                        <div class="chart-controls">
                            <button @click="switchChartType('twr')" :class="{active: chartType==='twr'}">績效 %</button>
                            <button @click="switchChartType('value')" :class="{active: chartType==='value'}">淨值</button>
                            <button @click="switchChartType('pnl')" :class="{active: chartType==='pnl'}">日損益</button>
                        </div>
                        <div class="chart-controls">
                            <button v-for="range in ['1M','3M','6M','YTD','1Y','ALL','CUSTOM']" 
                                    :key="range" 
                                    @click="switchTimeRange(range)" 
                                    :class="{active: timeRange===range}">
                                {{ range === 'CUSTOM' ? '自訂' : range }}
                            </button>
                        </div>
                    </div>
                    
                    <div class="chart-header" v-if="timeRange === 'CUSTOM'" style="justify-content: flex-end; margin-top:-10px;">
                        <div class="date-picker-group">
                            <label>From:</label><input type="date" v-model="customStart" @change="drawChart">
                            <label>To:</label><input type="date" v-model="customEnd" @change="drawChart">
                        </div>
                    </div>

                    <div class="chart-container">
                        <canvas id="mainChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <div class="chart-header">
                        <div class="chart-controls">
                            <button @click="switchPieType('asset')" :class="{active: pieType==='asset'}">資產</button>
                            <button @click="switchPieType('currency')" :class="{active: pieType==='currency'}">幣別</button>
                            <button @click="switchPieType('strategy')" :class="{active: pieType==='strategy'}">策略</button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="pieChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="flex-row" style="margin-bottom:15px">
                    <h3>{{ isEditing ? '修改交易紀錄' : '新增交易紀錄' }}</h3>
                    <button v-if="isEditing" @click="resetForm" class="btn btn-outline btn-sm">取消修改</button>
                </div>
                <div class="editor-form">
                    <div class="form-group"><label>日期</label><input type="date" v-model="form.txn_date"></div>
                    <div class="form-group"><label>代碼</label><input type="text" v-model="form.symbol" placeholder="e.g. NVDA"></div>
                    <div class="form-group"><label>類型</label>
                        <select v-model="form.txn_type">
                            <option value="BUY">買入</option>
                            <option value="SELL">賣出</option>
                            <option value="DIV">股息</option>
                        </select>
                    </div>
                    <div class="form-group"><label>股數</label>
                        <input type="number" step="any" v-model="form.qty" @input="calcTotal">
                    </div>
                    <div class="form-group"><label>單價 (平均成本)</label>
                        <input type="number" step="any" v-model="form.price" @input="calcTotal">
                    </div>
                    <div class="form-group"><label>手續費</label>
                        <input type="number" step="any" v-model="form.fee" @input="calcTotal">
                    </div>
                    <div class="form-group"><label>預扣稅</label>
                        <input type="number" step="any" v-model="form.tax" @input="calcTotal">
                    </div>
                    <div class="form-group"><label>交易總額 (Total)</label>
                        <input type="number" step="any" v-model="form.total_amount" @input="calcPrice" placeholder="含費稅">
                    </div>
                    
                    <div class="form-group"><label>&nbsp;</label>
                        <button class="btn btn-primary" @click="submitRecord" :disabled="submitting" style="width:100%">
                            {{ submitting ? '...' : (isEditing ? '送出' : '新增') }}
                        </button>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>持倉明細 (Live)</h3>
                <div v-if="calculating" style="text-align:center; padding:20px; color:#888">載入中...</div>
                <table v-else>
                    <thead>
                        <tr>
                            <th>代碼</th><th>標籤</th><th>股數</th><th>平均成本</th><th>現價</th><th>市值 (TWD)</th><th>報酬率</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="h in combinedHoldings" :key="h.symbol">
                            <td><strong>{{ h.symbol }}</strong></td>
                            <td><span class="tag">{{ h.tag }}</span></td>
                            <td>{{ formatNumber(h.qty, 1) }}</td>
                            <td>{{ calculateAvgCost(h) }}</td>
                            <td>{{ h.current_price_origin }}</td>
                            <td>{{ formatNumber(h.market_value_twd) }}</td>
                            <td :class="h.pnl_percent >= 0 ? 'text-green' : 'text-red'">{{ h.pnl_percent }}%</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="card" style="margin-top: 20px;">
                <div class="flex-row">
                    <h3>最近交易紀錄 (API)</h3>
                    <button class="btn btn-outline btn-sm" @click="fetchRecords">重新整理</button>
                </div>
                <table>
                    <thead><tr><th>日期</th><th>代碼</th><th>動作</th><th>股數</th><th>價格</th><th>操作</th></tr></thead>
                    <tbody>
                        <tr v-for="r in records" :key="r.id">
                            <td>{{ r.txn_date }}</td><td>{{ r.symbol }}</td>
                            <td><span :class="r.txn_type === 'BUY' ? 'text-red' : 'text-green'">{{ r.txn_type }}</span></td>
                            <td>{{ r.qty }}</td><td>{{ r.price }}</td>
                            <td>
                                <button class="btn btn-outline btn-sm" @click="editRecord(r)">修</button>
                                <button class="btn btn-danger btn-sm" @click="deleteRecord(r.id)" style="margin-left:5px">刪</button>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, onMounted, computed, nextTick, reactive, watch } = Vue;
        
        const WORKER_BASE_URL = "https://journal-backend.chired.workers.dev";
        const CLIENT_ID = "951186116587-0ehsmkvlu3uivduc7kjn1jpp9ga7810i.apps.googleusercontent.com";

        createApp({
            setup() {
                const userToken = ref(localStorage.getItem('token') || '');
                const userName = ref(localStorage.getItem('name') || '');
                
                const localStats = ref({});
                const fullChartData = ref([]);
                const combinedHoldings = ref([]);
                const records = ref([]);
                const lastUpdateTime = ref('');
                const exchangeRate = ref(32.0); // 預設匯率
                const calculating = ref(true);
                const isUpdating = ref(false);
                const submitting = ref(false);

                // 表單
                const isEditing = ref(false);
                const editingId = ref(null);
                const form = reactive({ 
                    txn_date: new Date().toISOString().split('T')[0], 
                    symbol: '', txn_type: 'BUY', 
                    qty: 0, price: 0, fee: 0, tax: 0, total_amount: 0 
                });

                // 圖表
                const timeRange = ref('1Y');
                const customStart = ref('');
                const customEnd = ref('');
                const chartType = ref('twr');
                const pieType = ref('asset');
                let mainChartInstance = null;
                let pieChartInstance = null;

                const unrealizedPnL = computed(() => (localStats.value.total_value || 0) - (localStats.value.invested_capital || 0));
                
                const dailyPnL = computed(() => {
                    if (fullChartData.value.length < 2) return 0;
                    const last = fullChartData.value[fullChartData.value.length - 1];
                    const prev = fullChartData.value[fullChartData.value.length - 2];
                    return (last.total_value - last.invested) - (prev.total_value - prev.invested);
                });

                // --- 1. 登入 ---
                const logout = () => { localStorage.removeItem('token'); localStorage.removeItem('name'); location.reload(); };
                const handleCredentialResponse = async (res) => {
                    try {
                        const r = await fetch(`${WORKER_BASE_URL}/auth/google`, { method: "POST", body: JSON.stringify({ id_token: res.credential }) });
                        const d = await r.json();
                        if (d.success) { 
                            userToken.value = d.token; userName.value = d.user; 
                            localStorage.setItem('token', d.token); localStorage.setItem('name', d.user);
                            fetchRecords(); loadPortfolioData();
                        }
                    } catch(e) { console.error(e); }
                };

                // --- 2. 表單連動 (Total = Qty*Price + Fee + Tax) ---
                const calcTotal = () => {
                    const base = (parseFloat(form.qty) || 0) * (parseFloat(form.price) || 0);
                    const fee = parseFloat(form.fee) || 0;
                    const tax = parseFloat(form.tax) || 0;
                    form.total_amount = parseFloat((base + fee + tax).toFixed(2));
                };
                const calcPrice = () => {
                    // Reverse: Price = (Total - Fee - Tax) / Qty
                    const qty = parseFloat(form.qty) || 0;
                    const fee = parseFloat(form.fee) || 0;
                    const tax = parseFloat(form.tax) || 0;
                    const total = parseFloat(form.total_amount) || 0;
                    if (qty > 0) {
                        form.price = parseFloat(((total - fee - tax) / qty).toFixed(4));
                    }
                };

                // --- 3. 持倉平均成本計算 ---
                const calculateAvgCost = (h) => {
                    if (!h.qty) return 0;
                    // TWD Cost = MarketVal_TWD - PnL_TWD
                    const costTwd = h.market_value_twd - h.pnl_twd;
                    // Estimated USD Cost = CostTwd / ExchangeRate / Qty
                    const ex = exchangeRate.value || 32;
                    const avg = (costTwd / ex) / h.qty;
                    return avg.toFixed(2);
                };

                // --- 4. API & CRUD ---
                const fetchRecords = async () => {
                    if (!userToken.value) return;
                    const r = await fetch(`${WORKER_BASE_URL}/api/records`, { headers: { 'Authorization': `Bearer ${userToken.value}` } });
                    const j = await r.json();
                    if (j.success) records.value = j.data;
                };

                const submitRecord = async () => {
                    if (!userToken.value || !form.symbol) return;
                    submitting.value = true;
                    try {
                        const method = isEditing.value ? "PUT" : "POST";
                        const payload = { ...form }; if (isEditing.value) payload.id = editingId.value;
                        const r = await fetch(`${WORKER_BASE_URL}/api/records`, { method, headers: { 'Authorization': `Bearer ${userToken.value}`, 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                        const j = await r.json();
                        if (j.success) { alert(isEditing.value?"修改成功":"新增成功"); resetForm(); fetchRecords(); }
                        else alert(j.error);
                    } catch(e) { alert("Error"); } finally { submitting.value = false; }
                };

                const deleteRecord = async (id) => {
                    if(!confirm("確定刪除？")) return;
                    await fetch(`${WORKER_BASE_URL}/api/records`, { method: "DELETE", headers: { 'Authorization': `Bearer ${userToken.value}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ id }) });
                    fetchRecords();
                };

                const editRecord = (r) => { 
                    isEditing.value = true; editingId.value = r.id; 
                    Object.assign(form, r);
                    form.fee = r.fee || 0;
                    form.tax = r.tax || 0; // 假設 API 有回傳 tax，若無則為 0
                    calcTotal(); // 重算總額顯示
                };
                const resetForm = () => { 
                    isEditing.value = false; editingId.value = null; 
                    form.symbol = ''; form.qty = 0; form.price = 0; form.fee = 0; form.tax = 0; form.total_amount = 0; 
                };

                const triggerGitHubUpdate = async () => {
                    if(!confirm("觸發更新？")) return; isUpdating.value = true;
                    await fetch(`${WORKER_BASE_URL}/api/trigger-update`, { method: "POST", headers: { 'Authorization': `Bearer ${userToken.value}` } });
                    isUpdating.value = false; alert("已觸發，請稍待片刻。");
                };

                // --- 5. 圖表邏輯 (純折線版) ---
                const loadPortfolioData = async () => {
                    calculating.value = true;
                    try {
                        const res = await fetch(`data.json?t=${new Date().getTime()}`);
                        const data = await res.json();
                        localStats.value = data.summary;
                        combinedHoldings.value = data.holdings;
                        fullChartData.value = data.history || [];
                        lastUpdateTime.value = data.updated_at;
                        exchangeRate.value = data.exchange_rate || 32.0;

                        const today = new Date();
                        customEnd.value = today.toISOString().split('T')[0];
                        today.setFullYear(today.getFullYear() - 1);
                        customStart.value = today.toISOString().split('T')[0];

                        nextTick(() => { drawChart(); drawPieChart(); });
                    } catch (e) { console.error(e); } finally { calculating.value = false; }
                };

                const getProcessedChartData = () => {
                    let data = [...fullChartData.value];
                    if (data.length === 0) return [];
                    let startDate = new Date();
                    const now = new Date();
                    
                    if (timeRange.value === 'CUSTOM') startDate = new Date(customStart.value);
                    else {
                        switch(timeRange.value) {
                            case '1M': startDate.setMonth(now.getMonth() - 1); break;
                            case '3M': startDate.setMonth(now.getMonth() - 3); break;
                            case '6M': startDate.setMonth(now.getMonth() - 6); break;
                            case 'YTD': startDate = new Date(now.getFullYear(), 0, 1); break;
                            case '1Y': startDate.setFullYear(now.getFullYear() - 1); break;
                            case 'ALL': startDate = new Date('2000-01-01'); break;
                        }
                    }

                    let startIndex = data.findIndex(d => new Date(d.date) >= startDate);
                    if (startIndex === -1) return [];
                    let baseIndex = (startIndex > 0) ? startIndex - 1 : 0;
                    const base = data[baseIndex];
                    const filtered = data.slice(startIndex);

                    if (chartType.value === 'value') return filtered; 

                    return filtered.map(d => {
                        let newTwr = 0, newBench = 0;
                        const baseTwrVal = base.twr || 0; const curTwrVal = d.twr || 0;
                        newTwr = ((1 + curTwrVal/100) / (1 + baseTwrVal/100) - 1) * 100;

                        const baseBench = base.benchmark_twr || 0; const curBench = d.benchmark_twr || 0;
                        newBench = ((1 + curBench/100) / (1 + baseBench/100) - 1) * 100;
                        
                        return { ...d, twr: newTwr, benchmark_twr: newBench };
                    });
                };

                const drawChart = () => {
                    const ctx = document.getElementById('mainChart');
                    if (!ctx) return;
                    if (mainChartInstance) mainChartInstance.destroy();

                    const processedData = getProcessedChartData();
                    const labels = processedData.map(d => d.date);
                    let datasets = [];
                    let type = 'line';
                    
                    // --- 共用設定：無點、純折線 ---
                    const commonOptions = {
                        pointRadius: 0,        // 不顯示點
                        pointHoverRadius: 4,   // 滑鼠移上去才顯示小點
                        fill: false,
                        tension: 0.1,          // 線條略微平滑，但不圓弧
                        borderWidth: 2
                    };

                    if (chartType.value === 'value') {
                        datasets = [
                            { label: '總淨值', data: processedData.map(d => d.total_value), borderColor: '#40a9ff', ...commonOptions },
                            { label: '成本', data: processedData.map(d => d.invested), borderColor: '#888', borderDash: [5, 5], pointRadius: 0, borderWidth: 1 }
                        ];
                    } else if (chartType.value === 'twr') {
                        datasets = [
                            { label: 'TWR (%)', data: processedData.map(d => d.twr), borderColor: '#4caf50', ...commonOptions },
                            { label: 'SPY (%)', data: processedData.map(d => d.benchmark_twr), borderColor: '#ffc107', borderWidth: 1.5, pointRadius: 0, borderDash: [2, 2], fill: false }
                        ];
                    } else if (chartType.value === 'pnl') {
                        type = 'bar';
                        const dailyPnl = processedData.map((d, i) => {
                            let prevTotal = 0, prevInvest = 0;
                            if (i === 0) {
                                const idxInFull = fullChartData.value.findIndex(x => x.date === d.date);
                                if (idxInFull > 0) {
                                    const prev = fullChartData.value[idxInFull - 1];
                                    prevTotal = prev.total_value; prevInvest = prev.invested;
                                } else return 0;
                            } else {
                                prevTotal = processedData[i-1].total_value; prevInvest = processedData[i-1].invested;
                            }
                            return (d.total_value - prevTotal) - (d.invested - prevInvest);
                        });
                        datasets = [{ label: '單日損益', data: dailyPnl, backgroundColor: dailyPnl.map(v => v >= 0 ? '#4caf50' : '#ff5252') }];
                    }

                    mainChartInstance = new Chart(ctx, {
                        type: type,
                        data: { labels, datasets },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            interaction: { mode: 'index', intersect: false },
                            plugins: { 
                                legend: { labels: { color: '#e0e0e0' } },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            let label = context.dataset.label || '';
                                            if (label) label += ': ';
                                            if (context.parsed.y !== null) {
                                                label += formatNumber(context.parsed.y);
                                                if(chartType.value === 'twr') label += '%';
                                            }
                                            return label;
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: { grid: { color: '#2d2d30' }, ticks: { color: '#888', maxTicksLimit: 8 } },
                                y: { grid: { color: '#2d2d30' }, ticks: { color: '#888' } }
                            }
                        }
                    });
                };

                const switchTimeRange = (range) => { timeRange.value = range; drawChart(); };
                const switchChartType = (type) => { chartType.value = type; drawChart(); };
                const switchPieType = (type) => { pieType.value = type; drawPieChart(); };

                const drawPieChart = () => {
                    const ctx = document.getElementById('pieChart');
                    if (!ctx || combinedHoldings.value.length === 0) return;
                    if (pieChartInstance) pieChartInstance.destroy();
                    let groupData = {};
                    combinedHoldings.value.forEach(h => {
                        let key;
                        if (pieType.value === 'asset') key = h.symbol;
                        else if (pieType.value === 'currency') key = h.currency;
                        else if (pieType.value === 'strategy') key = h.tag || 'Other';
                        if (!groupData[key]) groupData[key] = 0;
                        groupData[key] += h.market_value_twd;
                    });
                    let sorted = Object.entries(groupData).sort((a,b) => b[1] - a[1]);
                    if (sorted.length > 8) {
                        const others = sorted.slice(8).reduce((acc, curr) => acc + curr[1], 0);
                        sorted = sorted.slice(0, 8);
                        sorted.push(['Others', others]);
                    }
                    const colors = ['#40a9ff', '#4caf50', '#ffc107', '#ff5252', '#9c27b0', '#00bcd4', '#ff9800', '#795548', '#607d8b'];
                    pieChartInstance = new Chart(ctx, {
                        type: 'doughnut',
                        data: { labels: sorted.map(i => i[0]), datasets: [{ data: sorted.map(i => i[1]), backgroundColor: colors, borderColor: '#18181c', borderWidth: 2 }] },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#e0e0e0', boxWidth: 12 } } } }
                    });
                };

                const formatNumber = (num, digits=0) => {
                    if (num === undefined || num === null) return '-';
                    return Number(num).toLocaleString('zh-TW', { minimumFractionDigits: digits, maximumFractionDigits: digits });
                };

                onMounted(() => {
                    window.handleCredentialResponse = handleCredentialResponse;
                    loadPortfolioData();
                    if (userToken.value) fetchRecords();
                    window.addEventListener('resize', () => { if(mainChartInstance) drawChart(); if(pieChartInstance) drawPieChart(); });
                });

                return {
                    userToken, userName, googleClientId: CLIENT_ID, logout,
                    records, isUpdating, triggerGitHubUpdate,
                    localStats, combinedHoldings, unrealizedPnL, dailyPnL, formatNumber, lastUpdateTime, calculating,
                    timeRange, switchTimeRange, chartType, switchChartType, pieType, switchPieType, fetchRecords,
                    form, submitRecord, deleteRecord, editRecord, resetForm, isEditing, submitting,
                    customStart, customEnd, drawChart,
                    calcTotal, calcPrice, calculateAvgCost
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
