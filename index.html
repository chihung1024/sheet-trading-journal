<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SaaS 交易管理系統 (Pro Plus)</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    
    <style>
        /* --- 全域變數與重置 --- */
        :root { 
            --bg: #101014; 
            --card-bg: #18181c; 
            --border: #2d2d30; 
            --primary: #40a9ff; 
            --text: #e0e0e0; 
            --text-muted: #888;
            --green: #4caf50; 
            --red: #ff5252; 
            --yellow: #ffc107; 
        }
        
        * { box-sizing: border-box; }
        
        body { 
            background-color: var(--bg); 
            color: var(--text); 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            margin: 0; 
            padding: 20px; 
            line-height: 1.5;
        }
        
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
            padding-bottom: 60px; 
        }
        
        /* --- 通用元件 --- */
        .card { 
            background: var(--card-bg); 
            padding: 20px; 
            border-radius: 12px; 
            border: 1px solid var(--border); 
            margin-bottom: 20px; 
        }
        
        .flex-row { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            flex-wrap: wrap; 
            gap: 15px; 
        }
        
        h2, h3 { margin: 0; font-weight: 600; }
        h3 { font-size: 1.1rem; margin-bottom: 10px; }
        
        /* 按鈕樣式 */
        .btn { 
            padding: 6px 12px; 
            border-radius: 6px; 
            border: none; 
            cursor: pointer; 
            font-size: 0.9rem; 
            transition: all 0.2s; 
            white-space: nowrap;
        }
        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { opacity: 0.9; }
        .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .btn-danger { background: var(--red); color: white; }
        .btn-danger:hover { opacity: 0.9; }
        
        .btn-outline { 
            background: transparent; 
            border: 1px solid var(--border); 
            color: var(--text); 
        }
        .btn-outline:hover, .btn-outline.active { 
            background: #333; 
            color: white; 
            border-color: var(--text); 
        }
        .btn-sm { padding: 4px 8px; font-size: 0.8rem; }
        
        /* 文字顏色 */
        .text-green { color: var(--green); }
        .text-red { color: var(--red); }
        .text-muted { color: var(--text-muted); }
        
        /* --- 登入遮罩 --- */
        .login-overlay { 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.95); 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            z-index: 9999; 
            flex-direction: column; 
            gap: 20px; 
        }
        
        /* --- Header --- */
        .header-bar { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 20px; 
            border-bottom: 1px solid var(--border); 
            padding-bottom: 15px; 
        }
        .user-info { 
            display: flex; 
            align-items: center; 
            gap: 12px; 
            font-size: 0.9rem; 
        }
        .avatar { 
            width: 32px; 
            height: 32px; 
            background: var(--primary); 
            border-radius: 50%; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            color: white; 
            font-weight: bold; 
        }
        
        /* --- 數據概覽 Grid --- */
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); 
            gap: 15px; 
            margin-bottom: 20px; 
        }
        .stat-card { 
            background: var(--card-bg); 
            padding: 20px; 
            border-radius: 12px; 
            border: 1px solid var(--border); 
            text-align: center; 
        }
        .stat-label { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 8px; }
        .stat-value { font-size: 1.6rem; font-weight: bold; line-height: 1.2; }
        .stat-sub { font-size: 0.85rem; margin-top: 6px; color: #888; }
        
        /* --- 圖表區塊 --- */
        .chart-section { 
            display: grid; 
            grid-template-columns: 2fr 1fr; 
            gap: 20px; 
            margin-bottom: 20px; 
        }
        @media (max-width: 900px) { .chart-section { grid-template-columns: 1fr; } }
        
        .chart-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 15px; 
            flex-wrap: wrap; 
            gap: 10px; 
        }
        .chart-controls { 
            display: flex; 
            gap: 5px; 
            background: #222; 
            padding: 4px; 
            border-radius: 8px; 
        }
        .chart-controls button { 
            background: transparent; 
            border: none; 
            color: #888; 
            padding: 4px 12px; 
            font-size: 0.8rem; 
            cursor: pointer; 
            border-radius: 6px; 
        }
        .chart-controls button.active { 
            background: #444; 
            color: #fff; 
            font-weight: 600; 
        }
        
        .date-picker-group { display: flex; gap: 8px; align-items: center; margin-top: 5px; }
        .date-picker-group label { font-size: 0.8rem; color: #888; }
        .date-picker-group input { 
            background: #222; 
            border: 1px solid #444; 
            color: #ccc; 
            padding: 4px 8px; 
            border-radius: 4px; 
            font-size: 0.8rem; 
        }
        
        .chart-container { position: relative; height: 350px; width: 100%; }
        
        /* --- 交易表單 --- */
        .editor-form { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(110px, 1fr)); 
            gap: 12px; 
            align-items: end; 
            background: #222; 
            padding: 20px; 
            border-radius: 8px; 
            border: 1px solid #444; 
            margin-bottom: 20px; 
        }
        .form-group { display: flex; flex-direction: column; gap: 6px; }
        .form-group label { font-size: 0.8rem; color: #aaa; white-space: nowrap; }
        .form-group input, .form-group select { 
            background: #111; 
            border: 1px solid #333; 
            color: white; 
            padding: 8px; 
            border-radius: 4px; 
            font-size: 0.95rem; 
            width: 100%; 
        }
        .form-group input:focus { border-color: var(--primary); outline: none; }
        .form-group input[readonly] { background: #1a1a1a; color: #777; cursor: not-allowed; }
        
        /* --- 表格樣式 --- */
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.95rem; }
        th, td { 
            text-align: right; 
            padding: 12px 10px; 
            border-bottom: 1px solid var(--border); 
        }
        th:first-child, td:first-child { text-align: left; }
        th { color: var(--text-muted); font-weight: 500; font-size: 0.85rem; }
        tr:hover { background: #222; }
        
        .tag { 
            display: inline-block; 
            padding: 2px 8px; 
            border-radius: 4px; 
            font-size: 0.75rem; 
            background: #333; 
            color: #ccc; 
            border: 1px solid #444;
        }
        
        .loading-text { text-align: center; padding: 40px; color: #666; font-style: italic; }
    </style>
</head>
<body>
    <div id="app" class="container">
        <div v-if="!userToken" class="login-overlay">
            <h2 style="color:white; margin-bottom: 20px;">SaaS 交易管理系統 Login</h2>
            <div id="g_id_onload" 
                 :data-client_id="googleClientId" 
                 data-callback="handleCredentialResponse"
                 data-auto_select="false">
            </div>
            <div class="g_id_signin" 
                 data-type="standard" 
                 data-size="large" 
                 data-theme="filled_black"
                 data-text="sign_in_with"
                 data-shape="rectangular"
                 data-logo_alignment="left">
            </div>
        </div>

        <div v-else>
            <div class="header-bar">
                <div>
                    <h2 style="margin:0">Dashboard <span style="font-size:0.8rem; color:#666">v0.01 Final</span></h2>
                    <small style="color:var(--text-muted)">最後更新: {{ lastUpdateTime }}</small>
                </div>
                <div class="user-info">
                    <div class="avatar">{{ userName.charAt(0).toUpperCase() }}</div>
                    <span>{{ userName }}</span>
                    <button @click="logout" class="btn btn-outline btn-sm">登出</button>
                    <button @click="triggerGitHubUpdate" class="btn btn-primary btn-sm" :disabled="isUpdating">
                        {{ isUpdating ? '更新中...' : '刷新報價' }}
                    </button>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">總淨值 (TWD)</div>
                    <div class="stat-value" style="color:var(--primary)">{{ formatNumber(localStats.total_value) }}</div>
                    <div class="stat-sub" style="color:#888">成本: {{ formatNumber(localStats.invested_capital) }}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">未實踐損益</div>
                    <div class="stat-value" :class="unrealizedPnL >= 0 ? 'text-green' : 'text-red'">
                        {{ unrealizedPnL >= 0 ? '+' : '' }}{{ formatNumber(unrealizedPnL) }}
                    </div>
                    <div class="stat-sub">
                        {{ localStats.invested_capital ? ((unrealizedPnL/localStats.invested_capital)*100).toFixed(2) : 0 }}%
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">今日損益 (估計)</div>
                    <div class="stat-value" :class="dailyPnL >= 0 ? 'text-green' : 'text-red'">
                        {{ dailyPnL >= 0 ? '+' : '' }}{{ formatNumber(dailyPnL) }}
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">TWR 總報酬率</div>
                    <div class="stat-value" :class="localStats.twr >= 0 ? 'text-green' : 'text-red'">
                        {{ localStats.twr }}%
                    </div>
                    <div class="stat-sub" style="color:var(--yellow)">SPY: {{ localStats.benchmark_twr || '-' }}%</div>
                </div>
            </div>

            <div class="chart-section" v-show="!calculating">
                <div class="card">
                    <div class="chart-header">
                        <div class="chart-controls">
                            <button @click="switchChartType('twr')" :class="{active: chartType==='twr'}">績效 %</button>
                            <button @click="switchChartType('value')" :class="{active: chartType==='value'}">淨值</button>
                            <button @click="switchChartType('pnl')" :class="{active: chartType==='pnl'}">日損益</button>
                        </div>
                        <div class="chart-controls">
                            <button v-for="range in ['1M','3M','6M','YTD','1Y','ALL','CUSTOM']" 
                                    :key="range" 
                                    @click="switchTimeRange(range)" 
                                    :class="{active: timeRange===range}">
                                {{ range === 'CUSTOM' ? '自訂' : range }}
                            </button>
                        </div>
                    </div>
                    
                    <div class="chart-header" v-if="timeRange === 'CUSTOM'" style="justify-content: flex-end; margin-top:-10px;">
                        <div class="date-picker-group">
                            <label>From:</label>
                            <input type="date" v-model="customStart" @change="drawChart">
                            <label>To:</label>
                            <input type="date" v-model="customEnd" @change="drawChart">
                        </div>
                    </div>

                    <div class="chart-container">
                        <canvas id="mainChart"></canvas>
                    </div>
                </div>

                <div class="card">
                    <div class="chart-header">
                        <div class="chart-controls">
                            <button @click="switchPieType('asset')" :class="{active: pieType==='asset'}">資產</button>
                            <button @click="switchPieType('currency')" :class="{active: pieType==='currency'}">幣別</button>
                            <button @click="switchPieType('strategy')" :class="{active: pieType==='strategy'}">策略</button>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="pieChart"></canvas>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="flex-row" style="margin-bottom:15px">
                    <h3>{{ isEditing ? '修改交易紀錄' : '新增交易紀錄' }}</h3>
                    <button v-if="isEditing" @click="resetForm" class="btn btn-outline btn-sm">取消修改</button>
                </div>
                
                <div class="editor-form">
                    <div class="form-group">
                        <label>日期</label>
                        <input type="date" v-model="form.txn_date">
                    </div>
                    <div class="form-group">
                        <label>代碼</label>
                        <input type="text" v-model="form.symbol" placeholder="e.g. NVDA">
                    </div>
                    <div class="form-group">
                        <label>類型</label>
                        <select v-model="form.txn_type" @change="calcTotal">
                            <option value="BUY">買入</option>
                            <option value="SELL">賣出</option>
                            <option value="DIV">股息</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>標籤 (Tag)</label>
                        <input type="text" v-model="form.tag" list="tagOptions" placeholder="長線/短線">
                        <datalist id="tagOptions">
                            <option value="長線"></option>
                            <option value="短線"></option>
                            <option value="配息"></option>
                        </datalist>
                    </div>
                    <div class="form-group">
                        <label>股數</label>
                        <input type="number" step="any" v-model="form.qty" @input="calcTotal">
                    </div>
                    <div class="form-group">
                        <label>單價 (平均成本)</label>
                        <input type="number" step="any" v-model="form.price" @input="calcTotal">
                    </div>
                    <div class="form-group">
                        <label>手續費 (Fee)</label>
                        <input type="number" step="any" v-model="form.fee" @input="calcTotal">
                    </div>
                    <div class="form-group">
                        <label>交易稅 (Tax)</label>
                        <input type="number" step="any" v-model="form.tax" @input="calcTotal">
                    </div>
                    <div class="form-group" style="min-width: 120px;">
                        <label>交易總額 (Total)</label>
                        <input type="number" step="any" v-model="form.total_amount" @input="calcPrice" placeholder="自動計算">
                    </div>
                    
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button class="btn btn-primary" @click="submitRecord" :disabled="submitting" style="width:100%">
                            {{ submitting ? '處理中...' : (isEditing ? '儲存修改' : '新增') }}
                        </button>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3>持倉明細 (Live)</h3>
                <div v-if="calculating" class="loading-text">載入即時報價中...</div>
                <table v-else>
                    <thead>
                        <tr>
                            <th>代碼</th>
                            <th>標籤</th>
                            <th>股數</th>
                            <th>平均成本</th>
                            <th>現價</th>
                            <th>市值 (TWD)</th>
                            <th>未平倉損益</th>
                            <th>報酬率</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="h in combinedHoldings" :key="h.symbol">
                            <td><strong>{{ h.symbol }}</strong></td>
                            <td><span class="tag">{{ h.tag }}</span></td>
                            <td>{{ formatNumber(h.qty, 2) }}</td>
                            <td>{{ calculateAvgCost(h) }}</td>
                            <td>{{ h.current_price_origin }}</td>
                            <td>{{ formatNumber(h.market_value_twd) }}</td>
                            <td :class="h.pnl_twd >= 0 ? 'text-green' : 'text-red'">
                                {{ formatNumber(h.pnl_twd) }}
                            </td>
                            <td :class="h.pnl_percent >= 0 ? 'text-green' : 'text-red'">
                                {{ h.pnl_percent }}%
                            </td>
                        </tr>
                        <tr v-if="combinedHoldings.length === 0">
                            <td colspan="8" style="text-align:center; padding:20px; color:#666">目前無持倉</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="card" style="margin-top: 20px;">
                <div class="flex-row">
                    <h3>最近交易紀錄 (API)</h3>
                    <button class="btn btn-outline btn-sm" @click="fetchRecords">重新整理</button>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>日期</th>
                            <th>代碼</th>
                            <th>類型</th>
                            <th>標籤</th>
                            <th>股數</th>
                            <th>價格</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr v-for="r in records" :key="r.id">
                            <td>{{ r.txn_date }}</td>
                            <td>{{ r.symbol }}</td>
                            <td>
                                <span :class="r.txn_type === 'BUY' ? 'text-red' : 'text-green'">
                                    {{ r.txn_type }}
                                </span>
                            </td>
                            <td><span class="tag">{{ r.tag || '-' }}</span></td>
                            <td>{{ r.qty }}</td>
                            <td>{{ r.price }}</td>
                            <td>
                                <button class="btn btn-outline btn-sm" @click="editRecord(r)">修</button>
                                <button class="btn btn-danger btn-sm" @click="deleteRecord(r.id)" style="margin-left:5px">刪</button>
                            </td>
                        </tr>
                        <tr v-if="records.length === 0">
                            <td colspan="7" style="text-align:center; padding:20px; color:#666">無交易紀錄</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, onMounted, computed, nextTick, reactive, watch } = Vue;
        
        // --- 設定與常數 ---
        const WORKER_BASE_URL = "https://journal-backend.chired.workers.dev";
        const CLIENT_ID = "951186116587-0ehsmkvlu3uivduc7kjn1jpp9ga7810i.apps.googleusercontent.com";

        createApp({
            setup() {
                // --- 狀態變數 ---
                const userToken = ref(localStorage.getItem('token') || '');
                const userName = ref(localStorage.getItem('name') || '');
                
                // 數據狀態
                const localStats = ref({});
                const fullChartData = ref([]);
                const combinedHoldings = ref([]);
                const records = ref([]);
                const lastUpdateTime = ref('');
                const exchangeRate = ref(32.0);
                const calculating = ref(true);
                const isUpdating = ref(false);
                const submitting = ref(false);

                // 表單狀態
                const isEditing = ref(false);
                const editingId = ref(null);
                const form = reactive({ 
                    txn_date: new Date().toISOString().split('T')[0], 
                    symbol: '', 
                    txn_type: 'BUY', 
                    tag: 'Stock',
                    qty: 0, 
                    price: 0, 
                    fee: 0, 
                    tax: 0, 
                    total_amount: 0 
                });

                // 圖表狀態
                const timeRange = ref('1Y');
                const customStart = ref('');
                const customEnd = ref('');
                const chartType = ref('twr'); // 預設績效
                const pieType = ref('asset');
                let mainChartInstance = null;
                let pieChartInstance = null;

                // --- 計算屬性 ---
                const unrealizedPnL = computed(() => {
                    return (localStats.value.total_value || 0) - (localStats.value.invested_capital || 0);
                });
                
                const dailyPnL = computed(() => {
                    if (fullChartData.value.length < 2) return 0;
                    const last = fullChartData.value[fullChartData.value.length - 1];
                    const prev = fullChartData.value[fullChartData.value.length - 2];
                    return (last.total_value - last.invested) - (prev.total_value - prev.invested);
                });

                // --- 1. 登入邏輯 ---
                const logout = () => {
                    localStorage.removeItem('token');
                    localStorage.removeItem('name');
                    location.reload();
                };

                const handleCredentialResponse = async (res) => {
                    try {
                        const r = await fetch(`${WORKER_BASE_URL}/auth/google`, {
                            method: "POST",
                            body: JSON.stringify({ id_token: res.credential })
                        });
                        const d = await r.json();
                        if (d.success) {
                            userToken.value = d.token;
                            userName.value = d.user;
                            localStorage.setItem('token', d.token);
                            localStorage.setItem('name', d.user);
                            
                            // 登入成功後同時載入列表與圖表
                            fetchRecords();
                            loadPortfolioData();
                        } else {
                            alert("登入驗證失敗: " + (d.error || "Unknown"));
                        }
                    } catch(e) {
                        console.error(e);
                        alert("登入連線錯誤");
                    }
                };

                // --- 2. 表單連動邏輯 ---
                const calcTotal = () => {
                    const base = (parseFloat(form.qty) || 0) * (parseFloat(form.price) || 0);
                    const fee = parseFloat(form.fee) || 0;
                    const tax = parseFloat(form.tax) || 0;
                    
                    if (form.txn_type === 'BUY') {
                        // 買入總成本 = 價金 + 費 + 稅
                        form.total_amount = parseFloat((base + fee + tax).toFixed(2));
                    } else {
                        // 賣出/配息
                        if (form.txn_type === 'SELL') {
                            form.total_amount = parseFloat((base - fee - tax).toFixed(2));
                        } else {
                            // DIV
                            form.total_amount = parseFloat((base - tax).toFixed(2));
                        }
                    }
                };

                const calcPrice = () => {
                    const qty = parseFloat(form.qty) || 0;
                    const fee = parseFloat(form.fee) || 0;
                    const tax = parseFloat(form.tax) || 0;
                    const total = parseFloat(form.total_amount) || 0;
                    
                    if (qty > 0) {
                        if (form.txn_type === 'BUY') {
                            form.price = parseFloat(((total - fee - tax) / qty).toFixed(4));
                        } else if (form.txn_type === 'SELL') {
                            form.price = parseFloat(((total + fee + tax) / qty).toFixed(4));
                        } else {
                             form.price = parseFloat(((total + tax) / qty).toFixed(4));
                        }
                    }
                };

                // 計算持倉平均成本 (原幣)
                const calculateAvgCost = (h) => {
                    if (!h.qty) return 0;
                    // TWD Cost = MarketVal - PnL
                    const costTwd = h.market_value_twd - h.pnl_twd;
                    const ex = exchangeRate.value || 32;
                    // Avg Cost (USD)
                    const avg = (costTwd / ex) / h.qty;
                    return avg.toFixed(2);
                };

                // --- 3. API CRUD ---
                const fetchRecords = async () => {
                    if (!userToken.value) return;
                    try {
                        const r = await fetch(`${WORKER_BASE_URL}/api/records`, {
                            headers: { 'Authorization': `Bearer ${userToken.value}` }
                        });
                        const j = await r.json();
                        if (j.success) records.value = j.data;
                    } catch(e) { console.error("Fetch records fail", e); }
                };

                const submitRecord = async () => {
                    if (!userToken.value || !form.symbol) return;
                    submitting.value = true;
                    try {
                        const method = isEditing.value ? "PUT" : "POST";
                        const payload = { ...form };
                        if (isEditing.value) payload.id = editingId.value;
                        
                        const r = await fetch(`${WORKER_BASE_URL}/api/records`, {
                            method,
                            headers: { 
                                'Authorization': `Bearer ${userToken.value}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(payload)
                        });
                        const j = await r.json();
                        if (j.success) {
                            alert(isEditing.value ? "修改成功" : "新增成功");
                            resetForm();
                            fetchRecords();
                        } else {
                            alert("操作失敗: " + j.error);
                        }
                    } catch(e) { 
                        alert("連線錯誤"); 
                    } finally { 
                        submitting.value = false; 
                    }
                };

                const deleteRecord = async (id) => {
                    if(!confirm("確定要刪除此紀錄嗎？")) return;
                    try {
                        await fetch(`${WORKER_BASE_URL}/api/records`, {
                            method: "DELETE",
                            headers: { 
                                'Authorization': `Bearer ${userToken.value}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ id })
                        });
                        fetchRecords();
                    } catch(e) { alert("刪除失敗"); }
                };

                const editRecord = (r) => {
                    isEditing.value = true;
                    editingId.value = r.id;
                    Object.assign(form, r);
                    form.fee = r.fee || 0;
                    form.tax = r.tax || 0; 
                    // 確保標籤有值
                    if (!form.tag) form.tag = 'Stock';
                    
                    calcTotal(); // 重算總額顯示
                    // 滾動到表單 (直接在輸入區塊修改)
                    document.querySelector('.editor-form').scrollIntoView({ behavior: 'smooth' });
                };

                const resetForm = () => {
                    isEditing.value = false;
                    editingId.value = null;
                    form.symbol = '';
                    form.qty = 0;
                    form.price = 0;
                    form.fee = 0;
                    form.tax = 0;
                    form.total_amount = 0;
                    form.tag = 'Stock';
                };

                const triggerGitHubUpdate = async () => {
                    if(!confirm("確定要觸發 GitHub Action 更新最新報價嗎？")) return;
                    isUpdating.value = true;
                    try {
                        await fetch(`${WORKER_BASE_URL}/api/trigger-update`, {
                            method: "POST",
                            headers: { 'Authorization': `Bearer ${userToken.value}` }
                        });
                        alert("已觸發更新，請稍待片刻後重新整理頁面。");
                    } catch(e) {
                        alert("觸發失敗");
                    } finally {
                        isUpdating.value = false;
                    }
                };

                // --- 4. 圖表與數據加載 ---
                const loadPortfolioData = async () => {
                    calculating.value = true;
                    try {
                        const res = await fetch(`${WORKER_BASE_URL}/api/portfolio`);
                        const json = await res.json();
                        
                        let data;
                        if (json.success) {
                            data = json.data;
                        } else {
                            throw new Error("API Load Failed");
                        }

                        localStats.value = data.summary;
                        combinedHoldings.value = data.holdings;
                        fullChartData.value = data.history || [];
                        lastUpdateTime.value = data.updated_at;
                        exchangeRate.value = data.exchange_rate || 32.0;

                        const today = new Date();
                        customEnd.value = today.toISOString().split('T')[0];
                        today.setFullYear(today.getFullYear() - 1);
                        customStart.value = today.toISOString().split('T')[0];

                        nextTick(() => {
                            drawChart();
                            drawPieChart();
                        });
                    } catch (e) {
                        console.error(e);
                    } finally {
                        calculating.value = false;
                    }
                };

                // [修正] 圖表資料處理：ALL 模式不歸零，避免 Gap
                const getProcessedChartData = () => {
                    let data = [...fullChartData.value];
                    if (data.length === 0) return [];

                    let startDate = new Date();
                    const now = new Date();
                    
                    if (timeRange.value === 'CUSTOM') {
                        startDate = new Date(customStart.value);
                    } else {
                        switch(timeRange.value) {
                            case '1M': startDate.setMonth(now.getMonth() - 1); break;
                            case '3M': startDate.setMonth(now.getMonth() - 3); break;
                            case '6M': startDate.setMonth(now.getMonth() - 6); break;
                            case 'YTD': startDate = new Date(now.getFullYear(), 0, 1); break;
                            case '1Y': startDate.setFullYear(now.getFullYear() - 1); break;
                            case 'ALL': startDate = new Date('2000-01-01'); break;
                        }
                    }

                    // 找出區間內的第一筆資料索引
                    let startIndex = data.findIndex(d => new Date(d.date) >= startDate);
                    
                    if (startIndex === -1) return []; 
                    
                    // [關鍵修正]：如果選 ALL 或資料起點就是第一筆，則不使用 Rebase
                    // 直接使用原始累積數據，避免前一天無數據造成的 0 -> 100% 跳躍
                    let useZeroBase = true;
                    if (timeRange.value === 'ALL' || (startIndex === 0 && timeRange.value === 'CUSTOM')) {
                        useZeroBase = false;
                    }

                    // 如果需要 Rebase (例如 1M)，則以 StartIndex 的前一筆為基準
                    let baseIndex = (startIndex > 0) ? startIndex - 1 : 0;
                    const base = data[baseIndex];
                    
                    const filtered = data.slice(startIndex);

                    if (chartType.value === 'value') return filtered; 

                    return filtered.map(d => {
                        let newTwr = d.twr; // 預設使用原始值
                        let newBench = d.benchmark_twr;
                        
                        // 只有在非 ALL 模式且有前一日資料時，才進行歸零運算
                        if (useZeroBase) {
                            const baseTwrVal = (base.twr !== undefined) ? base.twr : 0;
                            const curTwrVal = (d.twr !== undefined) ? d.twr : 0;
                            newTwr = ((1 + curTwrVal/100) / (1 + baseTwrVal/100) - 1) * 100;

                            const baseBench = (base.benchmark_twr !== undefined) ? base.benchmark_twr : 0;
                            const curBench = (d.benchmark_twr !== undefined) ? d.benchmark_twr : 0;
                            newBench = ((1 + curBench/100) / (1 + baseBench/100) - 1) * 100;
                        }
                        
                        return {
                            ...d,
                            twr: newTwr,
                            benchmark_twr: newBench,
                        };
                    });
                };

                const drawChart = () => {
                    const ctx = document.getElementById('mainChart');
                    if (!ctx) return;
                    if (mainChartInstance) mainChartInstance.destroy();

                    const processedData = getProcessedChartData();
                    const labels = processedData.map(d => d.date);
                    
                    let datasets = [];
                    let type = 'line';
                    
                    const commonOptions = {
                        pointRadius: 0,
                        pointHoverRadius: 4,
                        fill: false,
                        tension: 0.1,
                        borderWidth: 2
                    };

                    if (chartType.value === 'value') {
                        datasets = [
                            { 
                                label: '總淨值', 
                                data: processedData.map(d => d.total_value), 
                                borderColor: '#40a9ff', 
                                ...commonOptions 
                            },
                            { 
                                label: '投入成本', 
                                data: processedData.map(d => d.invested), 
                                borderColor: '#888', 
                                borderDash: [5, 5], 
                                pointRadius: 0, 
                                borderWidth: 1,
                                fill: false
                            }
                        ];
                    } else if (chartType.value === 'twr') {
                        datasets = [
                            { 
                                label: 'TWR (%)', 
                                data: processedData.map(d => d.twr), 
                                borderColor: '#4caf50', 
                                ...commonOptions 
                            },
                            { 
                                label: 'SPY (%)', 
                                data: processedData.map(d => d.benchmark_twr), 
                                borderColor: '#ffc107', 
                                borderWidth: 1.5, 
                                pointRadius: 0, 
                                borderDash: [2, 2], 
                                fill: false 
                            }
                        ];
                    } else if (chartType.value === 'pnl') {
                        type = 'bar';
                        const dailyPnl = processedData.map((d, i) => {
                            let prevTotal = 0;
                            let prevInvest = 0;
                            
                            if (i === 0) {
                                // 嘗試找前一日
                                if (timeRange.value !== 'ALL') {
                                    const idxInFull = fullChartData.value.findIndex(x => x.date === d.date);
                                    if (idxInFull > 0) {
                                        const prev = fullChartData.value[idxInFull - 1];
                                        prevTotal = prev.total_value;
                                        prevInvest = prev.invested;
                                    }
                                }
                            } else {
                                prevTotal = processedData[i-1].total_value;
                                prevInvest = processedData[i-1].invested;
                            }
                            
                            const valDiff = d.total_value - prevTotal;
                            const costDiff = d.invested - prevInvest;
                            return valDiff - costDiff;
                        });
                        
                        datasets = [{
                            label: '單日損益 (TWD)',
                            data: dailyPnl,
                            backgroundColor: dailyPnl.map(v => v >= 0 ? '#4caf50' : '#ff5252')
                        }];
                    }

                    mainChartInstance = new Chart(ctx, {
                        type: type,
                        data: { labels, datasets },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: { mode: 'index', intersect: false },
                            plugins: {
                                legend: { labels: { color: '#e0e0e0' } },
                                tooltip: {
                                    callbacks: {
                                        label: function(context) {
                                            let label = context.dataset.label || '';
                                            if (label) label += ': ';
                                            if (context.parsed.y !== null) {
                                                label += formatNumber(context.parsed.y);
                                                if(chartType.value === 'twr') label += '%';
                                            }
                                            return label;
                                        }
                                    }
                                }
                            },
                            scales: {
                                x: { 
                                    grid: { color: '#2d2d30' }, 
                                    ticks: { color: '#888', maxTicksLimit: 8 } 
                                },
                                y: { 
                                    grid: { color: '#2d2d30' }, 
                                    ticks: { color: '#888' } 
                                }
                            }
                        }
                    });
                };

                const switchTimeRange = (range) => { timeRange.value = range; drawChart(); };
                const switchChartType = (type) => { chartType.value = type; drawChart(); };
                const switchPieType = (type) => { pieType.value = type; drawPieChart(); };

                const drawPieChart = () => {
                    const ctx = document.getElementById('pieChart');
                    if (!ctx || combinedHoldings.value.length === 0) return;
                    if (pieChartInstance) pieChartInstance.destroy();

                    let groupData = {};
                    combinedHoldings.value.forEach(h => {
                        let key;
                        if (pieType.value === 'asset') key = h.symbol;
                        else if (pieType.value === 'currency') key = h.currency;
                        else if (pieType.value === 'strategy') key = h.tag || 'Other';
                        
                        if (!groupData[key]) groupData[key] = 0;
                        groupData[key] += h.market_value_twd;
                    });

                    let sorted = Object.entries(groupData).sort((a,b) => b[1] - a[1]);
                    if (sorted.length > 8) {
                        const others = sorted.slice(8).reduce((acc, curr) => acc + curr[1], 0);
                        sorted = sorted.slice(0, 8);
                        sorted.push(['Others', others]);
                    }

                    const colors = [
                        '#40a9ff', '#4caf50', '#ffc107', '#ff5252', '#9c27b0', 
                        '#00bcd4', '#ff9800', '#795548', '#607d8b'
                    ];

                    pieChartInstance = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: sorted.map(i => i[0]),
                            datasets: [{
                                data: sorted.map(i => i[1]),
                                backgroundColor: colors,
                                borderColor: '#18181c',
                                borderWidth: 2
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { position: 'right', labels: { color: '#e0e0e0', boxWidth: 12 } }
                            }
                        }
                    });
                };

                const formatNumber = (num, digits=0) => {
                    if (num === undefined || num === null) return '-';
                    return Number(num).toLocaleString('zh-TW', { 
                        minimumFractionDigits: digits, 
                        maximumFractionDigits: digits 
                    });
                };

                onMounted(() => {
                    window.handleCredentialResponse = handleCredentialResponse;
                    loadPortfolioData();
                    if (userToken.value) fetchRecords();
                    window.addEventListener('resize', () => { 
                        if(mainChartInstance) drawChart(); 
                        if(pieChartInstance) drawPieChart();
                    });
                });

                return {
                    userToken, userName, googleClientId: CLIENT_ID, logout,
                    records, isUpdating, triggerGitHubUpdate,
                    localStats, combinedHoldings, unrealizedPnL, dailyPnL, formatNumber, lastUpdateTime, calculating,
                    timeRange, switchTimeRange, chartType, switchChartType, pieType, switchPieType, fetchRecords,
                    form, submitRecord, deleteRecord, editRecord, resetForm, isEditing, submitting,
                    customStart, customEnd, drawChart,
                    calcTotal, calcPrice, calculateAvgCost
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
