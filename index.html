<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SaaS æŠ•è³‡çµ„åˆçœ‹æ¿ (Pro)</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        /* --- åŸºç¤è¨­å®š --- */
        :root { --bg: #101014; --card-bg: #18181c; --border: #2d2d30; --primary: #40a9ff; --text: #e0e0e0; --green: #4caf50; --red: #ff5252; }
        body { background-color: var(--bg); color: var(--text); margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding-bottom: 60px; -webkit-tap-highlight-color: transparent; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        /* --- ç™»å…¥é®ç½© --- */
        .login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; justify-content: center; align-items: center; z-index: 2000; flex-direction: column; backdrop-filter: blur(5px); }
        .login-box { background: var(--card-bg); padding: 40px; border-radius: 16px; border: 1px solid var(--border); text-align: center; }

        /* --- Header --- */
        .header { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: flex-end; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 15px; gap: 15px; }
        .header h2 { margin: 0; font-size: 1.5rem; display: flex; align-items: center; gap: 10px; }
        .badge { font-size: 0.75rem; padding: 2px 6px; border-radius: 4px; background: #333; color: #aaa; vertical-align: middle; }
        
        .btn { padding: 8px 16px; border-radius: 6px; cursor: pointer; border: none; font-weight: 600; display: inline-flex; align-items: center; gap: 6px; font-size: 0.9rem; color: white; transition: 0.2s; }
        .btn:hover { filter: brightness(1.1); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-primary { background: var(--primary); }
        .btn-success { background: var(--green); }
        .btn-danger { background: rgba(255, 82, 82, 0.2); color: var(--red); border: 1px solid var(--red); }
        .btn-sm { padding: 4px 10px; font-size: 0.8rem; }

        /* --- æ•¸æ“šå¡ç‰‡ --- */
        .grid-dashboard { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        .card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 20px; position: relative; }
        .stat-val { font-size: 1.6rem; font-weight: 700; margin: 8px 0; }
        .stat-label { color: #888; font-size: 0.9rem; }
        .text-green { color: var(--green); } .text-red { color: var(--red); }
        
        /* --- åœ–è¡¨å€åŸŸ (ä¿®å¾©é‡é») --- */
        .chart-section { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 30px; }
        @media (max-width: 768px) { .chart-section { grid-template-columns: 1fr; } }
        .chart-container { background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 20px; height: 350px; position: relative; display: flex; flex-direction: column; }
        .chart-controls { display: flex; justify-content: flex-end; gap: 5px; margin-bottom: 10px; flex-wrap: wrap; }
        .chart-btn { background: #333; border: none; color: #888; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }
        .chart-btn.active { background: var(--primary); color: white; }

        /* --- ç·¨è¼¯èˆ‡åˆ—è¡¨ --- */
        .editor-panel { background: #1f1f23; padding: 20px; border-radius: 12px; border: 1px solid var(--primary); margin-bottom: 25px; display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; align-items: end; }
        input, select { width: 100%; background: #2d2d30; border: 1px solid #444; color: white; padding: 8px; border-radius: 4px; box-sizing: border-box; }
        
        .ledger-controls { display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 15px; align-items: center; }
        table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        th { text-align: left; color: #888; border-bottom: 1px solid var(--border); padding: 12px 8px; }
        td { padding: 12px 8px; border-bottom: 1px solid #222; color: #ddd; }
        
        .pagination { display: flex; justify-content: center; gap: 15px; margin-top: 20px; }
        .spinner { width: 16px; height: 16px; border: 2px solid rgba(255,255,255,0.3); border-top: 2px solid #fff; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="app" class="container">
        <div v-if="!userToken" class="login-overlay">
            <div class="login-box">
                <h2 style="margin-bottom: 10px;">SaaS äº¤æ˜“ç®¡ç†ç³»çµ±</h2>
                <p style="color:#888; margin-bottom:30px;">è«‹ç™»å…¥ä»¥å­˜å–è³‡æ–™</p>
                <div id="g_id_onload" :data-client_id="googleClientId" data-callback="handleCredentialResponse" data-auto_select="false"></div>
                <div class="g_id_signin" data-type="standard" data-shape="pill" data-size="large" data-theme="filled_black"></div>
            </div>
        </div>

        <div v-else>
            <div class="header">
                <div>
                    <h2>æŠ•è³‡çœ‹æ¿ <span class="badge">PRO</span></h2>
                    <div style="font-size:0.9rem; color:#888; margin-top:5px;">
                        ğŸ‘¤ {{ userName }} | æ›´æ–°æ–¼: {{ lastUpdateTime }}
                    </div>
                </div>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-primary" @click="triggerGitHubUpdate" :disabled="isUpdating">
                        <span v-if="!isUpdating">ğŸš€ å¼·åˆ¶æ›´æ–°å ±åƒ¹</span>
                        <span v-else class="spinner"></span>
                    </button>
                    <button class="btn btn-success" @click="refreshData">ğŸ”„ é‡æ–°è®€å–</button>
                    <button class="btn btn-danger" @click="logout">ç™»å‡º</button>
                </div>
            </div>

            <div class="grid-dashboard">
                <div class="card">
                    <div class="stat-label">ç¸½å¸‚å€¼ (TWD)</div>
                    <div class="stat-val" style="color:var(--primary)">${{ formatNumber(summary.total_value) }}</div>
                    <div class="stat-label">ç¾é‡‘åŒ¯ç‡: {{ exchangeRate }}</div>
                </div>
                <div class="card">
                    <div class="stat-label">æ·¨æŠ•å…¥æˆæœ¬ (TWD)</div>
                    <div class="stat-val">${{ formatNumber(summary.invested_capital) }}</div>
                </div>
                <div class="card">
                    <div class="stat-label">æœªå¯¦ç¾æç›Š (Unrealized)</div>
                    <div class="stat-val" :class="(summary.total_pnl >= 0 ? 'text-red' : 'text-green')">
                        {{ summary.total_pnl >= 0 ? '+' : '' }}{{ formatNumber(summary.total_pnl) }}
                    </div>
                    <div class="stat-label">å ±é…¬ç‡: {{ getReturnRate() }}%</div>
                </div>
                <div class="card">
                    <div class="stat-label">TWR (æ™‚é–“åŠ æ¬Šå ±é…¬)</div>
                    <div class="stat-val" :class="(summary.twr >= 0 ? 'text-red' : 'text-green')">
                        {{ summary.twr }}%
                    </div>
                    <div class="stat-label">å¤§ç›¤ (SPY): {{ summary.benchmark_twr }}%</div>
                </div>
            </div>

            <div class="chart-section">
                <div class="chart-container">
                    <div class="chart-controls">
                        <button class="chart-btn" :class="{active: timeRange==='1M'}" @click="switchTimeRange('1M')">1M</button>
                        <button class="chart-btn" :class="{active: timeRange==='6M'}" @click="switchTimeRange('6M')">6M</button>
                        <button class="chart-btn" :class="{active: timeRange==='YTD'}" @click="switchTimeRange('YTD')">YTD</button>
                        <button class="chart-btn" :class="{active: timeRange==='1Y'}" @click="switchTimeRange('1Y')">1Y</button>
                        <button class="chart-btn" :class="{active: timeRange==='ALL'}" @click="switchTimeRange('ALL')">ALL</button>
                        <span style="border-left:1px solid #444; margin:0 5px;"></span>
                        <button class="chart-btn" :class="{active: chartType==='value'}" @click="switchChartType('value')">å¸‚å€¼</button>
                        <button class="chart-btn" :class="{active: chartType==='twr'}" @click="switchChartType('twr')">å ±é…¬ç‡</button>
                    </div>
                    <div style="flex:1; position:relative; min-height:0;">
                        <canvas id="mainChart"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <div class="chart-controls">
                        <button class="chart-btn" :class="{active: pieType==='tags'}" @click="switchPieType('tags')">æ¨™ç±¤</button>
                        <button class="chart-btn" :class="{active: pieType==='currency'}" @click="switchPieType('currency')">å¹£åˆ¥</button>
                    </div>
                    <div style="flex:1; position:relative; min-height:0; display:flex; justify-content:center;">
                        <canvas id="pieChart"></canvas>
                    </div>
                </div>
            </div>
            
            <div class="card" style="margin-bottom:20px;">
                <h3 style="margin-top:0; margin-bottom:15px;">ğŸ’¼ ç•¶å‰æŒå€‰ (Holdings)</h3>
                <div style="overflow-x:auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>ä»£ç¢¼</th>
                                <th>æ¨™ç±¤</th>
                                <th>æŒæœ‰è‚¡æ•¸</th>
                                <th>ç¸½æˆæœ¬ (TWD)</th>
                                <th>ç¾å€¼ (TWD)</th>
                                <th>æç›Š (TWD)</th>
                                <th>å ±é…¬ç‡</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="h in holdings" :key="h.symbol">
                                <td style="font-weight:bold;">{{ h.symbol }} <span class="badge">{{ h.currency }}</span></td>
                                <td><span class="badge">{{ h.tag }}</span></td>
                                <td>{{ formatNumber(h.qty) }}</td>
                                <td>{{ formatNumber(h.total_cost_twd) }}</td>
                                <td style="font-weight:bold;">{{ formatNumber(h.market_value_twd) }}</td>
                                <td :class="h.pnl_twd >= 0 ? 'text-red' : 'text-green'">
                                    {{ h.pnl_twd >= 0 ? '+' : '' }}{{ formatNumber(h.pnl_twd) }}
                                </td>
                                <td :class="h.pnl_percent >= 0 ? 'text-red' : 'text-green'">
                                    {{ h.pnl_percent }}%
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card" style="margin-bottom:20px;">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <h3 style="margin:0; color:var(--primary);">{{ isEditing ? 'âœï¸ ä¿®æ”¹äº¤æ˜“' : 'â• æ–°å¢äº¤æ˜“' }}</h3>
                    <button v-if="isEditing" class="btn btn-sm btn-danger" @click="resetForm">å–æ¶ˆç·¨è¼¯</button>
                </div>
                <div class="editor-panel">
                    <div><label style="display:block;color:#888;font-size:0.8rem">æ—¥æœŸ</label><input type="date" v-model="form.txn_date"></div>
                    <div><label style="display:block;color:#888;font-size:0.8rem">ä»£ç¢¼</label><input type="text" v-model="form.symbol" placeholder="AAPL" @input="form.symbol = form.symbol.toUpperCase()"></div>
                    <div>
                        <label style="display:block;color:#888;font-size:0.8rem">é¡åˆ¥</label>
                        <select v-model="form.txn_type">
                            <option value="BUY">è²·å…¥</option>
                            <option value="SELL">è³£å‡º</option>
                            <option value="DIV">é…æ¯</option>
                        </select>
                    </div>
                    <div><label style="display:block;color:#888;font-size:0.8rem">è‚¡æ•¸</label><input type="number" v-model="form.qty" step="0.01"></div>
                    <div><label style="display:block;color:#888;font-size:0.8rem">åƒ¹æ ¼</label><input type="number" v-model="form.price" step="0.01"></div>
                    <div><label style="display:block;color:#888;font-size:0.8rem">æ¨™ç±¤</label><input type="text" v-model="form.tag" placeholder="å¦‚: é•·ç·š"></div>
                    <div style="display:flex; align-items:flex-end;">
                        <button class="btn btn-primary" style="width:100%;" @click="submitRecord" :disabled="loading">
                            {{ isEditing ? 'ä¿å­˜' : 'æ–°å¢' }}
                        </button>
                    </div>
                </div>
            </div>

            <div class="card">
                <h3 style="margin-top:0; margin-bottom:15px;">ğŸ“ æ­·å²äº¤æ˜“æ˜ç´°</h3>
                <div class="ledger-controls">
                    <input type="text" v-model="searchQuery" placeholder="æœå°‹ä»£ç¢¼..." style="width:150px; padding:6px; border-radius:4px; border:1px solid #444; background:#333; color:white;">
                    <select v-model="filterType" style="width:100px; padding:6px; border-radius:4px; border:1px solid #444; background:#333; color:white;">
                        <option value="ALL">å…¨éƒ¨é¡åˆ¥</option>
                        <option value="BUY">è²·å…¥</option>
                        <option value="SELL">è³£å‡º</option>
                        <option value="DIV">é…æ¯</option>
                    </select>
                </div>

                <div style="overflow-x:auto;">
                    <table>
                        <thead>
                            <tr><th>æ—¥æœŸ</th><th>ä»£ç¢¼</th><th>å‹•ä½œ</th><th>åƒ¹æ ¼</th><th>è‚¡æ•¸</th><th>æ¨™ç±¤</th><th>æ“ä½œ</th></tr>
                        </thead>
                        <tbody>
                            <tr v-for="tx in paginatedLedger" :key="tx.id">
                                <td style="color:#888;">{{ tx.txn_date }}</td>
                                <td style="font-weight:bold;">{{ tx.symbol }}</td>
                                <td>
                                    <span :style="{color: tx.txn_type==='BUY'?'#69f0ae':(tx.txn_type==='SELL'?'#ff5252':'#ffd700'), fontWeight:'bold'}">
                                        {{ tx.txn_type }}
                                    </span>
                                </td>
                                <td>{{ tx.price }}</td>
                                <td>{{ tx.qty }}</td>
                                <td><span class="badge">{{ tx.tag || 'Stock' }}</span></td>
                                <td>
                                    <button class="btn-sm btn-primary" @click="editRecord(tx)">âœ</button>
                                    <button class="btn-sm btn-danger" @click="deleteRecord(tx.id)" style="margin-left:5px;">Ã—</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div class="pagination" v-if="totalPages > 1">
                    <button class="btn btn-sm" :disabled="currentPage===1" @click="currentPage--">ä¸Šä¸€é </button>
                    <span style="color:#888;">ç¬¬ {{ currentPage }} / {{ totalPages }} é </span>
                    <button class="btn btn-sm" :disabled="currentPage===totalPages" @click="currentPage++">ä¸‹ä¸€é </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, nextTick, watch } = Vue;
        
        const DB_API_URL = "https://journal-backend.chired.workers.dev";
        const CLIENT_ID = "951186116587-0ehsmkvlu3uivduc7kjn1jpp9ga7810i.apps.googleusercontent.com";

        createApp({
            setup() {
                // --- ç‹€æ…‹ ---
                const userToken = ref(localStorage.getItem('token') || '');
                const userName = ref(localStorage.getItem('name') || '');
                const summary = ref({ total_value: 0, invested_capital: 0, total_pnl: 0, twr: 0, benchmark_twr: 0 });
                const holdings = ref([]);
                const fullHistory = ref([]);
                const allocation = ref({ tags: {}, currency: {} });
                const records = ref([]);
                const exchangeRate = ref(32.0);
                const lastUpdateTime = ref('');
                
                // --- UI ---
                const loading = ref(false);
                const isUpdating = ref(false);
                const isEditing = ref(false);
                const form = ref({ id: null, txn_date: new Date().toISOString().split('T')[0], symbol: '', txn_type: 'BUY', qty: '', price: '', fee: 0, tag: 'Stock' });
                
                // --- åˆ—è¡¨éæ¿¾ ---
                const searchQuery = ref('');
                const filterType = ref('ALL');
                const currentPage = ref(1);
                const pageSize = 10;

                // --- åœ–è¡¨ ---
                const timeRange = ref('ALL');
                const chartType = ref('value');
                const pieType = ref('tags');
                let myChart = null;
                let myPieChart = null;

                // --- è³‡æ–™è®€å– ---
                const loadData = async () => {
                    // 1. è®€å–åˆ†ææ•¸æ“š
                    try {
                        const res = await fetch(`data.json?t=${new Date().getTime()}`);
                        if(res.ok) {
                            const json = await res.json();
                            summary.value = json.summary || {};
                            holdings.value = json.holdings || [];
                            fullHistory.value = json.history || [];
                            allocation.value = json.allocation || {};
                            exchangeRate.value = json.exchange_rate || 32.0;
                            lastUpdateTime.value = json.updated_at || '';
                            updateChart();
                            updatePieChart();
                        }
                    } catch(e) { console.error(e); }

                    // 2. è®€å–äº¤æ˜“ç´€éŒ„ (è‹¥æœ‰ç™»å…¥)
                    if (userToken.value) {
                        try {
                            const res = await fetch(`${DB_API_URL}/api/records`, { headers: { "Authorization": `Bearer ${userToken.value}` } });
                            const json = await res.json();
                            if (json.success) records.value = json.data;
                        } catch(e) { console.error(e); }
                    }
                };

                // --- åœ–è¡¨é‚è¼¯ ---
                const filterHistory = () => {
                    if (!fullHistory.value.length) return [];
                    const now = new Date();
                    let startDate = new Date(fullHistory.value[0].date);
                    
                    if (timeRange.value === '1M') startDate = new Date(now.setMonth(now.getMonth() - 1));
                    else if (timeRange.value === '6M') startDate = new Date(now.setMonth(now.getMonth() - 6));
                    else if (timeRange.value === 'YTD') startDate = new Date(now.getFullYear(), 0, 1);
                    else if (timeRange.value === '1Y') startDate = new Date(now.setFullYear(now.getFullYear() - 1));
                    
                    return fullHistory.value.filter(d => new Date(d.date) >= startDate);
                };

                const updateChart = () => {
                    const ctx = document.getElementById('mainChart');
                    if (!ctx) return;
                    if (myChart) myChart.destroy();
                    
                    const data = filterHistory();
                    const labels = data.map(d => d.date);
                    let datasets = [];

                    if (chartType.value === 'value') {
                        datasets = [
                            { label: 'å¸‚å€¼ (TWD)', data: data.map(d => d.total_value), borderColor: '#40a9ff', borderWidth: 2, tension: 0.1, pointRadius:0, fill: true, backgroundColor: 'rgba(64, 169, 255, 0.1)' },
                            { label: 'æˆæœ¬ (TWD)', data: data.map(d => d.invested), borderColor: '#666', borderDash: [5, 5], borderWidth: 1, pointRadius:0 }
                        ];
                    } else {
                        datasets = [
                            { label: 'å ±é…¬ç‡ %', data: data.map(d => d.twr), borderColor: '#ffc107', borderWidth: 2, pointRadius:0 },
                            { label: 'å¤§ç›¤ (SPY) %', data: data.map(d => d.benchmark_twr), borderColor: '#444', borderWidth: 1, pointRadius:0 }
                        ];
                    }

                    myChart = new Chart(ctx, {
                        type: 'line',
                        data: { labels, datasets },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: { mode: 'index', intersect: false },
                            plugins: { legend: { labels: { color: '#ccc' } } },
                            scales: {
                                x: { ticks: { color: '#666', maxTicksLimit: 6 }, grid: { color: '#2d2d30' } },
                                y: { ticks: { color: '#666' }, grid: { color: '#2d2d30' } }
                            }
                        }
                    });
                };

                const updatePieChart = () => {
                    const ctx = document.getElementById('pieChart');
                    if (!ctx) return;
                    if (myPieChart) myPieChart.destroy();
                    
                    const source = allocation.value[pieType.value] || {};
                    const labels = Object.keys(source);
                    const data = Object.values(source);
                    const colors = ['#40a9ff', '#ffc107', '#4caf50', '#ff5252', '#9c27b0', '#00bcd4'];

                    myPieChart = new Chart(ctx, {
                        type: 'doughnut',
                        data: { labels, datasets: [{ data, backgroundColor: colors, borderWidth: 0 }] },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: { legend: { position: 'right', labels: { color: '#ccc' } } }
                        }
                    });
                };
                
                const switchTimeRange = (r) => { timeRange.value = r; updateChart(); };
                const switchChartType = (t) => { chartType.value = t; updateChart(); };
                const switchPieType = (t) => { pieType.value = t; updatePieChart(); };

                // --- åˆ—è¡¨é‚è¼¯ ---
                const filteredLedger = computed(() => {
                    let res = records.value;
                    if (searchQuery.value) res = res.filter(r => r.symbol.includes(searchQuery.value.toUpperCase()));
                    if (filterType.value !== 'ALL') res = res.filter(r => r.txn_type === filterType.value);
                    return res.sort((a,b) => new Date(b.txn_date) - new Date(a.txn_date));
                });
                const paginatedLedger = computed(() => {
                    const start = (currentPage.value - 1) * pageSize;
                    return filteredLedger.value.slice(start, start + pageSize);
                });
                const totalPages = computed(() => Math.ceil(filteredLedger.value.length / pageSize));

                // --- Actions ---
                const submitRecord = async () => {
                    loading.value = true;
                    try {
                        const method = isEditing.value ? "PUT" : "POST";
                        const res = await fetch(`${DB_API_URL}/api/records`, {
                            method,
                            headers: { "Content-Type": "application/json", "Authorization": `Bearer ${userToken.value}` },
                            body: JSON.stringify(form.value)
                        });
                        if (res.ok) { resetForm(); loadData(); }
                    } catch(e) { alert("å¤±æ•—"); }
                    loading.value = false;
                };

                const deleteRecord = async (id) => {
                    if(!confirm("ç¢ºå®šåˆªé™¤?")) return;
                    await fetch(`${DB_API_URL}/api/records`, {
                        method: "DELETE",
                        headers: { "Content-Type": "application/json", "Authorization": `Bearer ${userToken.value}` },
                        body: JSON.stringify({ id })
                    });
                    loadData();
                };
                
                const triggerGitHubUpdate = async () => {
                    if(!confirm("ç¢ºå®šè¦å¼·åˆ¶æ›´æ–°å ±åƒ¹å—ï¼Ÿ")) return;
                    isUpdating.value = true;
                    await fetch(`${DB_API_URL}/api/trigger-update`, {
                        method: 'POST',
                        headers: { "Content-Type": "application/json", "Authorization": `Bearer ${userToken.value}` }
                    });
                    alert("å·²è§¸ç™¼æ›´æ–°ï¼Œè«‹ç¨å€™ã€‚");
                    isUpdating.value = false;
                };

                // --- Utils ---
                const editRecord = (tx) => { isEditing.value = true; form.value = { ...tx }; };
                const resetForm = () => { isEditing.value = false; form.value = { id: null, txn_date: new Date().toISOString().split('T')[0], symbol: '', txn_type: 'BUY', qty: '', price: '', fee: 0, tag: 'Stock' }; };
                const formatNumber = (n) => n ? Number(n).toLocaleString(undefined, { maximumFractionDigits: 0 }) : '0';
                const getReturnRate = () => summary.value.invested_capital ? ((summary.value.total_pnl / summary.value.invested_capital) * 100).toFixed(2) : 0;
                
                const logout = () => { localStorage.clear(); userToken.value = ''; };
                window.handleCredentialResponse = async (response) => {
                    try {
                        const res = await fetch(`${DB_API_URL}/auth/google`, { method: "POST", body: JSON.stringify({ id_token: response.credential }) });
                        const data = await res.json();
                        if (data.success) {
                            userToken.value = data.token;
                            userName.value = data.user;
                            localStorage.setItem('token', data.token);
                            localStorage.setItem('name', data.user);
                            loadData();
                        }
                    } catch(e) { alert("ç™»å…¥å¤±æ•—"); }
                };

                onMounted(() => {
                    loadData();
                });

                return {
                    userToken, userName, googleClientId: CLIENT_ID, logout,
                    summary, holdings, exchangeRate, lastUpdateTime,
                    loading, isUpdating, isEditing, form,
                    submitRecord, deleteRecord, editRecord, resetForm, triggerGitHubUpdate, refreshData: loadData,
                    paginatedLedger, searchQuery, filterType, currentPage, totalPages,
                    timeRange, chartType, pieType, switchTimeRange, switchChartType, switchPieType,
                    formatNumber, getReturnRate
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
