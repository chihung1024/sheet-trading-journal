<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SaaS äº¤æ˜“ç®¡ç†ç³»çµ±</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        :root { --bg: #101014; --card-bg: #18181c; --border: #2d2d30; --primary: #40a9ff; --text: #e0e0e0; --green: #4caf50; --red: #ff5252; }
        body { background-color: var(--bg); color: var(--text); font-family: sans-serif; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        
        /* ç™»å…¥é®ç½© */
        .login-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 1000; flex-direction: column; }
        .login-box { background: var(--card-bg); padding: 40px; border-radius: 12px; border: 1px solid var(--border); text-align: center; }

        /* ç‰ˆé¢ */
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 15px; }
        .btn { padding: 8px 16px; border-radius: 6px; cursor: pointer; border: none; font-weight: bold; transition: 0.2s; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-danger { background: rgba(255, 82, 82, 0.1); color: var(--red); border: 1px solid var(--red); }
        .btn-icon { background: transparent; color: var(--primary); padding: 4px; }

        /* å¡ç‰‡èˆ‡è¡¨æ ¼ */
        .card { background: var(--card-bg); border: 1px solid var(--border); border-radius: 12px; padding: 20px; margin-bottom: 20px; }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .stat-item { background: #222; padding: 15px; border-radius: 8px; }
        .stat-label { color: #888; font-size: 0.9rem; margin-bottom: 5px; }
        .stat-val { font-size: 1.4rem; font-weight: bold; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.95rem; }
        th { text-align: left; color: #888; border-bottom: 1px solid var(--border); padding: 10px; }
        td { padding: 10px; border-bottom: 1px solid #222; }
        .red { color: var(--red); } .green { color: var(--green); }

        /* ç·¨è¼¯è¡¨å–® */
        .editor-form { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; align-items: end; background: #1f1f23; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid var(--primary); }
        input, select { background: #2d2d30; border: 1px solid #444; color: white; padding: 8px; border-radius: 4px; width: 100%; box-sizing: border-box; }
        label { font-size: 0.8rem; color: #aaa; display: block; margin-bottom: 4px; }
    </style>
</head>
<body>
    <div id="app" class="container">
        <div v-if="!userToken" class="login-overlay">
            <div class="login-box">
                <h2>æ­¡è¿ä½¿ç”¨äº¤æ˜“ç®¡ç†ç³»çµ±</h2>
                <p style="color:#888; margin-bottom:20px;">è«‹ç™»å…¥ä»¥å­˜å–æ‚¨çš„ç§äººæŠ•è³‡çµ„åˆ</p>
                <div id="g_id_onload" :data-client_id="googleClientId" data-callback="handleCredentialResponse" data-auto_select="false"></div>
                <div class="g_id_signin" data-type="standard" data-shape="pill" data-size="large"></div>
            </div>
        </div>

        <div v-else>
            <div class="header">
                <div>
                    <h2 style="margin:0">æŠ•è³‡çµ„åˆçœ‹æ¿</h2>
                    <span style="color:#888; font-size:0.9rem">ğŸ‘¤ {{ userName }} (å³æ™‚è³‡æ–™æ¨¡å¼)</span>
                </div>
                <button class="btn btn-danger" @click="logout">ç™»å‡º</button>
            </div>

            <div class="stats-grid" style="margin-bottom: 20px;">
                <div class="stat-item">
                    <div class="stat-label">ç¸½æŠ•å…¥æˆæœ¬ (Cost)</div>
                    <div class="stat-val">${{ formatNumber(portfolioStats.totalCost) }}</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">å·²å¯¦ç¾æç›Š (Realized PnL)</div>
                    <div class="stat-val" :class="portfolioStats.realizedPnL >= 0 ? 'red' : 'green'">
                        {{ portfolioStats.realizedPnL >= 0 ? '+' : '' }}{{ formatNumber(portfolioStats.realizedPnL) }}
                    </div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">ç›®å‰æŒå€‰ç¸½æ•¸</div>
                    <div class="stat-val">{{ portfolioStats.holdingsCount }} æª”</div>
                </div>
            </div>

            <div class="card">
                <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                    <h3 style="margin:0; color:var(--primary)">âœï¸ {{ isEditing ? 'ä¿®æ”¹äº¤æ˜“' : 'æ–°å¢äº¤æ˜“' }}</h3>
                    <button v-if="isEditing" @click="resetForm" style="background:none; border:none; color:#888; cursor:pointer;">å–æ¶ˆä¿®æ”¹</button>
                </div>
                
                <div class="editor-form">
                    <div><label>æ—¥æœŸ</label><input type="date" v-model="form.txn_date"></div>
                    <div><label>ä»£ç¢¼ (Symbol)</label><input type="text" v-model="form.symbol" placeholder="e.g. 2330"></div>
                    <div>
                        <label>é¡åˆ¥</label>
                        <select v-model="form.txn_type">
                            <option value="BUY">è²·å…¥ (Buy)</option>
                            <option value="SELL">è³£å‡º (Sell)</option>
                            <option value="DIV">é…æ¯ (Div)</option>
                        </select>
                    </div>
                    <div><label>è‚¡æ•¸</label><input type="number" v-model="form.qty" placeholder="0"></div>
                    <div><label>åƒ¹æ ¼</label><input type="number" v-model="form.price" placeholder="0.00"></div>
                    <div><label>è²»ç”¨</label><input type="number" v-model="form.fee" placeholder="0"></div>
                    <div>
                        <label>&nbsp;</label>
                        <button class="btn btn-primary" style="width:100%" @click="submitRecord" :disabled="loading">
                            {{ loading ? 'è™•ç†ä¸­...' : (isEditing ? 'ç¢ºèªä¿®æ”¹' : 'æ–°å¢') }}
                        </button>
                    </div>
                </div>
            </div>

            <div style="display:flex; gap:20px; flex-wrap:wrap;">
                <div class="card" style="flex:1; min-width:300px;">
                    <h3>ğŸ“Š ç›®å‰æŒå€‰ (Holdings)</h3>
                    <div style="overflow-x:auto;">
                        <table>
                            <thead><tr><th>ä»£ç¢¼</th><th>è‚¡æ•¸</th><th>å¹³å‡æˆæœ¬</th><th>ä¼°è¨ˆå¸‚å€¼(ä»¥æˆæœ¬è¨ˆ)</th></tr></thead>
                            <tbody>
                                <tr v-for="h in holdings" :key="h.symbol">
                                    <td style="font-weight:bold; color:white;">{{ h.symbol }}</td>
                                    <td>{{ h.qty }}</td>
                                    <td>{{ formatNumber(h.avgCost) }}</td>
                                    <td>{{ formatNumber(h.qty * h.avgCost) }}</td>
                                </tr>
                                <tr v-if="holdings.length === 0"><td colspan="4" style="text-align:center; color:#666;">ç„¡æŒå€‰</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="card" style="flex:1; min-width:300px;">
                    <h3>ğŸ“ äº¤æ˜“æµæ°´å¸³ (Ledger)</h3>
                    <div style="overflow-x:auto; max-height:400px;">
                        <table>
                            <thead><tr><th>æ—¥æœŸ</th><th>ä»£ç¢¼</th><th>é¡åˆ¥</th><th>è‚¡æ•¸</th><th>åƒ¹æ ¼</th><th>æ“ä½œ</th></tr></thead>
                            <tbody>
                                <tr v-for="tx in records" :key="tx.id">
                                    <td style="color:#aaa; font-size:0.85rem;">{{ tx.txn_date }}</td>
                                    <td style="font-weight:bold;">{{ tx.symbol }}</td>
                                    <td>
                                        <span :style="{color: tx.txn_type==='BUY'?'#69f0ae':(tx.txn_type==='SELL'?'#ff5252':'#ffd700')}">
                                            {{ tx.txn_type }}
                                        </span>
                                    </td>
                                    <td>{{ tx.qty }}</td>
                                    <td>{{ tx.price }}</td>
                                    <td>
                                        <button class="btn-icon" @click="editRecord(tx)">âœ</button>
                                        <button class="btn-icon" style="color:var(--red)" @click="deleteRecord(tx.id)">âœ•</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted } = Vue;
        
        // âš ï¸ è«‹ä¿®æ”¹æˆæ‚¨çš„ Worker ç¶²å€
        const WORKER_URL = "https://journal-backend.chired.workers.dev";
        const CLIENT_ID = "951186116587-0ehsmkvlu3uivduc7kjn1jpp9ga7810i.apps.googleusercontent.com";

        createApp({
            setup() {
                const userToken = ref(localStorage.getItem('token') || '');
                const userName = ref(localStorage.getItem('name') || '');
                const records = ref([]);
                const loading = ref(false);
                const isEditing = ref(false);
                const form = ref({ id: null, txn_date: new Date().toISOString().split('T')[0], symbol: '', txn_type: 'BUY', qty: '', price: '', fee: 0 });

                // --- 1. æ ¸å¿ƒé‹ç®—é‚è¼¯ (Client-side Calculation) ---
                // é€™å€‹å‡½å¼å–ä»£äº† Pythonï¼Œç›´æ¥åœ¨ç€è¦½å™¨ç®—å‡ºæŒå€‰
                const holdings = computed(() => {
                    const map = {};
                    // ä¾ç…§æ—¥æœŸæ’åº (èˆŠ->æ–°) ä»¥æ­£ç¢ºè¨ˆç®—å¹³å‡æˆæœ¬
                    const sorted = [...records.value].sort((a,b) => new Date(a.txn_date) - new Date(b.txn_date));
                    
                    sorted.forEach(tx => {
                        const sym = tx.symbol;
                        if (!map[sym]) map[sym] = { symbol: sym, qty: 0, totalCost: 0, avgCost: 0 };
                        
                        const qty = parseFloat(tx.qty);
                        const price = parseFloat(tx.price);
                        const fee = parseFloat(tx.fee) || 0;

                        if (tx.txn_type === 'BUY') {
                            map[sym].totalCost += (qty * price) + fee; // è²·å…¥å¢åŠ æˆæœ¬
                            map[sym].qty += qty;
                        } else if (tx.txn_type === 'SELL') {
                            // è³£å‡ºä¾æ¯”ä¾‹æ¸›å°‘æˆæœ¬
                            const costPerShare = map[sym].qty > 0 ? map[sym].totalCost / map[sym].qty : 0;
                            map[sym].totalCost -= (costPerShare * qty); 
                            map[sym].qty -= qty;
                        }
                        // é‡æ–°è¨ˆç®—å‡åƒ¹
                        map[sym].avgCost = map[sym].qty > 0 ? map[sym].totalCost / map[sym].qty : 0;
                    });

                    // éæ¿¾æ‰å·²æ¸…å€‰çš„è‚¡ç¥¨
                    return Object.values(map).filter(h => h.qty > 0.001);
                });

                const portfolioStats = computed(() => {
                    let totalCost = 0;
                    let realizedPnL = 0; // ç°¡å–®ä¼°ç®—
                    
                    records.value.forEach(tx => {
                        const amt = parseFloat(tx.price) * parseFloat(tx.qty);
                        if(tx.txn_type === 'BUY') totalCost += amt;
                        // é€™è£¡å¯ä»¥åŠ å…¥æ›´è¤‡é›œçš„å·²å¯¦ç¾æç›Šç®—æ³•
                        if(tx.txn_type === 'SELL') realizedPnL += (amt - parseFloat(tx.fee || 0)); // é€™æ˜¯æ”¶å…¥ï¼Œæœªæ‰£æˆæœ¬
                    });
                    
                    // ä¿®æ­£ï¼šçœŸæ­£çš„å·²å¯¦ç¾æç›Šéœ€è¦ FIFO æ¼”ç®—æ³•ï¼Œé€™è£¡æš«æ™‚é¡¯ç¤ºç¸½æŠ•å…¥èˆ‡ç¸½è³£å‡ºé‡‘é¡ä¾›åƒè€ƒ
                    // è‹¥è¦å®Œæ•´è¤‡è£½ Python é‚è¼¯ï¼Œå¯å°‡ FIFO é‚è¼¯æ¬éä¾†
                    return { 
                        totalCost: holdings.value.reduce((sum, h) => sum + h.totalCost, 0),
                        realizedPnL: 0, // æš«æ™‚ä¿ç•™ï¼Œéœ€å¯¦ä½œ JS ç‰ˆ FIFO
                        holdingsCount: holdings.value.length 
                    };
                });

                // --- 2. API äº’å‹• ---
                const fetchRecords = async () => {
                    if (!userToken.value) return;
                    const res = await fetch(`${WORKER_URL}/api/records`, {
                        headers: { "Authorization": `Bearer ${userToken.value}` }
                    });
                    const json = await res.json();
                    if (json.success) records.value = json.data;
                };

                const submitRecord = async () => {
                    loading.value = true;
                    const method = isEditing.value ? "PUT" : "POST";
                    const payload = { ...form.value };
                    
                    try {
                        const res = await fetch(`${WORKER_URL}/api/records`, {
                            method,
                            headers: { 
                                "Content-Type": "application/json",
                                "Authorization": `Bearer ${userToken.value}`
                            },
                            body: JSON.stringify(payload)
                        });
                        if(res.ok) {
                            resetForm();
                            await fetchRecords(); // ç«‹å³é‡æ–°æŠ“å–ä¸¦é‹ç®—
                        } else {
                            alert("å„²å­˜å¤±æ•—");
                        }
                    } catch(e) { alert("é€£ç·šéŒ¯èª¤"); }
                    loading.value = false;
                };

                const deleteRecord = async (id) => {
                    if(!confirm("ç¢ºå®šåˆªé™¤?")) return;
                    await fetch(`${WORKER_URL}/api/records`, {
                        method: "DELETE",
                        headers: { "Content-Type": "application/json", "Authorization": `Bearer ${userToken.value}` },
                        body: JSON.stringify({ id })
                    });
                    fetchRecords();
                };

                // --- 3. å·¥å…·å‡½å¼ ---
                const editRecord = (tx) => {
                    isEditing.value = true;
                    form.value = { ...tx };
                };
                
                const resetForm = () => {
                    isEditing.value = false;
                    form.value = { id: null, txn_date: new Date().toISOString().split('T')[0], symbol: '', txn_type: 'BUY', qty: '', price: '', fee: 0 };
                };

                const formatNumber = (num) => {
                    return num ? Number(num).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 2 }) : '0';
                };

                const logout = () => {
                    localStorage.clear();
                    userToken.value = '';
                    records.value = [];
                };

                // Google ç™»å…¥å›èª¿
                window.handleCredentialResponse = async (response) => {
                    try {
                        const res = await fetch(`${WORKER_URL}/auth/google`, {
                            method: "POST",
                            body: JSON.stringify({ id_token: response.credential })
                        });
                        const data = await res.json();
                        if (data.success) {
                            userToken.value = data.token;
                            userName.value = data.user;
                            localStorage.setItem('token', data.token);
                            localStorage.setItem('name', data.user);
                            fetchRecords();
                        }
                    } catch(e) { alert("ç™»å…¥å¤±æ•—"); }
                };

                onMounted(() => {
                    if (userToken.value) fetchRecords();
                });

                return {
                    userToken, userName, googleClientId: CLIENT_ID, logout,
                    records, form, loading, isEditing,
                    submitRecord, deleteRecord, editRecord, resetForm,
                    holdings, portfolioStats, formatNumber
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
