"""\n系統監控模組 - 追蹤執行成功率與健康度\nSystem Monitoring Module - Track execution success rate and health\n"""\nimport json\nfrom datetime import datetime, timedelta\nfrom pathlib import Path\nfrom typing import Dict, List, Optional\n\n\nclass HealthMonitor:\n    """\n    系統健康度監控器\n    \n    功能：\n    1. 記錄每次執行的成功/失敗狀態\n    2. 計算 24 小時內的成功率\n    3. 生成健康度報告\n    """\n    \n    def __init__(self, log_file: str = '.health.json'):\n        """\n        初始化監控器\n        \n        Args:\n            log_file: 健康記錄檔案路徑\n        """\n        self.log_file = Path(log_file)\n        self.history: List[Dict] = []\n        self.load_history()\n    \n    def load_history(self):\n        """載入歷史記錄"""\n        if self.log_file.exists():\n            try:\n                with open(self.log_file, 'r', encoding='utf-8') as f:\n                    self.history = json.load(f)\n            except Exception as e:\n                print(f"\u26a0\ufe0f 無法載入健康記錄: {e}")\n                self.history = []\n        else:\n            self.history = []\n    \n    def record(self, success: bool, mode: str, errors: Optional[List[str]] = None):\n        """\n        記錄本次執行狀態\n        \n        Args:\n            success: 是否成功\n            mode: 執行模式 ('intraday', 'historical', 'empty', 等)\n            errors: 錯誤訊息列表\n        """\n        entry = {\n            'timestamp': datetime.now().isoformat(),\n            'success': success,\n            'mode': mode,\n            'errors': errors or []\n        }\n        \n        self.history.append(entry)\n        \n        # 只保留最近 100 筆\n        self.history = self.history[-100:]\n        \n        # 寫入檔案\n        try:\n            with open(self.log_file, 'w', encoding='utf-8') as f:\n                json.dump(self.history, f, indent=2, ensure_ascii=False)\n        except Exception as e:\n            print(f"\u26a0\ufe0f 無法寫入健康記錄: {e}")\n    \n    def get_health_score(self) -> Dict:\n        """\n        計算系統健康度分數\n        \n        Returns:\n            dict: 包含 score, status, total_runs, failures 等資訊\n        """\n        if not self.history:\n            return {\n                'score': 100,\n                'status': 'unknown',\n                'message': '無歷史資料'\n            }\n        \n        # 最近 24 小時的記錄\n        cutoff = datetime.now() - timedelta(hours=24)\n        recent = [\n            h for h in self.history \n            if datetime.fromisoformat(h['timestamp']) > cutoff\n        ]\n        \n        if not recent:\n            return {\n                'score': 100,\n                'status': 'no_recent_data',\n                'message': '24小時內無執行記錄'\n            }\n        \n        # 計算成功率\n        success_count = sum(1 for r in recent if r['success'])\n        success_rate = success_count / len(recent)\n        score = int(success_rate * 100)\n        \n        # 判斷狀態\n        if score >= 95:\n            status = 'excellent'\n        elif score >= 90:\n            status = 'healthy'\n        elif score >= 70:\n            status = 'degraded'\n        else:\n            status = 'critical'\n        \n        return {\n            'score': score,\n            'status': status,\n            'total_runs': len(recent),\n            'failures': len(recent) - success_count,\n            'success_rate': f'{success_rate:.1%}'\n        }\n    \n    def get_recent_failures(self, hours: int = 24) -> List[Dict]:\n        """\n        獲取最近的失敗記錄\n        \n        Args:\n            hours: 時間範圍（小時）\n        \n        Returns:\n            list: 失敗記錄列表\n        """\n        cutoff = datetime.now() - timedelta(hours=hours)\n        failures = [\n            h for h in self.history \n            if datetime.fromisoformat(h['timestamp']) > cutoff and not h['success']\n        ]\n        return failures\n