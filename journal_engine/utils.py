"""\n工具模組 - 市場時段判斷與輔助函式\nUtility Module - Market timing and helper functions\n"""\nimport pytz\nimport pandas_market_calendars as mcal\nfrom datetime import datetime\n\n\ndef is_us_market_open():\n    """\n    判斷美股是否在交易時段（含假期檢查）\n    \n    使用 NYSE 日曆精確判斷：\n    - 週末自動轉False\n    - 美國國定假日自動轉False\n    - 檢查是否在 09:30-16:00 ET 交易時段\n    \n    Returns:\n        bool: True 表示當前為交易時段\n    """\n    try:\n        # 使用 NYSE 日曆\n        nyse = mcal.get_calendar('NYSE')\n        now = datetime.now(pytz.timezone('US/Eastern'))\n        \n        # 獲取當日交易時段\n        schedule = nyse.schedule(start_date=now.date(), end_date=now.date())\n        \n        if schedule.empty:\n            # 今天非交易日（週末或假期）\n            return False\n        \n        # 檢查是否在交易時間內\n        market_open = schedule.iloc[0]['market_open'].tz_convert('US/Eastern')\n        market_close = schedule.iloc[0]['market_close'].tz_convert('US/Eastern')\n        \n        return market_open <= now <= market_close\n        \n    except Exception as e:\n        # 降級到簡單判斷：台灣時間 21:30-05:00\n        print(f"\u26a0\ufe0f 無法使用 NYSE 日曆\uff0c降級到時區判斷: {e}")\n        taipei_now = datetime.now(pytz.timezone('Asia/Taipei'))\n        hour = taipei_now.hour\n        weekday = taipei_now.weekday()\n        \n        # 週一到週五，台灣時間 21:30-05:00\n        if weekday >= 5:  # 週六日\n            return False\n        \n        return hour >= 22 or hour < 5\n\n\ndef _simple_time_check():\n    """\n    簡單的時區判斷（備用方案）\n    當 pandas-market-calendars 不可用時使用\n    """\n    taipei_now = datetime.now(pytz.timezone('Asia/Taipei'))\n    hour = taipei_now.hour\n    weekday = taipei_now.weekday()\n    \n    if weekday >= 5:\n        return False\n    \n    return hour >= 22 or hour < 5\n